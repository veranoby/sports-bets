{
  "session_metadata": {
    "model": "claude-sonnet-4-5",
    "assigned_role": "director_and_implementer",
    "session_date": "2025-11-10",
    "session_type": "production_validation_and_fixes",
    "execution_mode": "standard",
    "deadline": "2 days to production",
    "estimated_duration": "8 hours (Day 1)"
  },

  "CRITICAL_CONTEXT": {
    "situation": "Platform launches to production in 2 DAYS. Most code EXISTS (streaming, admin, events) but QWEN's E2E tests showed 0/17 passing. User has NOT tested manually yet.",
    "reality_check": "We don't know what actually works vs what's broken. Runtime errors exist. Need manual validation FIRST, then fix what's actually broken.",
    "strategic_decision": "Focus ONLY on P0: EVENTOS EN VIVO + ADMIN workflows. Wallet/betting OUT OF SCOPE (hide UI completely)."
  },

  "SCOPE_P0_MUST_HAVE": {
    "eventos_en_vivo_usuario": [
      "Ver lista de eventos activos (/eventos)",
      "Ver detalle evento con peleas (/eventos/:id)",
      "Streaming HLS en vivo (video player funciona)",
      "Updates tiempo real SSE (fight status changes visible sin refresh)",
      "Login requerido siempre (redirect si no autenticado)"
    ],
    "admin_dashboard": [
      "CRUD Usuarios (crear/editar/eliminar desde /admin/users)",
      "Solicitudes membresía (aprobar/rechazar desde /admin/membership-requests)",
      "Suscripciones (gestionar desde /admin/subscriptions)",
      "CRUD Venues y Galleras (desde /admin/venues y /admin/galleras)",
      "Crear evento (/admin/events → botón Create Event)",
      "Agregar peleas a evento (desde modal gestión evento)",
      "Controlar estado peleas (upcoming→betting→live→completed)",
      "Configurar streaming RTMP key (generar key para OBS)",
      "Operadores usan mismo dashboard que admin"
    ]
  },

  "SCOPE_OUT_REMOVED": {
    "hide_completely": [
      "BettingPanel component (remover de LiveEvent page)",
      "Wallet links in Navigation (ocultar para todos los roles)",
      "Apuestas page (/bets → redirect to /eventos)",
      "Any betting-related UI elements"
    ],
    "rationale": "Wallet y apuestas pueden esperar. Prioridad: eventos live + admin workflows."
  },

  "MANDATORY_SESSION_START_PROTOCOL": {
    "step_1_role_declaration": {
      "CRITICAL": "FIRST message: Model: claude-sonnet-4-5 | Role: director_and_implementer | Mode: standard | Task: Day 1 Production Validation - Fix runtime errors + manual validation of eventos live + admin workflows",
      "source": "brain/multi_ai_coordination_strategy.json lines 102-124"
    },
    "step_2_read_coordination_strategy": {
      "CRITICAL": "Read brain/multi_ai_coordination_strategy.json lines 502-530 (evidence_based_validation_protocol)",
      "purpose": "Understand validation expectations - report ACTUAL results, not assumptions"
    },
    "step_3_read_qwen_report": {
      "CRITICAL": "Read brain/backlog.json lines 1173-1335 (e2e_frontend_validation_2025_11_10)",
      "purpose": "Understand what QWEN found: runtime error at line 394, missing SSE status, auth flow issues"
    }
  },

  "task_objectives": {
    "phase_1_fix_runtime_errors": {
      "priority": "P0_BLOCKER",
      "estimated_time": "3 hours",
      "description": "Fix JavaScript crashes that prevent users from viewing events",
      "critical_error_from_qwen": "Cannot read properties of undefined (reading 'loadEventEnd') at Events page line 394",

      "investigation_steps": [
        {
          "step": 1,
          "action": "Find the exact error location",
          "command": "grep -n 'loadEventEnd' frontend/src/pages/user/Events.tsx frontend/src/pages/user/LiveEvent.tsx",
          "purpose": "Locate the exact line causing crash"
        },
        {
          "step": 2,
          "action": "Read affected files to understand data flow",
          "files": [
            "frontend/src/pages/user/Events.tsx",
            "frontend/src/pages/user/LiveEvent.tsx",
            "frontend/src/pages/user/Dashboard.tsx"
          ],
          "purpose": "Understand how event data flows from API to rendering"
        },
        {
          "step": 3,
          "action": "Search for ALL unsafe property access patterns",
          "command": "grep -n 'event\\.' frontend/src/pages/user/*.tsx | grep -v '?\\.'",
          "purpose": "Find all locations without optional chaining that could crash"
        },
        {
          "step": 4,
          "action": "Apply defensive programming fixes",
          "pattern": {
            "before": "const value = event.venue.profileInfo.venueName",
            "after": "const value = event?.venue?.profileInfo?.venueName ?? 'Unknown Venue'",
            "principle": "Use optional chaining (?.) + nullish coalescing (??)"
          }
        }
      ],

      "files_to_fix": [
        "frontend/src/pages/user/Events.tsx",
        "frontend/src/pages/user/LiveEvent.tsx",
        "frontend/src/pages/user/Dashboard.tsx",
        "frontend/src/components/user/BettingPanel.tsx (REMOVE this component entirely)"
      ],

      "success_criteria": [
        "npm run dev starts without TypeScript errors",
        "Navigate to /eventos - page loads without crash",
        "Navigate to /eventos/:id - event detail loads",
        "Zero 'Cannot read properties of undefined' errors in browser console"
      ]
    },

    "phase_2_hide_betting_wallet_ui": {
      "priority": "P0_CRITICAL",
      "estimated_time": "1 hour",
      "description": "Remove betting and wallet UI elements completely (out of scope for launch)",

      "changes_required": [
        {
          "file": "frontend/src/components/user/Navigation.tsx",
          "change": "Hide 'Apuestas' and 'Wallet' menu items for ALL roles",
          "validation": "Navigation should only show: Eventos, Galleras, Venues, Profile"
        },
        {
          "file": "frontend/src/pages/user/LiveEvent.tsx",
          "change": "Remove BettingPanel component import and usage",
          "validation": "Event detail page shows only: video player, fight list, status updates"
        },
        {
          "file": "frontend/src/App.tsx or routes config",
          "change": "Redirect /bets and /wallet routes to /eventos",
          "validation": "Accessing /bets or /wallet redirects to /eventos"
        }
      ],

      "success_criteria": [
        "No betting UI visible anywhere in user interface",
        "No wallet links in navigation",
        "/bets and /wallet routes redirect to /eventos",
        "App still compiles and runs without errors"
      ]
    },

    "phase_3_manual_validation_eventos_live": {
      "priority": "P0_CRITICAL",
      "estimated_time": "2 hours",
      "description": "Manually validate EVENTOS EN VIVO user workflows (highest risk area)",

      "test_1_authentication_and_access": {
        "flow": "User Login → Access Protected Content",
        "steps": [
          "Start backend: cd backend && npm run dev",
          "Start frontend: cd frontend && npm run dev",
          "Navigate to http://localhost:5173/eventos (should redirect to /login)",
          "Login with test user credentials",
          "Verify redirect to /eventos after successful login",
          "Verify eventos list loads (check browser console for errors)"
        ],
        "pass_criteria": "Login works, redirect works, eventos page loads without crashes",
        "fail_action": "Document exact error with screenshot + console log → add to bugs list"
      },

      "test_2_eventos_list_and_detail": {
        "flow": "View Events List → Click Event → See Detail",
        "steps": [
          "On /eventos page, verify at least 1 event visible",
          "Check browser console: should have zero JavaScript errors",
          "Click on first event card",
          "Verify navigation to /eventos/:id works",
          "Verify event detail page shows: event name, date, venue, fights list",
          "Check browser console again for errors"
        ],
        "pass_criteria": "Events list loads, event detail navigates correctly, no console errors",
        "fail_action": "Document which part fails (list? detail? navigation?) → add to bugs list"
      },

      "test_3_streaming_player": {
        "flow": "Event Detail → Video Player Loads",
        "steps": [
          "On event detail page (/eventos/:id), find video player component",
          "If event status = 'in-progress', player should attempt to load stream",
          "If event status = 'upcoming', player should show 'Event not started'",
          "Check browser Network tab: is HLS manifest request made?",
          "Check for HLS.js errors in console"
        ],
        "pass_criteria": "Player component renders, handles different event statuses correctly",
        "fail_action": "Document player behavior (crashes? shows error? doesn't load?) → bugs list",
        "note": "Actual video playback depends on RTMP server being configured - focus on component not crashing"
      },

      "test_4_sse_real_time_updates": {
        "flow": "SSE Connection → Real-time Fight Status Updates",
        "steps": [
          "On event detail page, open browser DevTools → Network tab",
          "Filter for 'EventSource' or '/sse/' connections",
          "Verify SSE connection established (status 200, connection kept alive)",
          "Open browser console, look for SSE connection logs",
          "If possible: trigger fight status change from admin panel",
          "Verify event detail page updates WITHOUT page refresh"
        ],
        "pass_criteria": "SSE connection establishes successfully, no connection errors",
        "fail_action": "Document SSE issues (connection fails? updates don't appear?) → bugs list",
        "note": "SSE functionality is CRITICAL - if broken, this is P0 blocker"
      },

      "documentation_format": {
        "for_each_test": {
          "test_name": "Test identifier",
          "status": "PASS or FAIL",
          "evidence": "Screenshot filename OR console log excerpt",
          "bugs_found": "Detailed description of what's broken",
          "severity": "P0 (blocks production) or P1 (polish issue) or P2 (nice-to-have)"
        }
      }
    },

    "phase_4_manual_validation_admin_workflows": {
      "priority": "P0_CRITICAL",
      "estimated_time": "2 hours",
      "description": "Manually validate ADMIN DASHBOARD workflows (second highest risk)",

      "test_5_admin_login_and_navigation": {
        "flow": "Admin Login → Access Admin Dashboard",
        "steps": [
          "Logout from user account",
          "Login with admin credentials (admin@gallobets.com or similar)",
          "Verify redirect to /admin/dashboard or /admin/events",
          "Check admin navigation sidebar: Users, Events, Venues, Galleras, Membership Requests, Subscriptions all visible?",
          "Click through each admin menu item, verify pages load without crashes"
        ],
        "pass_criteria": "Admin login works, all admin pages accessible, no console errors",
        "fail_action": "Document which pages crash or don't load → bugs list"
      },

      "test_6_create_event_workflow": {
        "flow": "Admin Creates New Event (CRITICAL WORKFLOW)",
        "steps": [
          "Navigate to /admin/events",
          "Click 'Create Event' button",
          "Fill event form: name, date, venue (select from dropdown), operator (optional)",
          "Submit form",
          "Verify event appears in events list",
          "Check browser console for API errors"
        ],
        "pass_criteria": "Event creation form works, event created successfully, appears in list",
        "fail_action": "Document form issues (validation? API error? UI crash?) → bugs list"
      },

      "test_7_add_fights_to_event": {
        "flow": "Admin Adds Fights to Event",
        "steps": [
          "On /admin/events, click on the event created in test_6",
          "Find 'Add Fight' button (might be in modal or detail view)",
          "Fill fight form: fight number, red rooster name, blue rooster name",
          "Submit fight",
          "Verify fight appears in event's fights list",
          "Try adding 2-3 more fights"
        ],
        "pass_criteria": "Add fight form works, fights created successfully, list updates",
        "fail_action": "Document fight creation issues → bugs list"
      },

      "test_8_fight_status_control": {
        "flow": "Admin Controls Fight Status (MOST CRITICAL)",
        "steps": [
          "On event detail with fights, find fight status controls",
          "Change fight status: upcoming → betting",
          "Verify status updates in UI",
          "Change status: betting → live",
          "Change status: live → completed",
          "Check browser console for SSE broadcast events"
        ],
        "pass_criteria": "Fight status transitions work, UI updates correctly",
        "fail_action": "Document status control issues (buttons don't work? API errors?) → bugs list"
      },

      "test_9_streaming_rtmp_key": {
        "flow": "Admin Generates RTMP Key for OBS",
        "steps": [
          "On event detail or streaming page, find 'Generate Stream Key' button",
          "Click button",
          "Verify RTMP key generated (format: stream_<eventId>_<hash>)",
          "Verify RTMP URL displayed (rtmp://server/stream_key)",
          "Check if OBS configuration instructions shown"
        ],
        "pass_criteria": "Stream key generation works, RTMP URL provided",
        "fail_action": "Document streaming config issues → bugs list",
        "note": "Actual streaming test requires RTMP server - focus on key generation working"
      },

      "test_10_crud_operations": {
        "flow": "Admin CRUD for Users/Venues/Galleras/Subscriptions/Requests",
        "steps": [
          "Navigate to /admin/users → verify user list loads",
          "Try creating test user → verify form works",
          "Navigate to /admin/venues → verify venue list loads",
          "Navigate to /admin/galleras → verify gallera list loads",
          "Navigate to /admin/membership-requests → verify requests list loads",
          "Navigate to /admin/subscriptions → verify subscriptions list loads",
          "For each page: check browser console for errors"
        ],
        "pass_criteria": "All admin CRUD pages load without crashes, basic operations work",
        "fail_action": "Document which pages/operations fail → bugs list"
      }
    }
  },

  "reporting_protocol": {
    "where": "EXACT PATH: /home/veranoby/sports-bets/brain/backlog.json",
    "entry_name": "claude_production_validation_day1_2025_11_10",
    "mandatory_fields": {
      "executor": "Claude Sonnet 4.5 (Director + Implementer)",
      "date": "2025-11-10",
      "task": "Day 1 Production Validation - Runtime fixes + Manual validation (eventos live + admin)",
      "status": "COMPLETED or IN_PROGRESS or BLOCKED",
      "verification_evidence": {
        "runtime_errors_fixed": "List of files modified with specific changes",
        "betting_ui_removed": "List of files where betting/wallet UI was hidden",
        "console_errors_before": "Count of JavaScript errors before fixes",
        "console_errors_after": "Count after fixes (should be 0 or near-0)",
        "manual_validation_eventos_live": {
          "test_1_auth": "PASS or FAIL with details",
          "test_2_eventos_list_detail": "PASS or FAIL with details",
          "test_3_streaming_player": "PASS or FAIL with details",
          "test_4_sse_updates": "PASS or FAIL with details"
        },
        "manual_validation_admin": {
          "test_5_admin_login": "PASS or FAIL with details",
          "test_6_create_event": "PASS or FAIL with details",
          "test_7_add_fights": "PASS or FAIL with details",
          "test_8_fight_status": "PASS or FAIL with details",
          "test_9_rtmp_key": "PASS or FAIL with details",
          "test_10_crud_operations": "PASS or FAIL with details"
        }
      },
      "bugs_found_for_qwen": [
        {
          "bug_id": "Unique identifier (e.g., BUG_001)",
          "description": "What is broken (be specific)",
          "severity": "P0 (blocks launch) or P1 (important UX) or P2 (polish)",
          "location": "File/component affected",
          "reproduction": "Exact steps to reproduce",
          "evidence": "Screenshot filename or console log"
        }
      ],
      "deployment_readiness": "READY or BLOCKED",
      "blockers_if_blocked": "List of P0 bugs preventing launch"
    },
    "enforcement": "BEFORE reporting: 1) Update backlog.json 2) git add brain/backlog.json 3) git diff --cached to verify 4) THEN report to user"
  },

  "validation_gates": {
    "before_considering_complete": [
      "Runtime errors fixed (evidence: npm run dev succeeds, pages load without crashes)",
      "Betting/wallet UI hidden (evidence: no betting UI visible in navegation or pages)",
      "Manual validation COMPLETE: All 10 tests executed with documented results",
      "Bugs list created: All P0/P1/P2 bugs documented with evidence",
      "Brain/backlog.json updated with structured report",
      "git add brain/backlog.json (staged, ready for review)"
    ]
  },

  "handoff_to_qwen": {
    "what_to_provide": "List of P1/P2 bugs discovered during manual validation (P0 bugs must be fixed by Claude immediately)",
    "format": "JSON array in backlog.json under 'bugs_found_for_qwen' field",
    "qwen_will_execute": "Day 2 - Fix P1/P2 bugs from manual validation + final polish"
  },

  "critical_protocols_from_strategy": {
    "source": "brain/multi_ai_coordination_strategy.json",
    "applied_protocols": {
      "evidence_based_validation": "Lines 502-530 - Report ACTUAL results from manual testing, not assumptions about what should work",
      "debugging_methodology": "Lines 136-143 - Analyze before fixing, identify root causes of runtime errors",
      "task_disambiguation": "Lines 102-124 - Echo back task at session start for confirmation"
    }
  },

  "success_criteria_day1": {
    "must_achieve": [
      "Runtime errors FIXED - usuarios pueden navegar eventos sin crashes",
      "Betting/Wallet UI REMOVED - solo eventos live visible",
      "Manual validation COMPLETE - 10 tests executed, results documented",
      "Bugs documented - Lista clara de P0/P1/P2 bugs con evidencia",
      "Deployment assessment - READY or BLOCKED decision based on real testing"
    ]
  }
}
