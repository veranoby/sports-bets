{
  "metadata": {
    "phase_name": "MEMBERSHIP MANAGEMENT OPTIMIZATION",
    "priority": "P0_CRITICAL", 
    "estimated_total_hours": 12,
    "implementation_approach": "MODAL_INTEGRATION + UNIFIED_UI_PATTERN",
    "success_criteria": [
      "Remove UserMembershipPanel from Users table, integrate into modal tabs",
      "Extend EditUserModal subscription tab with Gemini freemium logic",
      "Implement membership management for Galleras and Venues in their modals",
      "Display membership expiration dates in tables and modals",
      "Move features status widget from Settings to Dashboard"
    ],
    "technical_stack": "Existing modal architecture + enhanced SubscriptionTabs component",
    "lessons_learned_applied": {
      "dependency_management": " All required dependencies already installed (no new deps needed)",
      "file_targeting": " Target .tsx source files explicitly",
      "verification_requirements": " Include npm run dev startup verification"
    }
  },
  
  "phase_1_cleanup_inappropriate_implementation": {
    "estimated_hours": 2,
    "priority": "P0",
    "tool": "claude_code",
    "dependencies": [],
    "tasks": {
      "task_1_remove_membership_from_tables": {
        "file_to_modify": "frontend/src/pages/admin/Users.tsx",
        "description": "Remove UserMembershipPanel from users table and add expiration date column",
        "estimated_time": "30min",
        "exact_modifications": {
          "remove_import": "import UserMembershipPanel from \"../../components/admin/UserMembershipPanel\";",
          "remove_table_cell": [
            "<!-- Remove this cell from table -->",
            "<td className=\"px-6 py-4 whitespace-nowrap\">",
            "  <UserMembershipPanel userId={user.id} currentMembership={user.subscription} onMembershipUpdated={fetchUsers} />",
            "</td>"
          ],
          "add_expiration_column": [
            "<!-- Add after subscription column -->",
            "<td className=\"px-6 py-4 whitespace-nowrap text-sm text-gray-600\">",
            "  {user.subscription?.manual_expires_at ? new Date(user.subscription.manual_expires_at).toLocaleDateString() : 'N/A'}",
            "</td>"
          ],
          "update_table_headers": [
            "<!-- Add header after Membership column -->",
            "<th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">Expires</th>"
          ]
        }
      },
      
      "task_2_update_galleras_venues_tables": {
        "files_to_modify": [
          "frontend/src/pages/admin/Galleras.tsx",
          "frontend/src/pages/admin/Venues.tsx"
        ],
        "description": "Add membership expiration column to Galleras and Venues tables",
        "estimated_time": "45min",
        "exact_modifications": {
          "add_expiration_columns": [
            "<!-- Add column after existing columns -->",
            "<td className=\"px-6 py-4 whitespace-nowrap text-sm text-gray-600\">",
            "  {entity.user?.subscription?.manual_expires_at ? new Date(entity.user.subscription.manual_expires_at).toLocaleDateString() : 'Free'}",
            "</td>"
          ],
          "add_headers": [
            "<th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">Membership Expires</th>"
          ]
        }
      }
    }
  },

  "phase_2_enhanced_subscription_tabs": {
    "estimated_hours": 4,
    "priority": "P0",
    "tool": "claude_code",
    "dependencies": ["phase_1_cleanup_inappropriate_implementation"],
    "tasks": {
      "task_3_enhance_subscription_tabs": {
        "file_to_modify": "frontend/src/components/admin/SubscriptionTabs.tsx",
        "description": "Replace existing SubscriptionTabs with enhanced version including Gemini freemium logic",
        "estimated_time": "2h",
        "current_implementation_analysis": "Existing SubscriptionTabs component needs Gemini UserMembershipPanel functionality integrated",
        "exact_modifications": {
          "add_imports": [
            "import { adminAPI } from '../../services/api';",
            "import { Crown, Clock, User } from 'lucide-react';"
          ],
          "replace_subscription_content": [
            "// Replace existing subscription content with freemium management",
            "const [selectedType, setSelectedType] = useState<string>('free');",
            "const [assignedUsername, setAssignedUsername] = useState<string>('');",
            "const [loading, setLoading] = useState<boolean>(false);",
            "",
            "const membershipOptions = [",
            "  { value: 'free', label: 'Free', icon: <User className=\"w-4 h-4\" /> },",
            "  { value: '24h', label: '24 Hours Premium', icon: <Clock className=\"w-4 h-4\" /> },",
            "  { value: 'monthly', label: '1 Month Premium', icon: <Crown className=\"w-4 h-4\" /> }",
            "];",
            "",
            "const handleMembershipUpdate = async () => {",
            "  if (!assignedUsername.trim()) {",
            "    notification.error({ message: 'Username assignment is required' });",
            "    return;",
            "  }",
            "  setLoading(true);",
            "  try {",
            "    await adminAPI.updateUserMembership(userId, {",
            "      membership_type: selectedType,",
            "      assigned_username: assignedUsername.trim()",
            "    });",
            "    notification.success({ message: `Membership updated to ${selectedType}` });",
            "    onSave?.();",
            "  } catch (error) {",
            "    notification.error({ message: 'Failed to update membership' });",
            "  }",
            "  setLoading(false);",
            "};"
          ],
          "add_membership_status_display": [
            "// Add current membership status and dates",
            "<div className=\"mb-6 p-4 bg-gray-50 rounded-lg\">",
            "  <h4 className=\"font-medium text-gray-900 mb-2\">Current Membership Status</h4>",
            "  <div className=\"grid grid-cols-2 gap-4 text-sm\">",
            "    <div>",
            "      <span className=\"text-gray-500\">Status:</span> {subscription?.status || 'free'}",
            "    </div>",
            "    <div>",
            "      <span className=\"text-gray-500\">Type:</span> {subscription?.type || 'N/A'}",
            "    </div>",
            "    <div>",
            "      <span className=\"text-gray-500\">Last Activated:</span> {subscription?.createdAt ? new Date(subscription.createdAt).toLocaleDateString() : 'N/A'}",
            "    </div>",
            "    <div>",
            "      <span className=\"text-gray-500\">Expires:</span> {subscription?.manual_expires_at ? new Date(subscription.manual_expires_at).toLocaleDateString() : 'N/A'}",
            "    </div>",
            "  </div>",
            "</div>"
          ]
        }
      },
      
      "task_4_extend_edit_modals": {
        "files_to_modify": [
          "frontend/src/components/admin/EditVenueModal.tsx",
          "frontend/src/components/admin/EditGalleraModal.tsx"
        ],
        "description": "Add membership tab to Venue and Gallera edit modals",
        "estimated_time": "2h",
        "exact_modifications": {
          "add_membership_tab": [
            "// Add membership tab state",
            "const [activeTab, setActiveTab] = useState<'profile' | 'membership'>('profile');",
            "",
            "// Add tab buttons",
            "<div className=\"border-b border-gray-200 mb-6\">",
            "  <nav className=\"-mb-px flex space-x-8\">",
            "    <button onClick={() => setActiveTab('profile')} className={`py-2 px-1 border-b-2 font-medium text-sm ${activeTab === 'profile' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}`}>Profile</button>",
            "    <button onClick={() => setActiveTab('membership')} className={`py-2 px-1 border-b-2 font-medium text-sm ${activeTab === 'membership' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}`}>Membership</button>",
            "  </nav>",
            "</div>",
            "",
            "// Add membership tab content",
            "{activeTab === 'membership' && (",
            "  <SubscriptionTabs",
            "    userId={entity.userId || entity.user?.id}",
            "    subscription={entity.user?.subscription}",
            "    onSave={() => { /* refresh entity data */ }}",
            "    onCancel={onClose}",
            "  />",
            ")}"
          ]
        }
      }
    }
  },

  "phase_3_dashboard_features_integration": {
    "estimated_hours": 3,
    "priority": "P1",
    "tool": "claude_code", 
    "dependencies": ["phase_2_enhanced_subscription_tabs"],
    "tasks": {
      "task_5_move_features_to_dashboard": {
        "file_to_modify": "frontend/src/pages/admin/AdminDashboard.tsx",
        "description": "Add features status widget to top of dashboard",
        "estimated_time": "1.5h",
        "exact_modifications": {
          "add_imports": [
            "import { settingsAPI } from '../../config/api';",
            "import { Shield, Wallet, Users, Settings } from 'lucide-react';"
          ],
          "add_features_state": [
            "const [features, setFeatures] = useState({",
            "  betting_enabled: false,",
            "  wallet_enabled: false,",
            "  user_registration: false,",
            "  event_creation: false,",
            "  loading: true",
            "});",
            "",
            "const fetchFeatures = async () => {",
            "  try {",
            "    const response = await settingsAPI.getAll();",
            "    const settingsMap = response.data.reduce((acc, setting) => {",
            "      acc[setting.key] = setting.value === 'true';",
            "      return acc;",
            "    }, {});",
            "    setFeatures({ ...settingsMap, loading: false });",
            "  } catch (error) {",
            "    console.error('Error loading features:', error);",
            "    setFeatures(prev => ({ ...prev, loading: false }));",
            "  }",
            "};"
          ],
          "add_features_widget": [
            "// Add features status widget at top of dashboard",
            "<Card title=\"System Features Status\" className=\"mb-6\">",
            "  <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">",
            "    <div className=\"flex items-center space-x-3\">",
            "      <Shield className={`w-5 h-5 ${features.betting_enabled ? 'text-green-500' : 'text-red-500'}`} />",
            "      <div>",
            "        <p className=\"text-sm font-medium\">Betting</p>",
            "        <p className={`text-xs ${features.betting_enabled ? 'text-green-600' : 'text-red-600'}`}>",
            "          {features.betting_enabled ? 'Enabled' : 'Disabled'}",
            "        </p>",
            "      </div>",
            "    </div>",
            "    <div className=\"flex items-center space-x-3\">",
            "      <Wallet className={`w-5 h-5 ${features.wallet_enabled ? 'text-green-500' : 'text-red-500'}`} />",
            "      <div>",
            "        <p className=\"text-sm font-medium\">Wallet</p>",
            "        <p className={`text-xs ${features.wallet_enabled ? 'text-green-600' : 'text-red-600'}`}>",
            "          {features.wallet_enabled ? 'Enabled' : 'Disabled'}",
            "        </p>",
            "      </div>",
            "    </div>",
            "    <div className=\"flex items-center space-x-3\">",
            "      <Users className={`w-5 h-5 ${features.user_registration ? 'text-green-500' : 'text-red-500'}`} />",
            "      <div>",
            "        <p className=\"text-sm font-medium\">Registration</p>",
            "        <p className={`text-xs ${features.user_registration ? 'text-green-600' : 'text-red-600'}`}>",
            "          {features.user_registration ? 'Open' : 'Closed'}",
            "        </p>",
            "      </div>",
            "    </div>",
            "    <div className=\"flex items-center space-x-3\">",
            "      <Settings className={`w-5 h-5 ${features.event_creation ? 'text-green-500' : 'text-red-500'}`} />",
            "      <div>",
            "        <p className=\"text-sm font-medium\">Events</p>",
            "        <p className={`text-xs ${features.event_creation ? 'text-green-600' : 'text-red-600'}`}>",
            "          {features.event_creation ? 'Enabled' : 'Disabled'}",
            "        </p>",
            "      </div>",
            "    </div>",
            "  </div>",
            "</Card>"
          ]
        }
      },
      
      "task_6_update_settings_page": {
        "file_to_modify": "frontend/src/pages/admin/Settings.tsx", 
        "description": "Remove features status table from Settings page (moved to Dashboard)",
        "estimated_time": "30min",
        "exact_modifications": {
          "remove_features_section": [
            "// Remove the features status table section",
            "// Keep only the settings modification functionality"
          ],
          "add_dashboard_reference": [
            "// Add note pointing to dashboard",
            "<div className=\"mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg\">",
            "  <p className=\"text-sm text-blue-800\">",
            "    <strong>Note:</strong> View current features status on the <a href=\"/admin/dashboard\" className=\"underline\">Dashboard</a>.",
            "  </p>",
            "</div>"
          ]
        }
      }
    }
  },

  "phase_4_verification_and_testing": {
    "estimated_hours": 3,
    "priority": "P0",
    "tool": "claude_code",
    "dependencies": ["phase_3_dashboard_features_integration"],
    "tasks": {
      "task_7_comprehensive_verification": {
        "execution": "MANDATORY_FINAL_STEP",
        "description": "Verify complete membership management implementation works correctly",
        "verification_commands": [
          "cd frontend && npm run build",
          "cd backend && npm run dev"
        ],
        "manual_testing_checklist": [
          " Users table shows expiration dates, no UserMembershipPanel",
          " EditUserModal > Membership tab shows current status and allows updates",
          " Galleras table shows membership expiration dates",
          " EditGalleraModal > Membership tab functional",
          " Venues table shows membership expiration dates", 
          " EditVenueModal > Membership tab functional",
          " Dashboard shows features status widget at top",
          " Settings page no longer has features status table"
        ],
        "success_criteria": [
          "No UserMembershipPanel components in table views",
          "All edit modals have functional membership tabs",
          "Membership expiration dates visible in all user-related tables",
          "Dashboard displays features status prominently",
          "All functionality accessible and responsive"
        ],
        "failure_protocol": "If any verification fails, report specific issue and request debugging assistance",
        "estimated_time": "2h"
      }
    }
  },

  "technical_specifications": {
    "architectural_pattern": "Modal-based membership management with unified UX",
    "component_reuse": "Single SubscriptionTabs component for all user types (users, venues, galleras)",
    "data_flow": "AdminAPI ’ Modal Components ’ User Feedback ’ Table Refresh",
    "responsive_design": "Mobile-first approach with collapsible sections",
    "accessibility": "ARIA labels, keyboard navigation, screen reader support"
  },

  "quality_assurance": {
    "code_standards": "Follow existing TypeScript patterns and component structure",
    "error_handling": "Comprehensive try-catch blocks with user-friendly notifications",
    "performance": "Lazy loading of subscription data, optimistic UI updates",
    "security": "Admin-only access to membership management functionality"
  }
}