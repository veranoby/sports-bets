{
  "metadata": {
    "purpose": "Comprehensive API endpoint reference for Galleros.Net platform",
    "created": "2025-09-27",
    "version": "2.6",
    "last_updated": "2025-12-29 - Betting UX Refactor Complete: Updated Fight status endpoints to reflect 7-state system (draft, scheduled, ready, betting_open, in_progress, completed, cancelled). Removed PAGO/DOY endpoints. Documented fixed bet amounts [5,10,20,50,100,200,500]. Updated SSE events for 7-state Fight lifecycle. Streaming SSE normalization maintained from previous update.",
    "streaming_infrastructure_selected": "Nginx RTMP (self-managed) + PostgreSQL local (OPTION B.1)",
    "streaming_platform_selected": "Nginx RTMP (self-managed) + PostgreSQL local (OPTION B.1 selected 2025-11-20)",
    "environment_variables_required": {
      "STREAM_SERVER_URL": "rtmp://nginx-server:1935/live",
      "CDN_URL": "http://nginx-server (Phase 1) or https://bunny-cdn (Phase 2)",
      "STREAM_HEALTH_CHECK_URL": "http://nginx-server"
    },
    "phase_2_bunny_cdn": "When scaling >500 concurrent, add Bunny CDN (config-only change, no code changes needed)",
    "critical_note": "NEVER change these endpoints without updating this documentation",
    "validation_command": "npm run test:api-endpoints",
    "changelog": {
      "v2.7": "2025-12-29 - Betting UX Refactor Complete: Updated Fight.status endpoint to support 7-state system (draft, scheduled, ready, betting_open, in_progress, completed, cancelled). Removed DOY/PAGO proposal endpoints (no longer supported). Updated Bet endpoints to support fixed amounts only [5,10,20,50,100,200,500] with auto-matching. Documented PostgreSQL CHECK constraint on bet amounts. 12 commits across SQL migrations, backend models, frontend components, and cleanup tasks.",
      "v2.6": "2025-12-12 - Streaming SSE normalization: Added normalized direct event types STREAM_PAUSED/STREAM_RESUMED to SSEEventType enum. Backend now uses consistent direct event types for all streaming operations (start, stop, pause, resume). Added comprehensive documentation for all streaming SSE events. Maintained backward compatibility with legacy STREAM_STATUS_UPDATE wrapper events. Updated EventList to handle pause/resume events for real-time updates.",
      "v2.5": "2025-12-11 - Streaming live implementation: Added POST /api/streaming/auth, /unpublish for Nginx RTMP auth. Made /stream/start, /stream/stop idempotent. Added .m3u8 extension to streamUrl.",
      "v2.4": "2025-12-10 - Added PUT /fights/:id endpoint for editing fight details (redCorner, blueCorner, weight, notes). Only allows editing when fight.status='upcoming' to protect betting integrity. Added EditFightModal.tsx component. Frontend auto-refreshes after fight updates via EventDetail.tsx setTimeout fetch. Added process.env cleanup and PRE_HANDOFF_VALIDATION_PROTOCOL to multi_ai_coordination_strategy.json. Implemented by Qwen 3 Coder+ and Claude Sonnet 4.5. Commit: 2e6519ae",
      "v2.3.1": "2025-12-10 (earlier) - CRITICAL FIX: Fixed events.ts SSE broadcasts to include all required SSEEvent fields (id, timestamp, priority). Prevents 'Cannot read properties of undefined (reading getTime)' errors in SSE cleanup.",
      "v2.3": "2025-12-10 - Added broadcastToEvent method to SSE service specification. Updated API documentation to include missing methods.",
      "v2.2": "2025-12-06 - Added DELETE /events/:id/permanent (hard delete with cascade). Added DELETE /fights/:id (hard delete). POST /fights now auto-assigns number (removed manual input). UI refactor: removed redundant cancel buttons.",
      "v2.1": "2025-12-06 - Documented unified PATCH /events/:id/status. Marked deprecated POST endpoints for fights.",
      "v2.0": "2025-12-05 - Added GET /users/:id wallet relation documentation with DECIMAL string serialization. Enhanced POST /users/:userId/adjust-balance with frozenAmount validation and parseFloat() pattern. Documents critical PostgreSQL DECIMAL behavior.",
      "v1.9": "2025-12-05 - Optimized structure with consistent formatting and logical grouping",
      "v1.8": "2025-11-24 - Added system_settings and wallet_operations endpoints. P2P betting PAGO/DOY endpoints. Enhanced monitoring SSE. Settings admin UI complete."
    }
  },

  "quick_reference": {
    "authentication": ["/auth/login", "/auth/verify/:token", "/auth/forgot-password", "/auth/reset-password", "/auth/check-membership-status"],
    "users": ["/users/profile", "/users", "/users/:id", "/users/:id/password", "/users/:id/approve", "/users/:id/reject", "/users/:userId/adjust-balance", "/users/:userId/profile-info"],
    "venues": ["/venues", "/venues/:id"],
    "galleras": ["/galleras", "/galleras/:id"],
    "articles": ["/articles", "/articles/featured", "/articles/:id", "/articles/:id/approve", "/articles/:id/reject"],
    "events": ["/events", "/events/:id", "/events/:id/status", "/events/:id/permanent", "/events/:id/stats", "/events/:id/viewers", "/events/:id/analytics"],
    "fights": ["/fights", "/fights/:id", "/fights/:id/status", "/fights/:id"],
    "bets": ["/bets", "/bets/my-bets", "/bets/compatible", "/bets/:id", "/bets/:id/accept", "/bets/:id/cancel", "/bets/:id/edit", "/bets/:id/propose-pago", "/bets/:id/accept-pago", "/bets/:id/reject-pago", "/bets/:id/propose-doy", "/bets/:id/accept-doy", "/bets/:id/reject-doy", "/bets/pending-proposals"],
    "wallet": ["/wallet", "/wallet/balance", "/wallet/transactions", "/wallet/deposit", "/wallet/withdraw", "/wallet/financial-metrics", "/wallet/revenue-by-source", "/wallet/revenue-trends"],
    "wallet_operations": ["/wallet-operations", "/wallet-operations/deposit", "/wallet-operations/withdrawal", "/wallet-operations/:id/approve", "/wallet-operations/:id/reject", "/wallet-operations/:id/upload-proof", "/wallet-operations/stats"],
    "monitoring": ["/health", "/monitoring/alerts", "/monitoring/stats", "/monitoring/performance", "/monitoring/database", "/monitoring/cache", "/monitoring/memory", "/monitoring/connections", "/monitoring/intervals", "/monitoring/webhook/railway", "/monitoring/sse/admin/monitoring"],
    "settings": ["/settings", "/settings/:key", "/settings/features/public", "/settings/category/:category", "/settings/public"],
    "admin": ["/admin/sessions/active-users", "/admin/sessions/:userId", "/admin/users/:userId/adjust-balance", "/membership-requests", "/membership-requests/:id/complete", "/membership-requests/:id/reject", "/membership-requests/my-requests", "/membership-requests/pending"],
    "notifications": ["/notifications", "/notifications/:id/read", "/notifications/:id", "/notifications/mark-all-read"],
    "uploads": ["/uploads/image", "/uploads/image/:filename"],
    "streaming": ["/sse/streaming", "/streaming/auth", "/streaming/unpublish", "/events/:id/stream/start", "/events/:id/stream/stop", "/events/:id/stream/status", "/streaming/pause", "/streaming/resume"]
  },

  "base_configuration": {
    "backend_url": "http://localhost:3001",
    "api_prefix": "/api",
    "authentication": "Bearer token in Authorization header",
    "content_type": "application/json",
    "sse_authentication_note_2025_11_19": "EventSource API (used for SSE connections) CANNOT send custom headers. Token must be passed via query parameter (?token=...) instead of Authorization header. Updated extractToken() middleware to check req.query.token for SSE compatibility."
  },

  "sse_service_endpoints": {
    "broadcast_to_event": {
      "method": "broadcastToEvent",
      "parameters": {
        "eventId": "string - Unique identifier of the event",
        "event": "SSEEvent - The event object to broadcast"
      },
      "description": "Broadcasts an SSE event to a specific event channel. Creates a channel named `event-${eventId}` and sends the event to all connected clients in that channel.",
      "implementation": "backend/src/services/sseService.ts:896-901",
      "behavior": "Creates a channel named `event-${eventId}` and calls broadcastToChannel with that channel",
      "return_type": "number - Number of successful connections that received the event",
      "example_usage": "sseService.broadcastToEvent(\"event123\", {type: 'FIGHT_STATUS_UPDATE', data: {...}})",
      "use_case": "Sending real-time updates to clients connected to a specific event, such as fight status updates, betting window changes, or stream status updates"
    },
    "broadcast_to_channel": {
      "method": "broadcastToChannel",
      "parameters": {
        "channel": "string - Channel name to broadcast to",
        "event": "SSEEvent - The event object to broadcast"
      },
      "description": "Broadcasts an SSE event to all connections in a specific channel.",
      "implementation": "backend/src/services/sseService.ts:468-481",
      "behavior": "Sends the event to all active connections subscribed to the specified channel",
      "return_type": "number - Number of successful connections that received the event",
      "example_usage": "sseService.broadcastToChannel(\"admin-bets\", {type: 'NEW_BET', data: {...}})",
      "use_case": "Sending updates to all clients in a specific channel, like admin monitoring or event-specific updates"
    },
    "add_event_connection": {
      "method": "addEventConnection",
      "parameters": {
        "res": "Response - Express response object",
        "eventId": "string - Unique identifier of the event",
        "userId": "string (optional) - User ID of the connecting user",
        "userRole": "string (optional) - Role of the connecting user",
        "metadata": "any (optional) - Additional metadata for the connection"
      },
      "description": "Adds a new SSE connection to a specific event channel.",
      "implementation": "backend/src/services/sseService.ts:904-913",
      "behavior": "Creates a connection to the channel named `event-${eventId}` with optional user information",
      "return_type": "string - The connection ID",
      "example_usage": "sseService.addEventConnection(res, \"event123\", userId, \"user\", metadata)",
      "use_case": "Allowing clients to connect to real-time updates for a specific event"
    }
  },

  "streaming_sse_events": {
    "stream_started": {
      "type": "STREAM_STARTED",
      "data_structure": {
        "eventId": "string - Unique identifier of the event",
        "id": "string - Unique identifier (same as eventId)",
        "streamUrl": "string - URL of the HLS stream",
        "streamStatus": "string - Status of the stream ('connected')",
        "name": "string - Name of the event",
        "venue": "object - Venue information",
        "operator": "object - Operator information"
      },
      "description": "Broadcast when a stream is started for an event",
      "broadcast_channels": ["event-specific", "AdminChannel.GLOBAL"],
      "frontend_usage": "Updates UI to show streaming as active and loads the video player",
      "implementation": "backend/src/routes/events.ts:650-675"
    },
    "stream_stopped": {
      "type": "STREAM_STOPPED",
      "data_structure": {
        "eventId": "string - Unique identifier of the event",
        "id": "string - Unique identifier (same as eventId)",
        "streamStatus": "string - Status of the stream ('disconnected')",
        "streamUrl": "string - URL of the HLS stream (now null)",
        "name": "string - Name of the event",
        "venue": "object - Venue information",
        "operator": "object - Operator information"
      },
      "description": "Broadcast when a stream is stopped for an event",
      "broadcast_channels": ["event-specific", "AdminChannel.GLOBAL"],
      "frontend_usage": "Updates UI to hide the video player and change stream status",
      "implementation": "backend/src/routes/events.ts:720-745"
    },
    "stream_paused": {
      "type": "STREAM_PAUSED",
      "data_structure": {
        "eventId": "string - Unique identifier of the event",
        "id": "string - Unique identifier (same as eventId)",
        "streamStatus": "string - Status of the stream ('paused')",
        "message": "string - Status message",
        "timestamp": "Date - When the event occurred"
      },
      "description": "Broadcast when a stream is paused for an event",
      "broadcast_channels": ["event-specific", "AdminChannel.GLOBAL"],
      "frontend_usage": "Updates UI to show stream as paused",
      "implementation": "backend/src/routes/streaming.ts:730-738"
    },
    "stream_resumed": {
      "type": "STREAM_RESUMED",
      "data_structure": {
        "eventId": "string - Unique identifier of the event",
        "id": "string - Unique identifier (same as eventId)",
        "streamStatus": "string - Status of the stream ('connected')",
        "message": "string - Status message",
        "timestamp": "Date - When the event occurred"
      },
      "description": "Broadcast when a stream is resumed for an event",
      "broadcast_channels": ["event-specific", "AdminChannel.GLOBAL"],
      "frontend_usage": "Updates UI to show stream as active again",
      "implementation": "backend/src/routes/streaming.ts:802-810"
    },
    "stream_status_update": {
      "type": "STREAM_STATUS_UPDATE",
      "data_structure": {
        "type": "string - Inner event type ('STREAM_PAUSED', 'STREAM_RESUMED', etc.)",
        "eventId": "string - Unique identifier of the event",
        "message": "string - Status message",
        "timestamp": "Date - When the event occurred"
      },
      "description": "Legacy wrapper event type for streaming status updates (to be deprecated)",
      "broadcast_channels": ["event-specific", "AdminChannel.GLOBAL"],
      "frontend_usage": "Handles backward compatibility for older clients",
      "implementation": "backend/src/routes/streaming.ts (deprecated format)"
    }
  },

  "authentication_endpoints": {
    "login": {
      "method": "POST",
      "path": "/auth/login",
      "body": {"login": "string", "password": "string"},
      "response": {"success": true, "data": {"token": "jwt", "user": "object"}},
      "auth_required": false
    },
    "register": {
      "method": "POST",
      "path": "/auth/register",
      "body": {"username": "string", "email": "string", "password": "string", "role": "string (optional: 'admin'|'operator'|'venue'|'user'|'gallera', default 'user')", "profileInfo": "object (optional - includes business fields for venue/gallera)"},
      "response": {"success": true, "data": {"user": "object", "token": "jwt"}},
      "auth_required": false,
      "auto_creation": {
        "venue_entity": "If role='venue', automatically creates Venue record with ownerId and status='pending'",
        "gallera_entity": "If role='gallera', automatically creates Gallera record with ownerId and status='pending'",
        "approval_status": "All public registrations marked as approved=false, require admin approval",
        "added_date": "2025-10-29"
      },
      "note": "UPDATED 2025-10-29: Added role selection and auto-entity creation for atomic user+entity setup"
    },
    "verify_email": {
      "method": "GET",
      "path": "/auth/verify/:token",
      "auth_required": false,
      "response": {"success": true, "message": "Email verified successfully", "data": {"user": "User object"}},
      "purpose": "Verify user email via token sent during registration"
    },
    "forgot_password": {
      "method": "POST",
      "path": "/auth/forgot-password",
      "body": {"email": "string"},
      "auth_required": false,
      "response": {"success": true, "message": "Password reset link sent to email"},
      "purpose": "Send password reset link to user's email"
    },
    "reset_password": {
      "method": "POST",
      "path": "/auth/reset-password",
      "body": {"token": "string", "password": "string", "confirmPassword": "string"},
      "auth_required": false,
      "response": {"success": true, "message": "Password reset successfully"},
      "purpose": "Reset user password using reset token"
    },
    "check_membership": {
      "method": "POST",
      "path": "/auth/check-membership-status",
      "auth_required": true,
      "purpose": "Verify if user has membership status"
    }
  },

  "user_endpoints": {
    "get_profile": {
      "method": "GET",
      "path": "/users/profile",
      "response": {"success": true, "data": {"user": "object", "subscription": "UserSubscription object"}},
      "auth_required": true,
      "note": "CRITICAL: Route MUST be before /:id to avoid UUID parsing"
    },
    "update_profile": {
      "method": "PUT",
      "path": "/users/profile",
      "body": {"profileInfo": "object"},
      "auth_required": true,
      "roles": "ANY authenticated user (self-edit only)",
      "read_only_fields": ["username", "email"],
      "protection_note": "âœ… ENFORCED 2025-10-19: Attempts to modify username/email are rejected with 400 error",
      "frontend_method": "userAPI.updateProfile(data) in frontend/src/services/api.ts",
      "validation_added_2025_10_30": {
        "image_limits": "ENFORCED - Validates image array sizes before persisting",
        "gallera_images_max": 3,
        "venue_images_max": 2,
        "validation_location": "backend/src/routes/users.ts:295-310",
        "error_response": "400 BadRequest with 'Maximum X images allowed for [type]' message"
      },
      "special_features": {
        "data_storage": "ðŸ”´ FASE 5 CONSOLIDATED: All venue/gallera data stored DIRECTLY in User.profileInfo JSONB field. NO sync to dedicated tables (tables eliminated 2025-11-04)",
        "venue_fields": ["venueName", "venueLocation", "venueDescription", "venueEmail", "venueWebsite", "images"],
        "gallera_fields": ["galleraName", "galleraLocation", "galleraDescription", "galleraEmail", "galleraWebsite", "galleraSpecialties", "galleraActiveRoosters", "images"],
        "display_logic": "venue/gallera names replace username in headers and profile display",
        "image_upload": "Supports imageUrl field for avatar upload, images array (max 2 for venues, max 3 for galleras)",
        "access_pattern": "Direct access: user.profileInfo.venueName (NOT venue.owner.profileInfo.venueName)"
      }
    },
    "list_users": {
      "method": "GET",
      "path": "/users",
      "query_params": ["limit", "offset", "role", "isActive", "search", "approved", "subscriptionType"],
      "auth_required": true,
      "roles": ["admin", "operator"],
      "filter_support": {
        "search": "string - search username or email (combined with other filters)",
        "approved": "'true'|'false' - filter by user approval status",
        "subscriptionType": "'free'|'monthly'|'daily' - filter by active subscription type",
        "combining_filters": "âœ… All filters can be combined. Example: /users?search=john&approved=false&subscriptionType=monthly",
        "note_2025_10_30": "Backend updated to support combined filters using Op.and(Op.or(...)) pattern. Filters work independently AND together."
      },
      "critical_change_2025_10_30": "CONSOLIDATED ARCHITECTURE: venues and galleras tables ELIMINATED. All data now in User.profileInfo for users with role='venue' or role='gallera'",
      "usage_for_venues": "/users?role=venue â†’ Returns User[] with profileInfo.venueName, venueLocation, etc",
      "usage_for_galleras": "/users?role=gallera â†’ Returns User[] with profileInfo.galleraName, galleraLocation, etc",
      "status_field_logic": "Status is CALCULATED field, not stored. Derived from (User.isActive && User.approved): true+true='active', true+false='pending', false+true='inactive', false+false='rejected'. NO status filter in venues/galleras queries.",
      "image_constraints": "profileInfo.venueImages and profileInfo.galleraImages limited to maximum 3 images per business for security and bandwidth"
    },
    "get_user_by_id": {
      "method": "GET",
      "path": "/users/:id",
      "auth_required": true,
      "response": {"success": true, "data": {"user": "User object with wallet relation if exists"}},
      "includes": {
        "wallet": "Wallet object with balance, frozenAmount, availableBalance (ADDED 2025-12-05)",
        "note": "Wallet relation loaded via Sequelize include for admin balance management"
      },
      "wallet_serialization": {
        "critical": "PostgreSQL DECIMAL(12,2) fields return as strings. Wallet.toPublicJSON() converts to numbers.",
        "pattern": "parseFloat(String(wallet.balance)) used throughout backend for arithmetic operations"
      },
      "implementation": "backend/src/routes/users.ts:211-223",
      "purpose": "Get user details with wallet for admin balance adjustment operations",
      "updated_date": "2025-12-05"
    },
    "get_user_business_entity": {
      "method": "GET",
      "path": "/users/:id/business-entity",
      "auth_required": false,
      "middleware": "optionalAuth",
      "response": {"success": true, "data": {"type": "venue|gallera|null", "entity": "Venue|Gallera object or null"}},
      "purpose": "Optimized endpoint to fetch business entity (Venue/Gallera) associated with a user without downloading full lists",
      "cache": "Redis 5 min TTL (300s)",
      "search_strategy": "First tries ownerId match, then searches by name in profileInfo.venueName/galleraName for backward compatibility",
      "note": "ADDED 2025-10-29: Replaces inefficient full list queries in Profile.tsx",
      "implementation": "backend/src/routes/users.ts:525-607",
      "frontend_usage": "frontend/src/pages/user/Profile.tsx:35-48 (useEffect hook)"
    },
    "create_user": {
      "method": "POST",
      "path": "/users",
      "body": {"username": "string", "email": "string", "password": "string", "role": "string ('admin'|'operator'|'venue'|'user'|'gallera')", "profileInfo": "object (optional - includes business fields for venue/gallera)"},
      "auth_required": true,
      "roles": ["admin", "operator"],
      "security": [
        "Only admins can create admin/operator roles",
        "Operators can only create venue/user/gallera roles"
      ],
      "note": "ADDED 2025-10-31: CreateUserModal now collects complete business info + images in single workflow. All admin pages unified with modal pattern."
    },
    "force_logout_user": {
      "method": "DELETE",
      "path": "/admin/sessions/:userId",
      "auth_required": true,
      "roles": ["admin"],
      "response": {"success": true, "message": "User sessions invalidated successfully", "userId": "string"},
      "purpose": "Force disconnect all sessions for a specific user (admin function)",
      "implementation": "backend/src/routes/admin-sessions.ts",
      "frontend_integration": {
        "component": "Admin user management pages now include disconnect button",
        "files": [
          "frontend/src/pages/admin/Users.tsx",
          "frontend/src/pages/admin/Venues.tsx",
          "frontend/src/pages/admin/Galleras.tsx"
        ],
        "behavior": "Removes all active sessions for the specified user, forcing immediate logout from all devices"
      },
      "added_date": "2025-11-20",
      "note": "Part of connection limit optimization to allow administrators to manage active sessions"
    },
    "update_user_password": {
      "method": "PUT",
      "path": "/users/:id/password",
      "body": {"password": "string"},
      "validation": {
        "password": "min 8 chars, 1 uppercase, 1 lowercase, 1 number"
      },
      "auth_required": true,
      "roles": ["admin", "operator"],
      "security": "Operators cannot modify admin/operator accounts",
      "added_by": "QWEN optimization - admin password management feature"
    },
    "update_user": {
      "method": "PUT",
      "path": "/users/:id",
      "body": {"role": "string (optional)", "isActive": "boolean (optional)"},
      "allowed_fields": ["role", "isActive"],
      "read_only_fields": ["username", "email", "profileInfo"],
      "auth_required": true,
      "roles": ["admin", "operator"],
      "security": [
        "Operators cannot modify admin/operator accounts",
        "âœ… ENFORCED 2025-10-19: Only 'role' and 'isActive' fields allowed, all other fields rejected",
        "Prevents unauthorized modification of profileInfo, username, or email via this endpoint"
      ]
    },
    "adjust_user_balance": {
      "method": "POST",
      "path": "/users/:userId/adjust-balance",
      "auth_required": true,
      "roles": ["admin"],
      "body": {
        "type": "'credit' | 'debit'",
        "amount": "number (positive)",
        "reason": "string (min 10, max 255 chars)"
      },
      "response": {"success": true, "message": "string", "data": {"user": "User object", "wallet": "Wallet object"}},
      "purpose": "Manually adjust user's wallet balance (admin only)",
      "validation": {
        "credit": "No balance check required, adds amount to wallet.balance",
        "debit": "Validates available balance: (balance - frozenAmount) >= amount",
        "frozenAmount": "CRITICAL (ADDED 2025-12-05): Locked funds from active bets. Debit requires sufficient AVAILABLE balance, not just total balance.",
        "error_example": "balance=$150, frozenAmount=$80, debit $100 â†’ ERROR (available=$70 < $100)"
      },
      "features": {
        "transactional": "Ensures atomicity with Sequelize transaction",
        "auditable": "Records adminId and reason in transaction metadata",
        "cache_invalidation": "Invalidates user profile cache",
        "decimal_handling": "CRITICAL: Uses parseFloat(String()) pattern for PostgreSQL DECIMAL fields"
      },
      "implementation": "backend/src/routes/users.ts:1042-1087",
      "transaction_types": {
        "credit": "Creates 'admin_credit' transaction",
        "debit": "Creates 'admin_debit' transaction"
      },
      "added_date": "2025-12-02",
      "updated_date": "2025-12-05 (added frozenAmount validation + DECIMAL string handling)"
    },
    "update_profile_info": {
      "method": "PUT",
      "path": "/users/:userId/profile-info",
      "body": {
        "description": "Partial update of User.profileInfo JSONB field",
        "venue_example": "{ venueName: string, venueLocation: string, venueDescription: string, venueEmail: string, venueWebsite: string, images: string[] }",
        "gallera_example": "{ galleraName: string, galleraLocation: string, galleraDescription: string, galleraEmail: string, galleraWebsite: string, galleraSpecialties: string[], galleraActiveRoosters: number, images: string[] }"
      },
      "auth_required": true,
      "roles": "admin, operator (for any user) OR authenticated user (for own profile only)",
      "authorization": {
        "admin_operator": "Can update any user's profileInfo",
        "regular_user": "Can only update own profileInfo (req.user.id === userId)",
        "validation": "backend/src/routes/users.ts:565-570"
      },
      "response": {
        "success": true,
        "data": {"user": "User object with updated profileInfo"}
      },
      "purpose": "Update profile information for venues and galleras (consolidated architecture)",
      "features": {
        "merge_behavior": "Merges provided fields with existing profileInfo (does not replace entire object)",
        "cache_invalidation": "Automatically invalidates Redis cache for user:${userId}:* pattern",
        "no_sync": "ðŸ”´ FASE 5: Does NOT sync to Venue/Gallera tables (tables eliminated 2025-11-04)"
      },
      "implementation": "backend/src/routes/users.ts:558-597",
      "frontend_usage": {
        "component": "UnifiedEntityForm.tsx",
        "api_method": "usersAPI.updateProfileInfo(userId, profileInfo)",
        "replaces": "Deprecated venuesAPI.update() and gallerasAPI.update() calls"
      },
      "added_date": "2025-11-04 (FASE 5 consolidation)",
      "note": "This endpoint consolidates venue/gallera profile updates into unified User.profileInfo architecture"
    }
  },

  "role_based_restrictions": {
    "betting_access": {
      "restriction_point": "backend/src/routes/bets.ts - Global middleware",
      "allowed_roles": ["user", "gallera"],
      "blocked_roles": ["admin", "operator", "venue"],
      "behavior": "Users with role 'venue' are blocked from betting endpoints with 403 Forbidden response",
      "message": "'Betting access denied - Your role cannot place bets'",
      "business_reason": "Venue users are event hosts, not bettors, preventing role conflicts",
      "added_date": "2025-11-07"
    },
    "wallet_access": {
      "restriction_point": "frontend/src/components/user/Navigation.tsx - Conditional rendering",
      "allowed_roles": ["user", "gallera"],
      "blocked_roles": ["admin", "operator", "venue"],
      "behavior": "Venue users don't see Wallet or Bets navigation items",
      "business_reason": "Venue users manage events, not personal finances or betting",
      "added_date": "2025-11-07"
    },
    "websocket_betting": {
      "restriction_point": "backend/src/sockets/bettingSocket.ts - Role validation in WebSocket handlers",
      "allowed_roles": ["user", "gallera"],
      "blocked_roles": ["admin", "operator", "venue"],
      "events_affected": ["create_pago_bet", "accept_pago_bet"],
      "behavior": "WebSocket emits error to client if user role is not allowed",
      "response": {"error": "Your role cannot place bets", "code": "ROLE_FORBIDDEN"},
      "business_reason": "Prevents venue users from participating in betting system as players",
      "added_date": "2025-11-07"
    },
    "approve_user": {
      "method": "PUT",
      "path": "/users/:id/approve",
      "auth_required": true,
      "roles": ["admin"],
      "body": {},
      "response": {"success": true, "message": "User approved successfully", "data": "user_object"},
      "purpose": "Approve a pending user account (venues/galleras) for use",
      "added_date": "2025-10-29",
      "note": "Sets user.approved = true. User was marked approved=false on registration."
    },
    "reject_user": {
      "method": "PUT",
      "path": "/users/:id/reject",
      "auth_required": true,
      "roles": ["admin"],
      "body": {"reason": "string (optional)"},
      "response": {"success": true, "message": "User rejected successfully", "data": "user_object"},
      "purpose": "Reject a pending user account and deactivate it",
      "added_date": "2025-10-29",
      "note": "Sets user.isActive = false and user.approved = false. TODO: Send rejection email to user."
    }
  }
}