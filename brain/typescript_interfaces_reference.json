{
  "metadata": {
    "purpose": "Optimized TypeScript interface reference for Galleros.Net platform",
    "version": "3.8.1",
    "last_updated": "2025-12-10",
    "changelog": "v3.8.1 (2025-12-10 later): CRITICAL FIX - Fixed all SSEEvent creation in backend/src/routes/events.ts to include required fields (id, timestamp, priority, metadata). Prevents SSE cleanup errors. v3.8 (2025-12-10): Added SSE service interface extensions with broadcastToEvent method and event-specific connection management. v3.7 (2025-12-05): Added comprehensive Wallet model interface documentation with PostgreSQL DECIMAL string serialization pattern (parseFloat(String()) usage). Documents critical frozenAmount logic and admin debit validation. v3.6 (2025-12-05): CRITICAL FIX - Wallet.create() now called automatically when admin creates users (backend/src/routes/users.ts:680-684). Fixes \"User wallet not found\" errors on balance adjustments. Added response.success check to handleAdjustBalance (frontend/src/components/admin/UserModal.tsx:117) to prevent modal closing on API errors. v3.5: Added admin_credit/admin_debit to Transaction type enum + PostgreSQL migration. Implemented admin balance adjustment feature in UserModal with ConfirmDialog integration.",
    "streaming_infrastructure": "Nginx RTMP (self-managed) + PostgreSQL local (OPTION B.1)",
    "required_environment_variables": {
      "VITE_STREAM_BASE_URL": "HLS stream base URL (Phase 1: Nginx, Phase 2: CDN)",
      "VITE_API_URL": "API base URL",
      "VITE_WS_URL": "WebSocket base URL"
    },
    "phase_2_bunny_cdn_readiness": "HLSPlayer component uses VITE_STREAM_BASE_URL environment variable (zero code changes needed for CDN switch)",
    "note": "Verified against backend database models and production deployment",
    "optimization_date": "2025-12-10 - Added SSE service extension interfaces and updated for broadcastToEvent method"
  },

  "quick_reference": {
    "core_interfaces": [
      "SSEEvent", "SSEEventType", "SSEConnection", "AdminChannel", "AlertItem", "LiveStats", "Fight", "Bet", "User", "UserSubscription", "UserSubscriptionWithExpiry"
    ],
    "admin_interfaces": [
      "MembershipChangeRequest", "EventConnection", "EventData", "Venue", "Article", "Gallera", "UserProfileWithSubscription"
    ],
    "wallet_interfaces": [
      "Wallet", "WalletOperation", "Transaction", "SystemSetting", "Bet_PAGO_DOY_Enhanced"
    ],
    "frontend_components": [
      "ImageGalleryUpload", "UnifiedEntityForm", "OptimizedStreamingMonitor"
    ],
    "hooks": [
      "useSSEConnection", "useUserForm", "useUserSubscription"
    ],
    "feature_flags": [
      "FeatureFlags"
    ]
  },

  "sse_service_extensions": {
    "SSEConnection": {
      "file": "/backend/src/services/sseService.ts",
      "description": "Extended interface for SSE connections with event-specific capabilities",
      "extends": "Base SSE connection with additional event-specific fields",
      "properties": {
        "id": "string - UUID of the connection",
        "res": "Response - Express response object for SSE stream",
        "channel": "string - Channel name (event-${eventId}, admin-bets, etc.)",
        "userId": "string (optional) - User ID if user is authenticated",
        "userRole": "string (optional) - User role for access control",
        "connectedAt": "Date - Timestamp when connection was established",
        "lastHeartbeat": "Date - Timestamp of last heartbeat sent",
        "lastActivity": "Date - Timestamp of last activity (connection or message)",
        "missedHeartbeats": "number - Count of missed heartbeats",
        "heartbeatInterval": "number - Current heartbeat interval in milliseconds",
        "connectionQuality": {
          "latency": "number - Round trip time in milliseconds",
          "lastEventSent": "Date - Timestamp of last event sent",
          "eventsPerMinute": "number - Calculated events per minute rate"
        },
        "isAlive": "boolean - Connection health status",
        "metadata": {
          "userAgent": "string (optional) - User agent string from client",
          "ip": "string (optional) - Client IP address",
          "eventFilters": "string[] (optional) - Filter criteria for events",
          "fightFilters": "string[] (optional) - Filter criteria for fights"
        }
      }
    },
    "SSEEvent": {
      "file": "/backend/src/services/sseService.ts",
      "description": "Interface for Server-Sent Events with extended type definitions for event-specific broadcasting",
      "required_properties": ["id", "type", "data", "timestamp", "priority"],
      "optional_properties": ["channel", "metadata"],
      "critical_note_2025_12_10": "ALL SSEEvent objects MUST include id, timestamp, and priority. SSE cleanup process calls timestamp.getTime() and will fail if timestamp is undefined. Fixed in events.ts lines 459, 547, 625, 691, 776.",
      "properties": {
        "id": "string - Unique identifier for the event",
        "type": "SSEEventType - Category of the event",
        "data": "any - Payload of the event",
        "timestamp": "Date - When the event was created",
        "channel": "string (optional) - Channel to broadcast to (derived for event-specific broadcasts)",
        "priority": "'low' | 'medium' | 'high' | 'critical' - Priority level for delivery",
        "metadata": {
          "userId": "string (optional) - Associated user ID",
          "eventId": "string (optional) - Associated event ID (critical for event-specific broadcasting)",
          "fightId": "string (optional) - Associated fight ID",
          "betId": "string (optional) - Associated bet ID",
          "adminId": "string (optional) - Admin ID if initiated by admin",
          "amount": "number (optional) - Associated monetary amount"
        }
      }
    },
    "SSEEventType": {
      "file": "/backend/src/services/sseService.ts",
      "description": "Enum of all possible SSE event types including event-specific updates",
      "values": [
        "SYSTEM_STATUS",
        "SYSTEM_MAINTENANCE",
        "DATABASE_PERFORMANCE",
        "STREAM_STATUS_UPDATE",
        "NOTIFICATION",
        "USER_NOTIFICATION",
        "FIGHT_STATUS_UPDATE",
        "FIGHT_CREATED",
        "FIGHT_UPDATED",
        "FIGHT_DELETED",
        "BETTING_WINDOW_OPENED",
        "BETTING_WINDOW_CLOSED",
        "NEW_BET",
        "BET_MATCHED",
        "BET_CANCELLED",
        "PAGO_PROPOSAL",
        "DOY_PROPOSAL",
        "PROPOSAL_ACCEPTED",
        "PROPOSAL_REJECTED",
        "PROPOSAL_TIMEOUT",
        "WALLET_TRANSACTION",
        "PAYMENT_PROCESSED",
        "PAYOUT_PROCESSED",
        "SUBSCRIPTION_UPDATED",
        "USER_REGISTERED",
        "USER_VERIFIED",
        "USER_BANNED",
        "ADMIN_ACTION",
        "STREAM_STARTED",
        "STREAM_ENDED",
        "STREAM_ERROR",
        "VIEWER_COUNT_UPDATE",
        "CONNECTION_ESTABLISHED",
        "HEARTBEAT",
        "ERROR"
      ]
    },
    "broadcastToEvent_method": {
      "implementation_file": "/backend/src/services/sseService.ts",
      "method_name": "broadcastToEvent",
      "parameters": {
        "eventId": "string - Unique identifier of the event to broadcast to",
        "event": "SSEEvent - The event object containing type, data, and metadata"
      },
      "return_type": "number - Count of successful connections that received the event",
      "functionality": "Broadcasts an SSE event to a specific event channel named `event-${eventId}`",
      "usage_example": {
        "typescript": "const sentCount = sseService.broadcastToEvent(eventId, {\n  id: randomUUID(),\n  type: SSEEventType.FIGHT_STATUS_UPDATE,\n  data: fightUpdateData,\n  timestamp: new Date(),\n  priority: 'high',\n  metadata: { eventId, fightId }\n});",
        "purpose": "Sending real-time updates (fight status changes, betting window changes, stream updates) to clients connected to a specific event channel"
      },
      "critical_note": "Creates a channel named `event-${eventId}` and broadcasts the event to all connected clients in that channel. Used extensively in events.ts for real-time updates to event participants.",
      "integration_points": [
        "backend/src/routes/events.ts - Lines 458, 540, 612, 671, 750 - Event status updates",
        "backend/src/services/eventService.ts - Line 100 - Event management service",
        "frontend/src/hooks/useSSEConnection.ts - Client-side connection to event channels"
      ],
      "added_date": "2025-12-10",
      "reviewed_against_codebase": true
    },
    "addEventConnection_method": {
      "implementation_file": "/backend/src/services/sseService.ts",
      "method_name": "addEventConnection",
      "parameters": {
        "res": "Response - Express response object for SSE stream",
        "eventId": "string - Unique identifier of the event to connect to",
        "userId": "string (optional) - User ID of connecting user",
        "userRole": "string (optional) - Role of connecting user for access control",
        "metadata": "any (optional) - Additional connection metadata"
      },
      "return_type": "string - The unique connection ID created",
      "functionality": "Creates a new SSE connection to a specific event channel named `event-${eventId}`",
      "usage_example": {
        "typescript": "const connectionId = sseService.addEventConnection(\n  response,\n  eventId,\n  req.user?.id,\n  req.user?.role,\n  { userAgent: req.get('User-Agent'), ip: req.ip }\n);",
        "purpose": "Allowing clients to establish real-time connections to receive updates for a specific event"
      },
      "critical_note": "Creates a channel named `event-${eventId}` for the connection. Used in event detail pages where users need real-time updates about specific events.",
      "integration_points": [
        "frontend/src/pages/user/LiveEvent.tsx - Connecting to event-specific updates",
        "frontend/src/components/admin/events/EventDetail.tsx - Admin event monitoring"
      ],
      "added_date": "2025-12-10",
      "reviewed_against_codebase": true
    }
  },

  "core_data_models": {
    "User": {
      "file": "/frontend/src/types/index.ts",
      "required_properties": ["id", "username", "email", "role", "isActive", "approved", "createdAt", "updatedAt"],
      "optional_properties": ["profileInfo", "lastLogin", "subscription", "wallet", "events"],
      "role_enum": ["admin", "operator", "venue", "user", "gallera"],
      "approval_system": {
        "approved_field": "boolean - NEW FIELD 2025-10-29",
        "default_value": "false for public registrations, true for admin-created users",
        "approval_logic": "Users with role='venue'|'gallera' and approved=false are blocked by middleware until admin approves",
        "middleware_check": "authenticate middleware checks approved status before allowing requests"
      },
      "profileInfo_structure": {
        "basic_fields": ["fullName", "phoneNumber", "address", "identificationNumber", "verificationLevel"],
        "image_fields": ["images?: string[] - ADDED 2025-10-31 - Max 2 for venues, max 3 for galleras"],
        "venue_fields": ["businessName", "venueName", "venueLocation", "venueDescription", "venueEmail", "venueWebsite"],
        "gallera_fields": ["galleraName", "galleraLocation", "galleraDescription", "galleraEmail", "galleraWebsite", "galleraSpecialties", "galleraActiveRoosters"],
        "extended_fields": ["location", "description", "establishedDate", "certified", "rating", "premiumLevel", "specialties", "imageUrl"]
      },
      "backend_sync": {
        "critical_note_2025_10_30": "CONSOLIDATED ARCHITECTURE - NO SYNC NEEDED",
        "architecture_note": "venues and galleras tables ELIMINATED. All data stored ONLY in User.profileInfo JSONB field. NO sync to dedicated tables (tables eliminated 2025-11-04)",
        "profile_data_location": "User.profileInfo (single source of truth)",
        "endpoint": "/users/profile (PUT) - updates User.profileInfo directly, no sync to other tables needed"
      }
    },
    "UserSubscription": {
      "file": "/frontend/src/types/index.ts",
      "required_properties": ["id", "plan", "status", "features"],
      "optional_properties": ["expiresAt", "manual_expires_at"],
      "status_enum": ["active", "cancelled", "expired", "pending"],
      "plan_types": ["free", "24-hour", "monthly"],
      "pricing": {
        "free": "$0 (default on expiration/cancellation)",
        "24-hour": "$5 (1 day access)",
        "monthly": "$10 (30 days access)"
      },
      "expiration_behavior": {
        "automatic_downgrade": "When expiresAt < current_timestamp, subscription automatically changes to 'free' type",
        "frontend_access_control": "Frontend components automatically restrict access to premium content when subscription expires",
        "middleware_validation": "authenticate middleware checks expiresAt on each request and enforces access restrictions",
        "immediate_effect": "Access restrictions take effect immediately when subscription expires without need for user logout/login"
      },
      "common_errors": [
        "Using 'type' instead of 'plan' property",
        "Missing 'id' property in form data",
        "Forgetting index signature for form compatibility"
      ]
    },
    "UserSubscriptionWithExpiry": {
      "file": "/frontend/src/types/index.ts",
      "extends": "UserSubscription",
      "additional_properties_for_frontend": ["expiresAt", "manual_expires_at", "current_status"],
      "computed_property": {
        "current_status": "Calculated property that combines status and expiresAt to determine if user has active access",
        "calculation": "status === 'active' && (expiresAt ? new Date(expiresAt) > new Date() : true) ? 'active_access' : 'limited_access'"
      },
      "frontend_usage": {
        "component": "/frontend/src/components/user/SubscriptionGuard.tsx",
        "purpose": "Component that hides/shows content based on subscription status",
        "access_control": "Blocks access to premium content when subscription expires"
      }
    }
  }
}