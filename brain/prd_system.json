{
  "business_context": {
    "company": "GalloBets",
    "product": "Plataforma de streaming profesional de peleas de gallos con apuestas P2P.",
    "mission": "Primera plataforma profesional de streaming + apuestas para galleras.",
    "timeline": "Sprint MVP de 15 días (7-21 de septiembre de 2025)",
    "revenue_model": [
      "Acceso a streaming basado en suscripción",
      "Tarifas de transacción en apuestas P2P (Post-MVP)",
      "Funciones premium para galleras/venues"
    ]
  },
  "stakeholders": {
    "primary_stakeholder": {
      "role": "Fundador/desarrollador único (veranoby)",
      "priorities": [
        "Entrega del MVP en 15 días",
        "Resolución del rendimiento de la base de datos",
        "Activación de la generación de ingresos",
        "Implementación del sistema de apuestas"
      ]
    },
    "user_segments": {
      "admins": {
        "capabilities": "Control total del sistema, todos los permisos",
        "needs": "Monitoreo en tiempo real, gestión de usuarios, análisis"
      },
      "operators": {
        "capabilities": "Herramientas de administración limitadas, gestión de eventos",
        "restrictions": "No pueden modificar usuarios administradores/operadores",
        "needs": "Gestión de eventos simplificada, controles de streaming"
      },
      "venues_galleras": {
        "capabilities": "Creación de eventos, gestión de perfiles, apuestas",
        "needs": "Configuración sencilla de streaming, seguimiento de ingresos"
      },
      "users": {
        "capabilities": "Ver transmisiones, realizar apuestas, gestionar billetera",
        "needs": "Transmisiones de calidad, apuestas fáciles, sistema justo"
      }
    }
  },
  "pain_points_prioritized": [
    {
      "pain_point": "Rendimiento de la base de datos (consultas de 1-3+ segundos)",
      "priority": "P0_CRITICAL",
      "impact": "Degradación de la experiencia del usuario, bloqueador para el lanzamiento.",
      "source_file": "brain/prd_system.json (risk_mitigation)"
    },
    {
      "pain_point": "Complejidad de integración de sistemas en tiempo real (SSE + WebSocket)",
      "priority": "P1",
      "impact": "Riesgo de errores, fugas de memoria y mantenimiento costoso.",
      "source_file": "brain/prd_system.json (risk_mitigation)"
    }
  ],
  "core_product_requirements": {
    "streaming_system": {
      "priority": "P0",
      "requirements": [
        "Ingesta de video vía RTMP desde OBS Studio.",
        "Entrega de video a espectadores vía HLS.",
        "Control de acceso basado en estado de suscripción del usuario."
      ]
    },
    "betting_system": {
      "priority": "P0",
      "requirements": [
        "Modelo de apuestas P2P (usuario contra usuario).",
        "Ventanas de apuestas temporales estrictas (solo se puede apostar en estado 'betting').",
        "Sistema de propuestas PAGO/DOY con timeout de 3 minutos vía WebSocket."
      ]
    },
    "subscription_system": {
      "priority": "P0",
      "requirements": [
        "Tiers: 24-horas ($5), mensual ($10), y gratis (por defecto/expirado).",
        "Flujo de solicitud de suscripción iniciado por el usuario con aprobación de admin.",
        "Expiración automática de suscripciones y revocación de acceso."
      ]
    },
    "user_workflows": {
      "event_creation": "Los Admins/Operadores pueden crear eventos y asignarlos a un 'venue' específico.",
      "betting": "Los usuarios pueden ver peleas, esperar la ventana de apuestas, y crear/aceptar apuestas P2P.",
      "operator": "Los operadores solo pueden gestionar los eventos que les son asignados y no pueden modificar otros admins/operadores."
    },
    "data_model_clarifications": {
      "events_and_venues": "Los eventos ocurren EN venues. `events.venue_id` apunta a un `user` con `role='venue'`.",
      "articles_and_authors": "Los artículos son escritos POR usuarios. `articles.author_id` apunta al creador. El campo `articles.venue_id` está obsoleto."
    }
  },
  "business_metrics": {
    "revenue_targets": {
      "month_1": { "subscribers": "25+", "revenue": "$500+" }
    },
    "platform_quality": [
      "99.5% de tiempo de actividad durante los eventos",
      "<500ms en consultas de base de datos",
      "<1s de latencia SSE"
    ]
  },

  "infrastructure_scaling_500_users": {
    "current_state": {
      "concurrent_users": "25-50",
      "monthly_cost": "$100-300 (VPS + Postgres + CDN)",
      "streaming_platform": "Nginx-RTMP (sufficient for current scale)"
    },
    "target_scale_500_concurrent_users": {
      "monthly_cost_range": "$2,100-5,300",
      "cost_drivers": [
        "CDN bandwidth: ~12 TB/hour for 500 viewers × 3 Mbps = 70-80% of costs",
        "Compute: API backend with SSE connection management = 10-15%",
        "Database: PostgreSQL with optimized pooling = 5-10%",
        "Monitoring: Real-time observability tools = 5%"
      ]
    },
    "infrastructure_tiers": {
      "tier_0_galloBets_OPTION_B1_payAsYouGrow": {
        "description": "SELECTED OPTION FOR GALLOBETS: Nginx RTMP + PostgreSQL local PERMANENT + Bunny CDN phased",
        "phases": {
          "phase_1_mvp": {
            "name": "MVP (Months 1-4, <500 concurrent users)",
            "duration_notes": "Usually achievable in first quarter post-launch",
            "architecture": "Dedicated Server + Nginx RTMP + PostgreSQL local + Video.js",
            "components": {
              "server": "Vultr/Hetzner Dedicated (8-core, 32GB RAM, 10Gbps, 500GB SSD)",
              "cost": "$155-195/month",
              "streaming_software": "Nginx + RTMP module (open source, free)",
              "database": "PostgreSQL 17 installed locally ($0, manual maintenance 30 min/week per postgresql-local-maintenance-manual.md)",
              "frontend": "Video.js (already integrated, HLS support)",
              "hls_generation": "Local: Nginx RTMP generates .m3u8 + .ts files directly"
            },
            "total_monthly": "$155-195/mo",
            "supports_concurrent": 500,
            "flow": "OBS → Nginx RTMP (local HLS generation) → Video.js (direct from server)",
            "performance_metrics": {
              "nginx_cpu": "150-200% (comfortable, 60% margin)",
              "postgresql_pool": "⚠️ At maximum 20 connections (monitor closely)",
              "disk_utilization": "28-46% used (safe)",
              "network_bandwidth": "750 Mbps 480p (comfortable)"
            },
            "monitoring_critical": "Start weekly monitoring via postgresql-local-maintenance-manual.md"
          },
          "phase_2_scaling": {
            "name": "Scaling (Months 5-6, 500-800 concurrent users)",
            "trigger_to_add_cdn": "When Nginx CPU >60% OR bandwidth >500 Mbps (Phase 1B)",
            "trigger_for_server_upgrade": "When CPU >70% sustained OR disk >80% full OR pool exhausted (Phase 2A)",
            "phase_2a_server_upgrade_path": {
              "decision_point": "Monitor CPU/disk during Phase 1 to predict timing",
              "server_upgrade": "Vultr/Hetzner Dedicated (16-core, 64GB RAM, 2TB SSD)",
              "cost_monthly": "$400-500/mo (server) + $108-216 (CDN) = $508-716/mo",
              "benefits": [
                "16 cores = 2× CPU headroom, CPU reaches only 50% under load",
                "64GB RAM = PostgreSQL unlimited performance",
                "2TB SSD = 12+ months of data growth before filling",
                "Eliminates connection pool bottleneck",
                "PostgreSQL local remains PERMANENT solution"
              ],
              "migration_effort": "2-4 hours (backup → restore → DNS switch)",
              "downtime": "< 30 minutes (planned maintenance window)",
              "flow": "OBS → Nginx RTMP (upgraded server, local HLS) → Bunny CDN → Video.js"
            },
            "phase_2b_pgbouncer_intermediate": {
              "description": "Optional: Add connection pooling WITHOUT full server upgrade",
              "cost_monthly": "$50-100/mo (separate VPS for pooling proxy)",
              "timeline": "If CPU still <70% but pool exhausted: quick PgBouncer fix (48h setup)",
              "limitations": [
                "Solves ONLY connection pool bottleneck",
                "Does NOT solve CPU saturation problem",
                "Does NOT solve disk space filling problem",
                "Extends current server to ~800 users max, still needs upgrade @ 1000 users"
              ],
              "when_to_use": "Unexpected spike before planned Phase 2A upgrade"
            },
            "phase_2c_revisit_neon": {
              "description": "Alternative path: Move PostgreSQL to Neon.tech (removes local database entirely)",
              "cost_monthly": "$155-195 (server) + $50-100 (Neon.tech) + $108-216 (CDN) = $313-511/mo",
              "trade_off": "$50-200/mo more expensive than local PostgreSQL, but:",
              "benefits": [
                "Eliminates 30 min/week PostgreSQL maintenance",
                "Gains 99.99% SLA + automatic failover + auto-scaling",
                "Scales to 1000+ users without server upgrade (Neon handles it)",
                "No disk space management on server",
                "Professional managed service"
              ],
              "decision_criteria": "If maintenance burden becomes issue OR if rapid growth beyond 800 users"
            }
          },
          "phase_3_maturity": {
            "name": "Mature Production (Month 12+, 1000+ concurrent users)",
            "recommended_infrastructure": "Upgraded server (16-core, 64GB, 2TB) + Bunny CDN + PostgreSQL local PERMANENT",
            "total_monthly": "$400-500 (server) + $108-216 (CDN) = $508-716/mo",
            "performance_at_1000_users": {
              "nginx_cpu": "300-400% (of 800%, comfortable 50% margin)",
              "postgresql_cpu": "400-500% (of 800%, tight but OK with 16-core)",
              "disk_utilization": "28-40% (2TB SSD provides 12+ months growth)",
              "connections_pool": "Database pool can be tuned to 50+ (not limited at 20)"
            },
            "optional_advanced_features": [
              "PostgreSQL replication (standby server for HA)",
              "Multiple Nginx RTMP instances with load balancing",
              "Elasticsearch for search/analytics (if needed)",
              "Prometheus + Grafana for advanced monitoring",
              "Kubernetes deployment (if multi-region scaling needed)"
            ],
            "annual_cost_at_1000_users": "$6,096-8,592/year (server + CDN)"
          }
        },
        "cost_comparison": {
          "opcion_b1_mvp_6months": "$155 × 6 = $930",
          "option_b2_neon_6months": "$230 × 6 = $1,380",
          "savings_b1_vs_b2": "$450 saved if you scale gradually",
          "note": "B1 costs more at scale (B1 Phase 3 > B2), but saves significantly if you grow slowly"
        },
        "technology_validation": {
          "nginx_rtmp": "✅ Open source (GitHub: arut/nginx-rtmp-module), used in Vimeo, production-ready",
          "video_js": "✅ Already integrated, supports HLS adaptive bitrate natively",
          "postgresql_local": "✅ Industry standard, manual maintenance 30 min/week only",
          "bunny_cdn": "✅ Caches HLS manifests + segments correctly (99% cache hit after 1 min)",
          "code_changes_required": "✅ Minimal: only .env URL updates, zero logic changes"
        }
      },
      "tier_1_basic_24h_$2100_3200_month": {
        "compute": "Vultr/Linode 4-core 8GB RAM = $24/month",
        "database": "Neon.tech PostgreSQL managed = $50-100/month",
        "streaming_ingest": "Ant Media Server open-source on VPS = $24/month",
        "cdn_distribution": "Bunny CDN HLS at $0.01/GB = $2,000-3,000/month",
        "monitoring": "Prometheus+Grafana self-hosted = $0-50/month",
        "suitable_for": "24h streaming, high-volume events (not GalloBets use case)"
      },
      "tier_2_production_$3400_5300_month": {
        "compute": "Load-balanced (2× c6i.xlarge EC2) = $300-400/month",
        "database": "Neon.tech with read replicas = $200-300/month",
        "streaming": "Wowza Cloud professional = $400-600/month",
        "cdn_distribution": "Bunny CDN + DDoS protection = $2,000-3,000/month",
        "monitoring": "DataDog or New Relic = $500-1,000/month",
        "suitable_for": "Revenue-generating production platform"
      },
      "tier_0_480p_galloBets_$205_month_RECOMMENDED": {
        "description": "GalloBets final recommended stack: 480p + pause optimization + Neon.tech",
        "rationale": "480p reduces bandwidth 50% vs 720p. Pause between fights saves 35-40% more. Total = most cost-effective for 2×/week, 6h sessions with 500 concurrent users",
        "compute": "Vultr 4-core 8GB RAM = $24/month",
        "database": "Neon.tech PostgreSQL managed = $50/month (includes auto-scaling, built-in backups, connection pooling)",
        "streaming_origin": "Ant Media Server on VPS = $24/month (open-source, handles pause/resume natively)",
        "cdn_distribution": "Bunny CDN HLS @ 480p = $108/month (0.01/GB × 10.8 TB/month with pause)",
        "monitoring": "Prometheus + Grafana self-hosted = $0-30/month",
        "total_monthly": "$206-236/month ✅ RECOMMENDED FOR GALLOBETS",
        "cost_breakdown": {
          "monthly_bandwidth_480p": "10.8 TB (2.7 TB/week × 4.3 weeks)",
          "cdn_cost_480p": "$108/month",
          "compute": "$24/month",
          "database": "$50/month",
          "origin": "$24/month",
          "monitoring": "$0-30/month",
          "total": "$206-236/month"
        },
        "annual_cost": "$2,472-2,832/year",
        "comparison_720p_with_pause": "720p would cost $339/month = $4,068/year (75% MORE expensive than 480p)",
        "quality_notes": "480p = 854×480 pixels sufficient for cockfighting detail (camera focused on birds). Fallback to 720p available for users >5 Mbps.",
        "savings_vs_24h_720p": "24/7 @ 720p = $2,100+/month. Scheduled 480p = $206-236/month. Savings = $21K-23K/year"
      },
      "tier_3_optimized_$500_800_month": {
        "compute": "Vultr 4-core = $24/month",
        "database": "Neon.tech = $50/month",
        "streaming_origin": "Ant Media Server = $24/month",
        "cdn_bandwidth": "Bunny CDN with off-peak cutoff = $400-700/month",
        "suitable_for": "Regional galleras with scheduled events (peak hours only, no 24h streaming)"
      }
    },
    "cost_optimization_strategies": [
      "✅ 480p streaming: Reduce bandwidth 50% vs 720p = $108/month CDN cost (vs $216 with 720p)",
      "✅ PAUSE/RESUME between fights: Reduce effective streaming 6h→4h = 35-40% bandwidth savings",
      "✅ Bunny CDN is 5× cheaper than CloudFront ($0.01/GB vs $0.085/month)",
      "✅ Scheduled streaming (2×/week) vs 24/7 = 94% cost savings ($205/mo vs $2,100+)",
      "✅ Off-peak cutoff: Stream only event hours, pause rest of day",
      "✅ Adaptive bitrate streaming (ABR): Reduce per-user bandwidth 20-30% (HLS.js handles client-side)",
      "✅ Origin-shield: Reduces origin bandwidth 30-50% (Bunny CDN native feature)",
      "✅ Neon.tech managed PostgreSQL: Connection pooling + auto-scaling + 99.99% uptime SLA",
      "✅ Connection pooling with PgBouncer: Reduce database overhead (Neon includes native pooling)"
    ],
    "real_world_cost_projection_galloBets": {
      "scenario": "2 sessions/week, 6 hours each, 500 concurrent users, WITH pause optimization + 480p",
      "bandwidth_calculations": {
        "720p_at_3mbps": {
          "per_hour": "500 viewers × 3 Mbps = 1.5 Gbps = 675 GB/hour",
          "per_session_6h": "4.05 TB per session (without pause)",
          "per_session_with_pause": "2.7 TB per session (4h effective with 2h pause between fights)"
        },
        "480p_at_1_5mbps": {
          "per_hour": "500 viewers × 1.5 Mbps = 750 Mbps = 337.5 GB/hour (50% reduction vs 720p)",
          "per_session_6h": "2.025 TB per session (without pause)",
          "per_session_with_pause": "1.35 TB per session (4h effective with 2h pause between fights)"
        }
      },
      "monthly_cost_720p_with_pause": {
        "weekly_bandwidth": "5.4 TB (2.7 TB × 2 sessions)",
        "monthly_bandwidth": "21.6 TB",
        "cdn_cost_bunny": "$216/month ($0.01/GB × 21.6 TB)",
        "compute_vultr": "$24/month",
        "database_neon": "$50/month",
        "origin_ant_media": "$24/month",
        "monitoring": "$0-30/month",
        "total_monthly": "$314-344/month",
        "annual_cost": "$3,768-4,128/year"
      },
      "monthly_cost_480p_with_pause_RECOMMENDED": {
        "weekly_bandwidth": "2.7 TB (1.35 TB × 2 sessions)",
        "monthly_bandwidth": "10.8 TB",
        "cdn_cost_bunny": "$108/month ($0.01/GB × 10.8 TB)",
        "compute_vultr": "$24/month",
        "database_neon": "$50/month",
        "origin_ant_media": "$24/month",
        "monitoring": "$0-30/month",
        "total_monthly": "$206-236/month ✅ FINAL RECOMMENDATION",
        "annual_cost": "$2,472-2,832/year"
      },
      "480p_vs_720p_savings": {
        "monthly_savings": "$108-138/month (50% CDN reduction)",
        "annual_savings": "$1,296-1,656/year",
        "total_vs_24h_720p": "24/7 @ 720p costs $2,100+/month. Scheduled 480p = $206-236/month. Total savings = $21K-23K/year"
      },
      "comparison_24h_streaming": "24h would cost $2,100-5,300/month = $25K-64K/year (9-25× more expensive than 480p scheduled)"
    },
    "critical_dependencies": [
      "Backend Performance Analysis (BACKEND_PERFORMANCE_ANALYSIS_PLAN) MUST complete before scaling to 500 users",
      "Memory leaks in SSE/WebSocket would cause exponential cost growth in production",
      "Database connection pooling MUST be optimized (currently max: 20, required: 100 for 500 users)"
    ]
  },
  "timeline_constraints": {
    "mvp_deadline": "21 de septiembre de 2025",
    "mvp_scope_included": [
      "Autenticación y roles",
      "Streaming RTMP/HLS",
      "Sistema de apuestas P2P básico",
      "Sistema de suscripción",
      "Dashboard de operador"
    ]
  },
  "cross_references_to_migrate": [
    {
      "informacion": "Detalles técnicos de la arquitectura (ej. estrategia SSE/WebSocket, ORM, etc.).",
      "ubicacion_original": "brain/prd_system.json (core_features.technical_architecture)",
      "destino_recomendado": "sdd_system.json"
    }
  ],
  "boundaries_and_cross_references": {
    "ssot_declaration": "Este archivo es la SSOT para los requisitos del producto, stakeholders y lógica de negocio.",
    "references": "Las decisiones de solución técnica detalladas se definen en `sdd_system.json`. Los objetivos de alto nivel se definen en `objectives_memory_index.json`."
  }
}