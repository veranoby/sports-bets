{
  "business_context": {
    "company": "Galleros.net",
    "product": "Plataforma de streaming profesional de peleas de gallos con apuestas P2P en tiempo real.",
    "mission": "Primera plataforma profesional de streaming + apuestas P2P para galleras en Latinoamérica.",
    "timeline": "Sprint MVP de 15 días (7-21 de septiembre de 2025)",
    "target_market": "México, Colombia, Perú y demás países de América Latina",
    "revenue_model": [
      "Acceso a streaming basado en suscripción (24h: $5, mensual: $10)",
      "Comisión 5% sobre ganador en apuestas P2P",
      "Funciones premium para galleras/venues"
    ]
  },
  "stakeholders": {
    "primary_stakeholder": {
      "role": "Fundador/desarrollador único (veranoby)",
      "priorities": [
        "Entrega del MVP en 15 días",
        "Resolución del rendimiento de la base de datos",
        "Activación de la generación de ingresos",
        "Implementación del sistema de apuestas"
      ]
    },
    "user_segments": {
      "admins": {
        "capabilities": "Control total del sistema, todos los permisos",
        "needs": "Monitoreo en tiempo real, gestión de usuarios, análisis"
      },
      "operators": {
        "capabilities": "Herramientas de administración limitadas, gestión de eventos",
        "restrictions": "No pueden modificar usuarios administradores/operadores",
        "needs": "Gestión de eventos simplificada, controles de streaming"
      },
      "venues_galleras": {
        "capabilities": "Creación de eventos, gestión de perfiles, apuestas",
        "needs": "Configuración sencilla de streaming, seguimiento de ingresos"
      },
      "users": {
        "capabilities": "Ver transmisiones, realizar apuestas, gestionar billetera",
        "needs": "Transmisiones de calidad, apuestas fáciles, sistema justo"
      }
    }
  },
  "pain_points_prioritized": [
    {
      "pain_point": "Rendimiento de la base de datos (consultas de 1-3+ segundos)",
      "priority": "P0_CRITICAL",
      "impact": "Degradación de la experiencia del usuario, bloqueador para el lanzamiento.",
      "source_file": "brain/prd_system.json (risk_mitigation)"
    },
    {
      "pain_point": "Complejidad de integración de sistemas en tiempo real (SSE + WebSocket)",
      "priority": "P1",
      "impact": "Riesgo de errores, fugas de memoria y mantenimiento costoso.",
      "source_file": "brain/prd_system.json (risk_mitigation)"
    }
  ],
  "core_product_requirements": {
    "streaming_system": {
      "priority": "P0",
      "requirements": [
        "Ingesta de video vía RTMP desde OBS Studio.",
        "Entrega de video a espectadores vía HLS.",
        "Control de acceso basado en estado de suscripción del usuario."
      ]
    },
    "betting_system": {
      "priority": "P0",
      "requirements": [
        "Modelo de apuestas P2P (usuario contra usuario).",
        "Ventanas de apuestas temporales estrictas (solo se puede apostar en estado 'betting').",
        "Sistema de propuestas PAGO/DOY con timeout de 3 minutos vía WebSocket."
      ],
      "bet_types": {
        "flat": "Apuesta simétrica: $50 vs $50. Auto-match si existe contraparte.",
        "doy": "Ofrece ventaja: Gana $40, Pierde $50. Ventaja unilateral visible para contrarios.",
        "pago": "Propuesta respuesta: Propone pagar $40 si pierde, cobra $50 si gana. Requiere aceptación."
      },
      "workflows": {
        "flat_auto_match": "Usuario crea flat $50 rojo → Sistema detecta flat $50 azul → Auto-empareja → Estado: active",
        "flat_manual_accept": "Usuario crea flat $50 rojo → Usuario2 ve sugerencia → Acepta → Estado: active",
        "doy_creation": "Usuario crea DOY: Apuesta $50, DOY $40 (ventaja) → Visible en panel → Usuario2 acepta → Estado: active",
        "pago_proposal": "Usuario1 flat $50 rojo → Usuario2 propone PAGO $40 → Usuario1 recibe notificación → Acepta/Rechaza",
        "panel_sugerencias": "Al escribir monto, mostrar apuestas contrarias en rango ±20% (ej: $40-$60 si escribió $50)"
      },
      "estados_apuestas": {
        "pending": "Creada, editable, visible en panel sugerencias. frozen_amount NO bloqueado aún.",
        "pending_pago": "Propuesta PAGO enviada, esperando aceptación/rechazo de usuario original.",
        "active": "Confirmada por ambos, frozen_amount bloqueado. No editable.",
        "completed": "Pelea terminada, resultado aplicado, frozen_amount liberado/transferido.",
        "cancelled": "Cancelada antes de match por usuario o sistema."
      },
      "business_rules": {
        "comision": "5% del ganador (no del perdedor). Ejemplo: gana $50 → cobra $47.50.",
        "empate": "Devolver frozen_amount completo a ambos apostadores.",
        "fight_cancelada": "Devolver frozen_amount completo a ambos apostadores (igual que empate).",
        "edicion": "Solo editable si status=pending. Bloqueada si active.",
        "multiple_bets_per_user": "Un usuario puede tener múltiples apuestas activas en mismo evento/pelea.",
        "auto_match_only_flat": "Auto-match solo para flat. DOY y PAGO requieren aceptación manual."
      }
    },
    "subscription_system": {
      "priority": "P0",
      "requirements": [
        "Tiers: 24-horas ($5), mensual ($10), y gratis (por defecto/expirado).",
        "Flujo de solicitud de suscripción iniciado por el usuario con aprobación de admin.",
        "Expiración automática de suscripciones y revocación de acceso."
      ]
    },
    "user_workflows": {
      "event_creation": "Los Admins/Operadores pueden crear eventos y asignarlos a un 'venue' específico.",
      "betting": "Los usuarios pueden ver peleas, esperar la ventana de apuestas, y crear/aceptar apuestas P2P.",
      "operator": "Los operadores solo pueden gestionar los eventos que les son asignados y no pueden modificar otros admins/operadores."
    },
    "data_model_clarifications": {
      "events_and_venues": "Los eventos ocurren EN venues. `events.venue_id` apunta a un `user` con `role='venue'`.",
      "articles_and_authors": "Los artículos son escritos POR usuarios. `articles.author_id` apunta al creador. El campo `articles.venue_id` está obsoleto."
    }
  },
  "business_metrics": {
    "revenue_targets": {
      "month_1": { "subscribers": "25+", "revenue": "$500+" }
    },
    "platform_quality": [
      "99.5% de tiempo de actividad durante los eventos",
      "<500ms en consultas de base de datos",
      "<1s de latencia SSE"
    ]
  },

  "infrastructure_scaling_500_users": {
    "current_state": {
      "concurrent_users": "25-50",
      "monthly_cost": "$100-300 (VPS + Postgres + CDN)",
      "streaming_platform": "Nginx-RTMP (sufficient for current scale)"
    },
    "target_scale_500_concurrent_users": {
      "monthly_cost_range": "$2,100-5,300",
      "cost_drivers": [
        "CDN bandwidth: ~12 TB/hour for 500 viewers × 3 Mbps = 70-80% of costs",
        "Compute: API backend with SSE connection management = 10-15%",
        "Database: PostgreSQL with optimized pooling = 5-10%",
        "Monitoring: Real-time observability tools = 5%"
      ]
    },
    "infrastructure_tiers": {
      "tier_0_galleros_net_OPTION_FINAL_2025": {
        "description": "SELECTED OPTION FOR GALLEROS.NET: Hetzner AX42 + PostgreSQL local + CloudFront CDN phased",
        "decision_rationale": "Hetzner ofrece tráfico ilimitado gratis (absorbe 11.6 TB/mes sin cargos extra) + CloudFront tiene edge en LATAM (São Paulo, México, Colombia) con latencia <50ms a usuarios",
        "phases": {
          "phase_1_mvp": {
            "name": "MVP (Months 1-4, 0-500 concurrent users)",
            "duration_notes": "Usually achievable in first quarter post-launch",
            "architecture": "Hetzner Dedicated + Nginx RTMP + PostgreSQL local + CloudFront CDN + Video.js",
            "components": {
              "server": "Hetzner AX42 (AMD Ryzen 7 Pro 8700GE, 8-core, 64GB DDR5 RAM, 2×512GB NVMe, 1Gbps unlimited traffic)",
              "server_location": "Germany (Falkenstein or Nuremberg datacenter)",
              "operating_system": "Ubuntu Server 24.04 LTS (5 years support until 2029, extendible to 10 years)",
              "cost": "€46/month (~$50 USD)",
              "cdn": "AWS CloudFront with edge locations in São Paulo (Brazil), Mexico City, Bogotá (Colombia)",
              "cdn_cost": "$102/month (12 TB × $0.085/GB bandwidth)",
              "streaming_software": "Nginx + RTMP module (open source, compiled from source)",
              "database": "PostgreSQL 18 installed locally ($0, manual maintenance 30 min/week per postgresql-local-maintenance-manual.md)",
              "frontend": "Video.js (already integrated, HLS.js adaptive bitrate)",
              "hls_generation": "Local: Nginx RTMP generates .m3u8 + .ts files in /var/www/hls/",
              "hls_distribution": "CloudFront Pull Origin caches from Hetzner, serves LATAM users <50ms latency"
            },
            "total_monthly": "$152/mo ($50 server + $102 CDN)",
            "budget_remaining": "$98/mo for monitoring, backups, contingencies",
            "supports_concurrent": 500,
            "flow": "OBS → Hetzner Nginx-RTMP (Germany) → HLS generation → CloudFront edge (LATAM) → Video.js playback",
            "performance_metrics": {
              "nginx_cpu": "150-200% (comfortable, 60% margin)",
              "postgresql_pool": "⚠️ At maximum 20 connections (monitor closely)",
              "disk_utilization": "28-46% used (safe)",
              "network_bandwidth": "750 Mbps 480p (comfortable)"
            },
            "monitoring_critical": "Start weekly monitoring via postgresql-local-maintenance-manual.md"
          },
          "phase_2_scaling": {
            "name": "Scaling (Months 5-8, 500-800 concurrent users)",
            "trigger_for_server_upgrade": "When CPU >70% sustained OR disk >80% full OR PostgreSQL pool exhausted",
            "note_cdn_already_active": "CloudFront CDN activated in Phase 1, no additional trigger needed",
            "phase_2a_server_upgrade_path": {
              "decision_point": "Monitor CPU/disk during Phase 1 via weekly postgresql-local-maintenance-manual.md checks",
              "server_upgrade": "Hetzner AX102 (AMD Ryzen 9 7950X3D, 16-core, 128GB DDR5 RAM, 2×1.92TB NVMe)",
              "upgrade_method": "Contact Hetzner support via Robot panel for migration assistance",
              "cost_monthly": "€150/mo (~$165 USD server) + $102-197 (CloudFront CDN) = $267-362/mo",
              "benefits": [
                "16 cores = 2× CPU headroom for 1000 concurrent users, CPU reaches only 50% under peak load",
                "128GB RAM (not 64GB) = PostgreSQL optimal performance with large connection pools",
                "3.84TB total storage (2×1.92TB NVMe) = 12+ months of data growth without disk pressure",
                "Eliminates connection pool bottleneck (can tune to 50+ connections)",
                "PostgreSQL local remains PERMANENT solution (no migration to cloud DB needed)",
                "Same Hetzner infrastructure (Germany) with unlimited traffic"
              ],
              "migration_effort": "3-5 hours (pg_dump → transfer → pg_restore → DNS switch → CloudFront origin update)",
              "downtime": "< 30 minutes (planned maintenance window, announce 48h in advance)",
              "flow": "OBS → Hetzner AX102 Nginx-RTMP (Germany) → HLS generation → CloudFront edge (LATAM) → Video.js"
            },
            "phase_2b_pgbouncer_intermediate": {
              "description": "Optional: Add connection pooling WITHOUT full server upgrade",
              "cost_monthly": "$50-100/mo (separate VPS for pooling proxy)",
              "timeline": "If CPU still <70% but pool exhausted: quick PgBouncer fix (48h setup)",
              "limitations": [
                "Solves ONLY connection pool bottleneck",
                "Does NOT solve CPU saturation problem",
                "Does NOT solve disk space filling problem",
                "Extends current server to ~800 users max, still needs upgrade @ 1000 users"
              ],
              "when_to_use": "Unexpected spike before planned Phase 2A upgrade"
            },
            "phase_2c_revisit_neon": {
              "description": "Alternative path: Move PostgreSQL to Neon.tech (removes local database entirely)",
              "cost_monthly": "$155-195 (server) + $50-100 (Neon.tech) + $108-216 (CDN) = $313-511/mo",
              "trade_off": "$50-200/mo more expensive than local PostgreSQL, but:",
              "benefits": [
                "Eliminates 30 min/week PostgreSQL maintenance",
                "Gains 99.99% SLA + automatic failover + auto-scaling",
                "Scales to 1000+ users without server upgrade (Neon handles it)",
                "No disk space management on server",
                "Professional managed service"
              ],
              "decision_criteria": "If maintenance burden becomes issue OR if rapid growth beyond 800 users"
            }
          },
          "phase_3_maturity": {
            "name": "Mature Production (Month 12+, 1000+ concurrent users)",
            "recommended_infrastructure": "Hetzner AX102 (16-core, 128GB, 3.84TB) + CloudFront CDN + PostgreSQL local PERMANENT",
            "total_monthly": "$165 (AX102 server) + $197 (CloudFront 23.2 TB) = $362/mo",
            "bandwidth_at_1000_users": "23.2 TB/month (1000 users × 1.5 Mbps × 4h effective × 8.6 events)",
            "performance_at_1000_users": {
              "nginx_cpu": "300-400% (of 1600% available with 16 cores, comfortable 50% margin)",
              "postgresql_cpu": "400-500% (of 1600%, tight but OK with 128GB RAM)",
              "disk_utilization": "28-40% (3.84TB provides 18+ months growth)",
              "connections_pool": "Database pool tuned to 50-100 connections (128GB RAM allows this)"
            },
            "optional_advanced_features": [
              "PostgreSQL replication to standby Hetzner server for HA (~€50/mo extra)",
              "Multiple Nginx RTMP instances with HAProxy load balancing",
              "Redis Cluster for advanced caching (3-node setup)",
              "Prometheus + Grafana for advanced monitoring (self-hosted)",
              "Multi-region CloudFront with Route53 failover"
            ],
            "annual_cost_at_1000_users": "$4,344/year ($362 × 12 months)",
            "budget_note": "Exceeds initial $250/mo budget, requires budget increase to $400/mo or quality reduction to 360p (reduces CDN 50%)"
          }
        },
        "cost_comparison": {
          "opcion_b1_mvp_6months": "$155 × 6 = $930",
          "option_b2_neon_6months": "$230 × 6 = $1,380",
          "savings_b1_vs_b2": "$450 saved if you scale gradually",
          "note": "B1 costs more at scale (B1 Phase 3 > B2), but saves significantly if you grow slowly"
        },
        "technology_validation": {
          "nginx_rtmp": "✅ Open source (GitHub: arut/nginx-rtmp-module), used in Vimeo, production-ready",
          "video_js": "✅ Already integrated, supports HLS adaptive bitrate natively",
          "postgresql_local": "✅ Industry standard, manual maintenance 30 min/week only",
          "bunny_cdn": "✅ Caches HLS manifests + segments correctly (99% cache hit after 1 min)",
          "code_changes_required": "✅ Minimal: only .env URL updates, zero logic changes"
        }
      },
      "tier_1_basic_24h_$2100_3200_month": {
        "compute": "Vultr/Linode 4-core 8GB RAM = $24/month",
        "database": "Neon.tech PostgreSQL managed = $50-100/month",
        "streaming_ingest": "Ant Media Server open-source on VPS = $24/month",
        "cdn_distribution": "Bunny CDN HLS at $0.01/GB = $2,000-3,000/month",
        "monitoring": "Prometheus+Grafana self-hosted = $0-50/month",
        "suitable_for": "24h streaming, high-volume events (not Galleros.Net use case)"
      },
      "tier_2_production_$3400_5300_month": {
        "compute": "Load-balanced (2× c6i.xlarge EC2) = $300-400/month",
        "database": "Neon.tech with read replicas = $200-300/month",
        "streaming": "Wowza Cloud professional = $400-600/month",
        "cdn_distribution": "Bunny CDN + DDoS protection = $2,000-3,000/month",
        "monitoring": "DataDog or New Relic = $500-1,000/month",
        "suitable_for": "Revenue-generating production platform"
      },
      "tier_0_480p_galloBets_$205_month_RECOMMENDED": {
        "description": "Galleros.Net final recommended stack: 480p + pause optimization + Neon.tech",
        "rationale": "480p reduces bandwidth 50% vs 720p. Pause between fights saves 35-40% more. Total = most cost-effective for 2×/week, 6h sessions with 500 concurrent users",
        "compute": "Vultr 4-core 8GB RAM = $24/month",
        "database": "Neon.tech PostgreSQL managed = $50/month (includes auto-scaling, built-in backups, connection pooling)",
        "streaming_origin": "Ant Media Server on VPS = $24/month (open-source, handles pause/resume natively)",
        "cdn_distribution": "Bunny CDN HLS @ 480p = $108/month (0.01/GB × 10.8 TB/month with pause)",
        "monitoring": "Prometheus + Grafana self-hosted = $0-30/month",
        "total_monthly": "$206-236/month ✅ RECOMMENDED FOR GALLOBETS",
        "cost_breakdown": {
          "monthly_bandwidth_480p": "10.8 TB (2.7 TB/week × 4.3 weeks)",
          "cdn_cost_480p": "$108/month",
          "compute": "$24/month",
          "database": "$50/month",
          "origin": "$24/month",
          "monitoring": "$0-30/month",
          "total": "$206-236/month"
        },
        "annual_cost": "$2,472-2,832/year",
        "comparison_720p_with_pause": "720p would cost $339/month = $4,068/year (75% MORE expensive than 480p)",
        "quality_notes": "480p = 854×480 pixels sufficient for cockfighting detail (camera focused on birds). Fallback to 720p available for users >5 Mbps.",
        "savings_vs_24h_720p": "24/7 @ 720p = $2,100+/month. Scheduled 480p = $206-236/month. Savings = $21K-23K/year"
      },
      "tier_3_optimized_$500_800_month": {
        "compute": "Vultr 4-core = $24/month",
        "database": "Neon.tech = $50/month",
        "streaming_origin": "Ant Media Server = $24/month",
        "cdn_bandwidth": "Bunny CDN with off-peak cutoff = $400-700/month",
        "suitable_for": "Regional galleras with scheduled events (peak hours only, no 24h streaming)"
      }
    },
    "cost_optimization_strategies": [
      "✅ 480p streaming: Reduce bandwidth 50% vs 720p = $108/month CDN cost (vs $216 with 720p)",
      "✅ PAUSE/RESUME between fights: Reduce effective streaming 6h→4h = 35-40% bandwidth savings",
      "✅ Bunny CDN is 5× cheaper than CloudFront ($0.01/GB vs $0.085/month)",
      "✅ Scheduled streaming (2×/week) vs 24/7 = 94% cost savings ($205/mo vs $2,100+)",
      "✅ Off-peak cutoff: Stream only event hours, pause rest of day",
      "✅ Adaptive bitrate streaming (ABR): Reduce per-user bandwidth 20-30% (HLS.js handles client-side)",
      "✅ Origin-shield: Reduces origin bandwidth 30-50% (Bunny CDN native feature)",
      "✅ Neon.tech managed PostgreSQL: Connection pooling + auto-scaling + 99.99% uptime SLA",
      "✅ Connection pooling with PgBouncer: Reduce database overhead (Neon includes native pooling)"
    ],
    "real_world_cost_projection_galloBets": {
      "scenario": "2 sessions/week, 6 hours each, 500 concurrent users, WITH pause optimization + 480p",
      "bandwidth_calculations": {
        "720p_at_3mbps": {
          "per_hour": "500 viewers × 3 Mbps = 1.5 Gbps = 675 GB/hour",
          "per_session_6h": "4.05 TB per session (without pause)",
          "per_session_with_pause": "2.7 TB per session (4h effective with 2h pause between fights)"
        },
        "480p_at_1_5mbps": {
          "per_hour": "500 viewers × 1.5 Mbps = 750 Mbps = 337.5 GB/hour (50% reduction vs 720p)",
          "per_session_6h": "2.025 TB per session (without pause)",
          "per_session_with_pause": "1.35 TB per session (4h effective with 2h pause between fights)"
        }
      },
      "monthly_cost_720p_with_pause": {
        "weekly_bandwidth": "5.4 TB (2.7 TB × 2 sessions)",
        "monthly_bandwidth": "21.6 TB",
        "cdn_cost_bunny": "$216/month ($0.01/GB × 21.6 TB)",
        "compute_vultr": "$24/month",
        "database_neon": "$50/month",
        "origin_ant_media": "$24/month",
        "monitoring": "$0-30/month",
        "total_monthly": "$314-344/month",
        "annual_cost": "$3,768-4,128/year"
      },
      "monthly_cost_480p_with_pause_RECOMMENDED": {
        "weekly_bandwidth": "2.7 TB (1.35 TB × 2 sessions)",
        "monthly_bandwidth": "10.8 TB",
        "cdn_cost_bunny": "$108/month ($0.01/GB × 10.8 TB)",
        "compute_vultr": "$24/month",
        "database_neon": "$50/month",
        "origin_ant_media": "$24/month",
        "monitoring": "$0-30/month",
        "total_monthly": "$206-236/month ✅ FINAL RECOMMENDATION",
        "annual_cost": "$2,472-2,832/year"
      },
      "480p_vs_720p_savings": {
        "monthly_savings": "$108-138/month (50% CDN reduction)",
        "annual_savings": "$1,296-1,656/year",
        "total_vs_24h_720p": "24/7 @ 720p costs $2,100+/month. Scheduled 480p = $206-236/month. Total savings = $21K-23K/year"
      },
      "comparison_24h_streaming": "24h would cost $2,100-5,300/month = $25K-64K/year (9-25× more expensive than 480p scheduled)"
    },
    "critical_dependencies": [
      "Backend Performance Analysis (BACKEND_PERFORMANCE_ANALYSIS_PLAN) MUST complete before scaling to 500 users",
      "Memory leaks in SSE/WebSocket would cause exponential cost growth in production",
      "Database connection pooling MUST be optimized (currently max: 20, required: 100 for 500 users)"
    ]
  },
  "timeline_constraints": {
    "mvp_deadline": "21 de septiembre de 2025",
    "mvp_scope_included": [
      "Autenticación y roles",
      "Streaming RTMP/HLS",
      "Sistema de apuestas P2P básico",
      "Sistema de suscripción",
      "Dashboard de operador"
    ]
  },
  "technical_operations": {
    "email_notifications": {
      "feature": "User registration email verification + admin transactional emails",
      "implementation": "Postfix + Dovecot (local) + nodemailer backend",
      "setup": "3 admin accounts: admin@, support@, operator@galleros.net (no external costs)",
      "reference": "sdd_system.json:email_configuration"
    },
    "push_notifications": {
      "feature": "Real-time push alerts for betting windows, fight results, PAGO proposals",
      "implementation": "Web Push API + VAPID keys (already in backend/src/routes/push.ts)",
      "setup": "Generate VAPID keys once + add VAPID_PUBLIC_KEY, VAPID_PRIVATE_KEY to .env",
      "reference": "sdd_system.json:production_deployment_and_operations (monitoring section)"
    },
    "deployment_and_administration": {
      "ssh_access": "SSH key authentication (no password) - trivial setup",
      "deployment_strategy": "git pull + deploy.sh script OR GitHub Actions (recommended)",
      "structure": "Monorepo frontend/backend works with git pull directly",
      "reference": "sdd_system.json:deployment_workflow_from_github"
    }
  },
  "cross_references_to_migrate": [
    {
      "informacion": "Detalles técnicos de la arquitectura (ej. estrategia SSE/WebSocket, ORM, etc.).",
      "ubicacion_original": "brain/prd_system.json (core_features.technical_architecture)",
      "destino_recomendado": "sdd_system.json"
    }
  ],
  "boundaries_and_cross_references": {
    "ssot_declaration": "Este archivo es la SSOT para los requisitos del producto, stakeholders y lógica de negocio.",
    "references": "Las decisiones de solución técnica detalladas se definen en `sdd_system.json`. Los objetivos de alto nivel se definen en `objectives_memory_index.json`."
  }
}