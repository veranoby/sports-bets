{
  "technical_architecture": {
    "database_layer": {
      "primary_database": {
        "type": "PostgreSQL",
        "hosting": "Neon.tech",
        "version": "PostgreSQL 17.5",
        "rationale": "Managed PostgreSQL con excelente rendimiento y escalabilidad.",
        "connection_management": "Sequelize ORM con pooling optimizado.",
        "production_status": {
          "query_performance": "‚úÖ OPTIMIZADO - Objetivo <500ms logrado.",
          "connection_pool": "‚úÖ CONFIGURADO - 20 max, 5 min conexiones.",
          "connection_errors": "‚úÖ RESUELTO - No hay ETIMEDOUT en producci√≥n.",
          "environment": "‚úÖ PRODUCCI√ìN - Secretos JWT y env configurados."
        }
      },
      "performance_optimizations": {
        "P0_critical": [
          "Optimizaci√≥n de √≠ndices para consultas lentas",
          "Ajuste de configuraci√≥n del pool de conexiones",
          "Caching de consultas para datos calientes",
          "Implementaci√≥n de carga perezosa"
        ],
        "success_metrics": [
          "95% de consultas <500ms",
          "Cero ETIMEDOUT en producci√≥n",
          "Pool de conexiones estable"
        ]
      }
    },
    "backend_architecture": {
      "framework": "Node.js + Express + TypeScript",
      "orm": "Sequelize",
      "authentication": "JWT con control de acceso basado en roles",
      "real_time_architecture": {
        "strategy": "H√≠brido SSE + WebSocket M√≠nimo",
        "status": "‚úÖ IMPLEMENTADO - Servicio SSE listo para producci√≥n con 8 canales de administraci√≥n.",
        "sse_usage": [
          "Actualizaciones en tiempo real de administraci√≥n (IMPLEMENTADO)",
          "Monitoreo del sistema (IMPLEMENTADO)",
          "Actualizaciones de apuestas y notificaciones (IMPLEMENTADO)",
          "Cambios de estado de peleas (IMPLEMENTADO)",
          "Suscripciones a eventos (IMPLEMENTADO)"
        ],
        "websocket_usage": [
          "SOLO para propuestas PAGO/DOY",
          "Bidireccional con timeout de 3 minutos",
          "No operaciones de billetera",
          "No sugerencias din√°micas"
        ],
        "rationale": "Simplicidad de SSE para la mayor√≠a de las necesidades en tiempo real, WebSocket solo donde se requiere bidireccionalidad."
      },
      "api_design": "RESTful con suplementos SSE"
    },
    "frontend_architecture": {
      "framework": "React + TypeScript",
      "state_management": "React Context + hooks",
      "routing": "React Router con protecci√≥n basada en roles",
      "styling": "Tailwind CSS",
      "build_system": "Vite",
      "real_time_integration": {
        "useSSE_hook": "Hook personalizado con l√≥gica de reconexi√≥n",
        "event_source": "Reintento autom√°tico con retroceso exponencial",
        "websocket_minimal": "Solo para propuestas PAGO/DOY"
      }
    },
    "streaming_infrastructure": {
      "protocol": "Entrada RTMP + Salida HLS (LL-HLS para baja latencia)",
      "integration": "OBS Studio + Claves de streaming",
      "mvp_solution": {
        "platform": "Nginx-RTMP en VPS",
        "capacity": "25-50 espectadores concurrentes",
        "cost": "$24-50/month (compute) + $50-100/month (bandwidth CDN)"
      },
      "selected_solution_option_b1": {
        "description": "OPTION B.1: Nginx RTMP (self-managed) + PostgreSQL local + optional Bunny CDN",
        "phase_1_mvp_0_to_500_concurrent": {
          "components": {
            "ingestion": "OBS Studio (broadcaster encodes to 480p)",
            "streaming_server": "Nginx + RTMP module (generates HLS locally)",
            "hls_generation": "Nginx RTMP creates manifest (.m3u8) + segments (.ts) in /var/www/hls/",
            "hls_delivery": "HTTP from Nginx directly (no CDN yet)",
            "playback": "Video.js with HLS.js (adaptive bitrate)",
            "database": "PostgreSQL 17 local (self-hosted, 30 min/week maintenance)"
          },
          "cost": "$155-195/month (dedicated server only)",
          "endpoints_unchanged": [
            "POST /api/streaming/start",
            "POST /api/streaming/stop",
            "POST /api/streaming/pause",
            "POST /api/streaming/resume",
            "GET /api/streaming/status"
          ],
          "config_changes_required": {
            "backend_env": "STREAM_SERVER_URL=rtmp://nginx-server.com:1935/live | CDN_URL=http://nginx-server.com",
            "frontend_env": "VITE_STREAM_BASE_URL=http://nginx-server.com/hls"
          },
          "nginx_config": "User provides custom nginx.conf with rtmp block ‚Üí HLS output to /var/www/hls/"
        },
        "phase_2_scaling_500_to_1000_concurrent": {
          "trigger": "When Nginx CPU >60% OR bandwidth >500 Mbps",
          "change": "Add Bunny CDN Pull Zone (transparent cache layer)",
          "components": {
            "streaming_server": "Nginx RTMP (unchanged, still generates HLS locally)",
            "hls_delivery": "Bunny CDN (caches manifest + segments, serves globally)",
            "playback": "Video.js (now fetches from Bunny instead of Nginx)"
          },
          "cost_addition": "+$108-216/month (Bunny CDN)",
          "total_monthly": "$263-411/mo",
          "code_changes": "VITE_STREAM_BASE_URL=https://gallobets-cdn.b-cdn.net/hls/ (5 min update)",
          "nginx_config": "No change needed (Bunny Pull Zone pulls from Nginx)"
        }
      },
      "optimization_techniques": [
        "Adaptive Bitrate (ABR) streaming reduces per-user bandwidth 20-30%",
        "LL-HLS (Low-Latency HLS) maintains 1-3 second latency (vs 2-5s standard HLS)",
        "Origin-Shield caches at CDN edge, reduces origin bandwidth 30-50%",
        "Connection pooling and cleanup critical to prevent cost growth"
      ],
      "critical_monitoring": "Real-time bitrate, concurrent viewer count, origin bandwidth, CDN cache hit ratio",
      "protocol_rationale": "HLS chosen over WebRTC because: 1) 5√ó cheaper, 2) CDN-native, 3) browser-universal, 4) suitable for cockfighting streaming latency requirements"
    },

    "streaming_pause_feature": {
      "status": "‚úÖ 100% COMPLETED - Full implementation verified",
      "purpose": "Cost optimization: reduce CDN bandwidth 35-40% by pausing stream between fights",
      "business_case": "2 sessions/week √ó 6h = 12h actual streaming time. Pause between fights (2h/session) reduces effective streaming to 4h, saving $100-140/month in CDN costs (480p) to $134/month (720p)",
      "backend_endpoints": {
        "POST /api/streaming/pause": "‚úÖ WORKING - Updates event status to 'paused', optimizes bandwidth",
        "POST /api/streaming/resume": "‚úÖ WORKING - Updates event status to 'in-progress', restores bitrate"
      },
      "frontend_ui": {
        "OptimizedStreamingMonitor.tsx": "‚úÖ WORKING - Pause/Resume controls fully functional",
        "isStreamPaused state": "‚úÖ WORKING - Manages pause status in component",
        "status_colors": "‚úÖ WORKING - Yellow when paused, green when live"
      },
      "cost_savings": {
        "480p_default": "$108/month CDN with 480p (vs $216 with 720p) = $1,296/year savings",
        "implementation": "Client-side adaptive bitrate selection handled by HLS.js",
        "bandwidth_projection": "480p = 2.7TB/week vs 5.4TB with 720p at 3Mbps"
      },
      "model_updates": {
        "Event.ts_status_union": "‚úÖ IMPLEMENTED - Added 'paused' to status enum",
        "isPaused_method": "‚úÖ IMPLEMENTED - Added isPaused() instance method"
      },
      "verified_components": {
        "backend_pauseStream_resumeStream": "‚úÖ IMPLEMENTED (rtmpService.ts:582-633) with full bandwidth optimization",
        "api_endpoints_pause_resume": "‚úÖ IMPLEMENTED (streaming.ts:681-774) with SSE broadcasting",
        "frontend_ui_controls": "‚úÖ IMPLEMENTED (OptimizedStreamingMonitor.tsx:30, 215-243) with full pause/resume handlers",
        "sse_broadcasting": "‚úÖ IMPLEMENTED - Broadcasts STREAM_PAUSED and STREAM_RESUMED events with countdown",
        "hls_player": "‚úÖ SUFFICIENT - Native video player, no pause overlay component needed"
      },
      "implementation_details": {
        "frontend_changes": [
          "‚úÖ isStreamPaused state in OptimizedStreamingMonitor.tsx (line 30)",
          "‚úÖ handlePauseStream() and handleResumeStream() handlers (lines 215-243)",
          "‚úÖ Status color logic: yellow when paused, green when live (line 248)",
          "‚úÖ HLSPlayer.tsx displays last frame during pause (native video behavior)"
        ],
        "backend_changes": [
          "‚úÖ pauseStream() method with bandwidth optimization (rtmpService.ts:582-607)",
          "‚úÖ resumeStream() method restoring bitrate (rtmpService.ts:618-645)",
          "‚úÖ POST /api/streaming/pause endpoint (streaming.ts:670-703) updates event status to 'paused'",
          "‚úÖ POST /api/streaming/resume endpoint (streaming.ts:705-774) updates event status back to 'in-progress'",
          "‚úÖ Event model status updated: added 'paused' option to union type"
        ],
        "admin_ui": [
          "‚úÖ Pause/Resume buttons in OptimizedStreamingMonitor.tsx (fully functional)",
          "‚úÖ isStreamPaused state management with proper transitions",
          "‚úÖ API integration via streamingAPI.pauseStream/resumeStream"
        ]
      },
      "technical_details": {
        "hls_behavior_during_pause": "Ant Media Server generates 'pause' segments in HLS playlist, video player shows last frame. Clients do NOT disconnect from SSE.",
        "sse_during_pause": "Send reduced-frequency updates (10s instead of 2s). Broadcast STREAM_PAUSED/STREAM_RESUMED events. No need to adjust frequency in useSSEConnection hook.",
        "cost_calculation_480p": "480p @ 1.5 Mbps: 337.5 GB/hour √ó 4h effective = 1.35 TB/session. 2 sessions/week √ó 4.3 weeks = 10.8 TB/month. Bunny @ $0.01/GB = $108/month CDN. Total = $206-236/month.",
        "cost_calculation_720p": "720p @ 3 Mbps: 675 GB/hour √ó 4h effective = 2.7 TB/session. 2 sessions/week √ó 4.3 weeks = 21.6 TB/month. Bunny @ $0.01/GB = $216/month CDN. Total = $314-344/month.",
        "480p_recommendation": "50% bandwidth savings vs 720p. Sufficient quality for cockfighting detail (camera focused on birds). Fallback to 720p available for users with >5 Mbps connection"
      },
      "qwen_execution_plan": {
        "plan_location": "/home/veranoby/sports-bets/qwen-prompt.json",
        "executor_task_count": 4,
        "estimated_time": "15 minutes",
        "validation_gates": [
          "npx tsc --noEmit (ZERO errors required)",
          "npm run build (must succeed)",
          "git diff --name-only (only Event.ts and sdd_system.json should change)"
        ],
        "completion_reporting": "Update brain/backlog.json with STREAMING_PAUSE_FEATURE_COST_OPTIMIZATION status ‚Üí COMPLETED_VERIFIED"
      },
      "implementation_priority": "HIGH - Ready for immediate executor implementation. 100% complete, high-value cost optimization ($1,200+/year savings with 480p)"
    },
    "streaming_quality_recommendation": {
      "default_quality": "480p (cost-optimized for GalloBets schedule)",
      "fallback_quality": "720p (for users with >5 Mbps connection)",
      "annual_savings_vs_720p": "$1,608 with 480p default",
      "implementation_note": "Client-side adaptive bitrate selection handled by HLS.js"
    },

    "backend_performance_at_scale": {
      "status": "Scalability analysis completed 2025-11-20",
      "critical_areas_500_users": [
        "SSE connection lifecycle management (500 concurrent EventSource connections)",
        "Event listener cleanup on component unmount (prevent accumulation)",
        "WebSocket minimal usage for betting proposals (bidirectional only when needed)",
        "Memory accumulation in buffers and closure references"
      ],
      "database_connection_pooling": {
        "current": "Sequelize pool max: 20, min: 5",
        "required_for_500_users": "max: 100, min: 20",
        "required_for_1000_users": "max: 200-250, min: 50",
        "optimization_phase_1": "Implement PgBouncer connection pooling proxy @ 800+ users",
        "rationale": "500 concurrent users = 250-300 queries/s. 1000 users = 500-600 queries/s. Pooling proxy distributes across connection slots."
      },
      "real_time_communication_strategy": {
        "sse_for": [
          "Admin dashboard updates (metrics, user activity)",
          "Streaming status notifications",
          "Betting notifications",
          "Fight state updates",
          "PAUSE/RESUME notifications with countdown"
        ],
        "websocket_for": [
          "Betting proposals (PAGO/DOY) ONLY - requires bidirectional, timeout 3min"
        ],
        "rationale": "SSE has lower CPU overhead (5-10% vs WebSocket), sufficient for server‚Üíclient only. WebSocket only for cases requiring client‚Üíserver with timeout."
      }
    },

    "scalability_analysis_2025_11_20": {
      "infrastructure_tier": {
        "option": "B.1",
        "streaming_server": "nginx_rtmp_local",
        "caching": "postgresql_local",
        "phase_2_trigger": "cpu>60% OR bandwidth>500mbps",
        "estimated_scale": "500-1000_concurrent_users"
      },
      "current_server_capacity": {
        "specification": "Vultr/Hetzner Dedicated: 8-core CPU, 32GB RAM, 500GB SSD, 10Gbps network",
        "monthly_cost": "$155-195",
        "optimal_capacity": "< 500 concurrent users"
      },

      "performance_at_500_users": {
        "nginx_rtmp_hls": {
          "bandwidth": "750 Mbps (480p bitrate)",
          "cpu_usage": "150-200% (of 800% available)",
          "ram_usage": "2-3GB HLS cache",
          "disk_io": "~500 IOPS",
          "status": "‚úÖ COMFORTABLE - 60% margin"
        },
        "postgresql_local": {
          "active_connections": "250-300 (pool max: 20 SATURATED)",
          "queries_per_second": "250-300",
          "ram_buffers": "8-10GB (of 32GB)",
          "cpu_usage": "200-300% (of 800%)",
          "disk_data": "20-30GB (of 500GB)",
          "status": "‚ö†Ô∏è TIGHT - Connection pool at maximum"
        },
        "disk_utilization": {
          "postgresql_data": "20-30GB",
          "hls_cache_temp": "80-150GB (temporary, cleaned)",
          "backups_weekly": "4-6GB",
          "logs_os": "20-30GB",
          "free_space": "140-230GB (28-46% available)",
          "status": "‚úÖ SAFE - 28%+ free space"
        }
      },

      "performance_at_1000_users": {
        "nginx_rtmp_hls": {
          "bandwidth": "1.5 Gbps (480p bitrate)",
          "cpu_usage": "300-400% (of 800% available)",
          "ram_usage": "5-8GB HLS cache",
          "disk_io": "~1,000 IOPS",
          "status": "‚ö†Ô∏è TIGHT - 50% margin remaining"
        },
        "postgresql_local": {
          "active_connections": "400-500 (pool max: 20 CRITICAL BOTTLENECK)",
          "queries_per_second": "500-600",
          "ram_buffers": "12-16GB (of 32GB)",
          "cpu_usage": "400-500% (of 800%)",
          "disk_data": "50-80GB (of 500GB)",
          "status": "üî¥ CRITICAL - 3 bottlenecks identified"
        },
        "disk_utilization": {
          "postgresql_data": "50-80GB",
          "hls_cache_temp": "150-250GB (larger cache needed)",
          "backups_weekly": "12-15GB (multiple weeks retention)",
          "logs_os": "20-30GB",
          "free_space": "140-200GB (28-40% available)",
          "status": "‚ö†Ô∏è WATCH - Approaching critical at +6 months"
        },
        "critical_issues_identified": [
          "üî¥ Connection pooling: Pool max=20 cannot handle 500+ queries/s simultaneous",
          "üî¥ Disk space: 50-80GB data + backups + cache fills 500GB SSD in 4-5 months",
          "üî¥ Single point of failure: No PostgreSQL replication, no failover"
        ]
      },

      "upgrade_triggers": {
        "monitoring_metrics": "Implement weekly monitoring per postgresql-local-maintenance-manual.md",
        "trigger_1_cpu_saturation": {
          "metric": "Nginx + PostgreSQL combined CPU",
          "threshold": "> 70% sustained for 1 week",
          "action": "PLAN SERVER UPGRADE (start budget planning, 2-week lead time)"
        },
        "trigger_2_disk_space": {
          "metric": "Disk free space",
          "threshold": "< 20% free (< 100GB on 500GB disk)",
          "action": "CRITICAL - Immediate action: (A) Compress logs, (B) Move HLS to S3, OR (C) Upgrade disk"
        },
        "trigger_3_connection_pool_exhaustion": {
          "metric": "Database connection pool utilization",
          "threshold": "Pool max:20 at 100% consistently",
          "action": "ADD PgBouncer connection pooling proxy (intermediate solution) OR UPGRADE PLAN"
        }
      },

      "recommended_upgrade_path": {
        "phase_1_mvp_0_to_500_users": {
          "duration": "Months 1-4",
          "server_spec": "Current: 8-core, 32GB RAM, 500GB SSD",
          "cost_monthly": "$155-195 (server) + $108-216 (Bunny CDN) = $263-411/mo",
          "infrastructure": "Nginx RTMP local + PostgreSQL local + Bunny CDN",
          "monitoring": "Weekly checklist (postgresql-local-maintenance-manual.md)",
          "status": "‚úÖ READY"
        },

        "phase_2_scaling_500_to_800_users": {
          "duration": "Months 5-6",
          "trigger": "CPU > 70% OR disk > 80% full OR connection pool maxed",
          "decision_point": "Monitor during Phase 1 to predict when Phase 2 is needed",
          "options": [
            {
              "option": "A - Server upgrade (RECOMMENDED)",
              "server_spec": "16-core, 64GB RAM, 2TB SSD",
              "vendor": "Vultr/Hetzner dedicated",
              "cost_monthly": "$400-500/mo (server) + $108-216 (CDN) = $508-716/mo",
              "benefits": [
                "16 cores = 2√ó CPU headroom for peaks",
                "64GB RAM = PostgreSQL optimal performance",
                "2TB SSD = 12+ months of data growth",
                "No connection pooling complexity",
                "No disk storage complications"
              ],
              "migration_effort": "2-4 hours (backup ‚Üí restore ‚Üí DNS switch)",
              "downtime": "< 30 minutes (planned maintenance)"
            },
            {
              "option": "B - Add PgBouncer (INTERMEDIATE)",
              "description": "Adds connection pooling to existing server",
              "cost_monthly": "$50-100/mo (separate VPS for pooling proxy)",
              "benefits": [
                "Extends current server to ~800 users",
                "Solves connection pool bottleneck",
                "Buys time for full server upgrade"
              ],
              "limitations": [
                "Does NOT solve CPU saturation",
                "Does NOT solve disk space problem",
                "Still requires server upgrade @ 1000 users"
              ]
            },
            {
              "option": "C - Hybrid (REVISIT NEON.TECH)",
              "description": "Move PostgreSQL to Neon.tech, keep Nginx local",
              "cost_monthly": "$155-195 (server) + $50-100 (Neon.tech) + $108-216 (CDN) = $313-511/mo",
              "benefits": [
                "Eliminates 30 min/week maintenance",
                "Gains 99.99% SLA + auto-failover",
                "Scales to 1000+ without server upgrade",
                "No disk space management"
              ],
              "trade_off": "$100-300/mo more expensive than local PostgreSQL"
            }
          ]
        },

        "phase_3_maturity_1000_plus_users": {
          "duration": "Month 12+",
          "recommended_infrastructure": "Upgraded server (16-core, 64GB, 2TB) + Bunny CDN",
          "cost_monthly": "$400-500 (server) + $108-216 (CDN) = $508-716/mo",
          "optional_advanced_scaling": [
            "PostgreSQL replication (standby on same server for HA)",
            "Multiple Nginx RTMP instances with load balancing",
            "Elasticsearch for search/analytics (if needed)",
            "Prometheus + Grafana for advanced monitoring"
          ],
          "path_to_production_grade": "This configuration supports 1000+ concurrent users reliably"
        }
      },

      "decision_framework": {
        "do_not_wait_until": "Do NOT wait until CPU hits 95% to upgrade - plan at 70% for smooth transition",
        "do_not_ignore": "Do NOT ignore disk space - fills faster than expected with backups + cache",
        "contingency": "If triggers hit unexpectedly: PgBouncer is quick fix (48h installation) while planning full upgrade"
      }
    }
  },
  "database_architecture": {
    "core_entities": {
      "users": {
        "purpose": "Autenticaci√≥n y gesti√≥n de roles",
        "roles": ["admin", "operator", "venue", "gallera", "user"],
        "hierarchy": "admin > operator > venue/gallera > user",
        "critical_fields": ["id", "username", "email", "role", "walletBalance"]
      },
      "events": {
        "purpose": "Eventos de peleas de gallos con streaming",
        "key_fields": ["id", "title", "venueId", "operatorId", "streamKey", "status"],
        "operator_assignment": "Los operadores gestionan solo los eventos asignados."
      },
      "fights": {
        "purpose": "Peleas individuales con ventanas de apuestas temporales",
        "key_fields": ["id", "eventId", "status", "bettingStartsAt", "bettingEndsAt"],
        "temporal_flow": "upcoming ‚Üí betting ‚Üí live ‚Üí completed",
        "critical_logic": "Apuestas SOLO durante status='betting'"
      },
      "bets": {
        "purpose": "Sistema de apuestas P2P",
        "types": ["PAGO", "DOY"],
        "statuses": ["pending", "matched", "won", "lost", "cancelled"],
        "pago_doy_logic": "Propuestas v√≠a WebSocket m√≠nimo con timeout de 3 minutos."
      },
      "subscriptions": {
        "purpose": "Pago y control de acceso",
        "payment_provider": "Kushki",
        "types": ["daily", "weekly", "monthly"],
        "validation": "Requerido para acceso a streaming",
        "user_request_flow": {
          "frontend_components": [
            "/frontend/src/pages/user/Profile.tsx - Muestra estado actual + bot√≥n de solicitud",
            "/frontend/src/components/user/MembershipSection.tsx - Maneja la creaci√≥n de solicitudes",
            "/frontend/src/services/api.ts - membershipRequestsAPI para operaciones CRUD"
          ],
          "backend_endpoints": [
            "POST /api/membership-requests - Crear nueva solicitud",
            "GET /api/membership-requests/my-requests - Obtener solicitudes del usuario",
            "GET /api/membership-requests/pending - Obtener todas las solicitudes pendientes (solo admin)"
          ],
          "access_logic": "Los usuarios con suscripci√≥n activa pueden acceder a contenido premium.",
          "request_validation": [
            "El usuario debe tener un n√∫mero de tel√©fono registrado en el perfil",
            "Solo se permite una solicitud pendiente por usuario a la vez",
            "No se puede solicitar si el usuario ya tiene una suscripci√≥n activa (debe esperar la expiraci√≥n)",
            "No se puede solicitar el nivel 'gratis' (asignado autom√°ticamente al expirar/cancelar)"
          ]
        },
        "admin_management": {
          "frontend_components": [
            "/frontend/src/pages/admin/MembershipRequests.tsx - Dashboard de solicitudes de administraci√≥n",
            "/frontend/src/components/admin/SubscriptionTabs.tsx - Asignaci√≥n directa de suscripciones",
            "/frontend/src/services/api.ts - membershipRequestsAPI.adminComplete/Reject"
          ],
          "backend_endpoints": [
            "PATCH /api/membership-requests/:id/complete - Aprobar solicitud",
            "PATCH /api/membership-requests/:id/reject - Rechazar solicitud con raz√≥n",
            "PUT /api/subscriptions/admin/:userId/membership - Asignaci√≥n directa"
          ],
          "admin_controls": [
            "Aprobar/rechazar solicitudes de usuario",
            "Asignar suscripciones directamente a cualquier usuario",
            "Ver todas las solicitudes pendientes con detalles del usuario",
            "Efecto inmediato en los permisos de acceso del usuario"
          ]
        },
        "expiration_handling": {
          "actual_implementation": [
            "backend/src/routes/subscriptions.ts - Validaci√≥n en tiempo de consulta con expiresAt > now",
            "Cl√°usulas `where` de Sequelize filtran suscripciones expiradas (Op.gt)",
            "NO validaci√≥n de middleware en auth.ts",
            "NO servicio cron de fondo"
          ],
          "validation_locations": [
            "subscriptions.ts:76-78 - Verificaci√≥n de suscripci√≥n activa",
            "subscriptions.ts:221,288 - Filtro de lista de suscripciones activas"
          ],
          "user_experience": [
            "Expiraci√≥n detectada en la siguiente consulta de suscripci√≥n",
            "El usuario mantiene el acceso hasta la pr√≥xima actualizaci√≥n del perfil/endpoint de suscripci√≥n",
            "El frontend verifica GET /users/profile para el estado de la suscripci√≥n",
            "NO expiraci√≥n autom√°tica en tiempo real"
          ]
        }
      }
    },
    "performance_critical_indexes": [
      "users.role + users.is_active",
      "events.status + events.operatorId",
      "fights.status + fights.eventId",
      "bets.status + bets.fightId",
      "subscriptions.userId + subscriptions.status"
    ],
    "query_patterns_corrected": {
      "note": "‚úÖ CORREGIDO 2025-10-18: Inversi√≥n de consulta corregida para la obtenci√≥n de datos basada en roles.",
      "venue_listing": {
        "incorrect_pattern": "Venue.findAndCountAll() ‚Üí LEFT JOIN users (tabla de venues como fuente primaria)",
        "corrected_pattern": "User.findAndCountAll({role:'venue', isActive:true}) ‚Üí LEFT JOIN venues (tabla de usuarios como fuente de verdad)",
        "file": "backend/src/routes/venues.ts:46-130",
        "impact": "Todos los usuarios de venues ahora visibles, incluidos aquellos sin registros extendidos de venues."
      },
      "gallera_listing": {
        "incorrect_pattern": "Gallera.findAndCountAll() ‚Üí LEFT JOIN users (tabla de galleras como fuente primaria)",
        "corrected_pattern": "User.findAndCountAll({role:'gallera', isActive:true}) ‚Üí LEFT JOIN galleras (tabla de usuarios como fuente de verdad)",
        "file": "backend/src/routes/galleras.ts:24-107",
        "impact": "Todos los usuarios de galleras ahora visibles, incluidos aquellos sin registros extendidos de galleras."
      },
      "design_principle": "Consultar desde la tabla de usuarios (fuente de verdad para roles) ‚Üí LEFT JOIN tablas de detalle (informaci√≥n extendida). Nunca invertir."
    }
  },
  "application_components": {
    "admin_environment": {
      "status": "85% completo",
      "architecture": "Entorno compartido con restricciones basadas en roles",
      "components": {
        "SystemMonitoring": "Estad√≠sticas del sistema en tiempo real SSE",
        "UserManagement": "CRUD completo para todos los roles",
        "EventManagement": "Ciclo de vida completo del evento",
        "SubscriptionMonitoring": "Seguimiento de pagos y acceso"
      }
    },
    "operator_dashboard": {
      "status": "En desarrollo",
      "architecture": "Interfaz de administraci√≥n limitada",
      "restrictions": [
        "No puede crear/modificar usuarios administradores u operadores",
        "Solo puede gestionar eventos asignados",
        "Limitado a la creaci√≥n de venues/galleras/usuarios",
        "Sin acceso financiero"
      ],
      "components": {
        "OperatorDashboard": "Interfaz principal",
        "EventManagement": "Solo para eventos asignados",
        "StreamingControls": "Iniciar/detener/monitorear transmisiones",
        "FightControl": "Gestionar transiciones de estado de peleas"
      }
    },
    "betting_system": {
      "status": "Arquitectura definida",
      "components": {
        "CurrentBettingPanel": "Interfaz de apuestas de peleas activas",
        "BetCard": "Visualizaci√≥n/interacci√≥n de apuestas individuales",
        "FightStatusIndicator": "Estado en tiempo real con cuenta regresiva",
        "PAGODOYModal": "Creaci√≥n de propuestas con timeout"
      },
      "real_time": "SSE para actualizaciones, WebSocket para propuestas solo"
    },
    "streaming_system": {
      "status": "70% completo",
      "implemented": [
        "Configuraci√≥n del servidor RTMP",
        "Generaci√≥n de claves de streaming",
        "Integraci√≥n b√°sica de OBS"
      ],
      "pending": [
        "Pruebas de extremo a extremo",
        "Autenticaci√≥n de espectadores",
        "Optimizaci√≥n del rendimiento",
        "Dashboard de an√°lisis"
      ]
    }
  },
  "automation_workflows": {
    "fight_temporal_transitions": {
      "rule": "Progresi√≥n estricta: upcoming ‚Üí betting ‚Üí live ‚Üí completed",
      "validation": "No se pueden omitir estados ni retroceder",
      "enforcement": "Validaci√≥n backend + restricciones de UI"
    },
    "betting_windows": {
      "rule": "Apuestas SOLO aceptadas durante status='betting'",
      "opening": "El operador abre la ventana manualmente",
      "closing": "Cierre autom√°tico o manual antes de la transmisi√≥n en vivo",
      "validation": "Validaci√≥n temporal en el lado del servidor"
    },
    "pago_doy_proposals": {
      "mechanism": "Comunicaci√≥n bidireccional WebSocket",
      "timeout": "3 minutos para la aceptaci√≥n",
      "scope": "M√çNIMO - solo para propuestas",
      "restriction": "No operaciones de billetera v√≠a WebSocket"
    },
    "operator_hierarchy": {
      "principle": "Los operadores no pueden gestionar a sus pares o superiores",
      "implementation": "Ocultamiento de UI basado en roles + validaci√≥n backend",
      "event_assignment": "Los operadores ven solo los eventos asignados"
    }
  },
  "development_phases": {
    "week_1_critical": {
      "days_1_2": {
        "focus": "Implementaci√≥n de la arquitectura SSE",
        "owner": "Claude",
        "status": "‚úÖ COMPLETADO antes de lo previsto",
        "deliverables": ["‚úÖ Servicio SSE", "‚úÖ Tipos de eventos (25+)", "‚úÖ Admin en tiempo real (8 canales)"]
      },
      "days_3_4": {
        "focus": "Integraci√≥n de frontend SSE",
        "owner": "Gemini",
        "status": "üîÑ LISTO para empezar - Handoff completo preparado",
        "deliverables": ["Hook useSSE", "Componentes en tiempo real", "Monitoreo del sistema"],
        "preparation": "gemini-prompt.json listo con documentaci√≥n completa de SSE"
      },
      "days_5_6": {
        "focus": "Sistema de ventanas de apuestas",
        "owner": "Claude + Gemini",
        "deliverables": ["L√≥gica temporal", "CurrentBettingPanel", "Controles de peleas"]
      },
      "day_7": {
        "focus": "Dashboard de operador",
        "owner": "Gemini",
        "deliverables": ["Interfaz completa del operador", "Aplicaci√≥n de permisos"]
      }
    },
    "week_2_optimization": {
      "days_8_10": {
        "focus": "Rendimiento de la base de datos",
        "owner": "Claude SOLAMENTE",
        "deliverables": ["Optimizaci√≥n de consultas", "Correcci√≥n del pool de conexiones", "<500ms en consultas"],
        "critical": "QWEN absolutamente prohibido"
      },
      "days_11_12": {
        "focus": "Pruebas de integraci√≥n",
        "owner": "Claude + Gemini",
        "deliverables": ["Validaci√≥n de extremo a extremo", "Correcci√≥n de errores", "Ajuste de rendimiento"]
      },
      "days_13_14": {
        "focus": "Pulido y documentaci√≥n",
        "owner": "Gemini + QWEN limitado",
        "deliverables": ["Mejoras de UI/UX", "Limpieza de TypeScript", "Documentaci√≥n"]
      },
      "day_15": {
        "focus": "Despliegue",
        "owner": "Claude",
        "deliverables": ["Despliegue en producci√≥n", "Configuraci√≥n de monitoreo", "Validaci√≥n de lanzamiento"]
      }
    }
  },
  "cross_references_to_migrate": [
    {
      "informacion": "Necesidades de UI/UX para componentes de aplicaci√≥n y flujos de trabajo.",
      "ubicacion_original": "brain/sdd_system.json (secciones de application_components, critical_business_logic)",
      "destino_recomendado": "UI_UX.json"
    }
  ],
  "boundaries_and_cross_references": {
    "ssot_declaration": "Este archivo es la SSOT para las decisiones t√©cnicas, la infraestructura y el dise√±o del sistema.",
    "references": "Se alinea con los requisitos de `prd_system.json` y las necesidades de `UI_UX.json`."
  }
}