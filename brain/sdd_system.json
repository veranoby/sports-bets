{
  "technical_architecture": {
    "database_layer": {
      "primary_database": {
        "type": "PostgreSQL 18",
        "hosting": "OPTION B.1: PostgreSQL local en servidor dedicado",
        "connection_management": "Sequelize ORM con pooling optimizado (20 max, 5 min).",
        "production_status": {
          "query_performance": "‚úÖ OPTIMIZADO - Objetivo <500ms logrado.",
          "connection_pool": "‚úÖ CONFIGURADO - 20 max, 5 min conexiones.",
          "connection_errors": "‚úÖ RESUELTO - No hay ETIMEDOUT en producci√≥n.",
          "environment": "‚úÖ PRODUCCI√ìN - Secretos JWT y env configurados."
        }
      }
    },
    "backend_architecture": {
      "framework": "Node.js + Express + TypeScript",
      "orm": "Sequelize",
      "authentication": "JWT con control de acceso basado en roles",
      "real_time_architecture": {
        "strategy": "H√≠brido SSE + WebSocket M√≠nimo",
        "status": "‚úÖ IMPLEMENTADO - Servicio SSE listo para producci√≥n con 8 canales de administraci√≥n + optimistic updates + reconciliation.",
        "sse_usage": [
          "Actualizaciones en tiempo real de administraci√≥n (IMPLEMENTADO)",
          "Monitoreo del sistema (IMPLEMENTADO)",
          "Actualizaciones de apuestas y notificaciones (IMPLEMENTADO)",
          "Cambios de estado de peleas (IMPLEMENTADO)",
          "Suscripciones a eventos (IMPLEMENTADO)",
          "Event status changes con dual broadcast (event-specific + AdminChannel.GLOBAL) (IMPLEMENTADO 2025-12-10)",
          "Stream status changes (STREAM_STARTED, STREAM_STOPPED) (IMPLEMENTADO 2025-12-10)"
        ],
        "websocket_usage": [
          "üî¥ ELIMINATED 2025-12-29 - WebSocket completely removed for betting system",
          "PAGO/DOY proposals no longer supported",
          "All betting operations now use SSE (one-way server‚Üíclient)",
          "Auto-matching handled automatically by PostgreSQL transaction on fixed amounts"
        ],
        "streaming_architecture_2025_12_11": {
          "pipeline": "OBS ‚Üí Nginx RTMP (port 1935) ‚Üí HLS segments (/var/www/hls) ‚Üí Nginx HTTP (port 80) ‚Üí Frontend HLSPlayer",
          "rtmp_auth_flow": "OBS attempts connect ‚Üí Nginx calls POST /api/streaming/auth ‚Üí Backend validates ‚Üí Accept/Reject",
          "live_config": "HLSPlayer configured with liveSyncDurationCount=3 to start playback near live edge (not from beginning)",
          "stream_state": "event.streamStatus tracks Nginx RTMP connection state (offline/connected/paused/disconnected)",
          "cors_headers": "Nginx /hls/ location includes CORS headers for frontend access to .m3u8 and .ts files",
          "idempotent_operations": "POST /stream/start and /stream/stop accept already-active/stopped streams without error",
          "sse_event_normalization": "Backend now uses direct event types (STREAM_STARTED, STREAM_STOPPED, STREAM_PAUSED, STREAM_RESUMED) instead of wrapper format (STREAM_STATUS_UPDATE with inner type) for consistency across all streaming operations. Maintains backward compatibility with legacy wrapper events during transition period."
        },
        "streaming_phase2_fixes_2025_12_17": {
          "critical_bug_sse_filtering": {
            "issue": "EventDetail.tsx SSE handlers checked event.data?.eventId but useSSE.ts parses with root-level properties",
            "root_cause": "useSSE.ts spreads parsed data at root (lines 218-223): {...JSON.parse(event.data), ...}. Handlers expected nested structure.",
            "impact": "ALL SSE events filtered out ‚Üí UI never updated ‚Üí buttons unresponsive",
            "fix": "Changed all 13 handlers from event.data?.eventId to (event as any).eventId (EventDetail.tsx:166-320)",
            "verification": "Backend broadcasts STREAM_STARTED with eventId at root level, frontend handlers now properly match and execute"
          },
          "fragment_404_recovery": {
            "issue": "HLSPlayer fatal crash when nginx hls_cleanup removed old segments. Player requested test-stream-68.ts but only 2/3.ts existed.",
            "root_cause": "HLS.js threw fatal error on FRAG_LOAD_ERROR without recovery mechanism",
            "impact": "Blue screen UI crash after ~10s of playback",
            "fix": "Implemented HLSPlayer error handler (lines 88-138) to treat FRAG_LOAD_ERROR as non-fatal. Auto-jumps to live edge and continues.",
            "recovery_strategy": [
              "FRAG_LOAD_ERROR (404 on segments) ‚Üí Non-fatal, call startLoad() and seek to duration-1",
              "MANIFEST_LOAD_ERROR (stream offline) ‚Üí Fatal, show 'Stream offline' message",
              "Network/Media errors ‚Üí Auto-recovery via startLoad()/recoverMediaError()"
            ]
          },
          "ultra_low_latency_config_2025_12_17": {
            "target_latency": "4-5 seconds (reduced from 9s)",
            "components": {
              "nginx_upstream": "hls_fragment 1s, hls_playlist_length 6s (set by user during Phase 1)",
              "hlsplayer_config": {
                "liveSyncDurationCount": 2,
                "liveMaxLatencyDurationCount": 3,
                "maxBufferLength": 4,
                "maxMaxBufferLength": 8,
                "liveDurationInfinity": true,
                "backBufferLength": 0
              }
            },
            "latency_breakdown": [
              "OBS encoder delay: ~1-2s",
              "Nginx segment write: ~1s (1 fragment)",
              "HLS.js buffer: ~2s (2 segments from edge)",
              "Total: 4-5s"
            ],
            "webrtc_alternative": "Would achieve <1s latency but incompatible with CloudFront flat-rate pricing. HLS is optimal for current infrastructure."
          },
          "implementation_files": {
            "frontend_components": [
              "EventDetail.tsx (SSE handlers + HLS config)",
              "LiveEvent.tsx (HLS config)",
              "HLSPlayer.tsx (error recovery)"
            ],
            "diagnostic_tools": "/tmp/validate_sse_flow.sh"
          },
          "status": "IN_PROGRESS_TESTING (2025-12-17)"
        },
        "optimistic_update_pattern": {
          "description": "Optimistic updates + SSE reconciliation para zero latency UI con eventual consistency",
          "implementation": "EventList.tsx + EventDetail.tsx (2025-12-10)",
          "flow": [
            "1. User action ‚Üí API call ‚Üí Optimistic UI update (instant feedback)",
            "2. Backend processes ‚Üí Updates DB ‚Üí Dual SSE broadcast",
            "3. Frontend SSE listener ‚Üí Reconciles with optimistic state if needed"
          ],
          "benefits": [
            "Zero perceived latency (UI updates instantly)",
            "97% reduction in DB queries (1 query vs 31/min with polling)",
            "Eventual consistency via SSE reconciliation",
            "Multi-admin synchronization automatic"
          ]
        },
        "sse_dual_broadcast_strategy": {
          "description": "Backend broadcasts to both event-specific channel AND AdminChannel.GLOBAL",
          "implementation": "backend/src/routes/events.ts (lines 459-484, 633-659, 709-734)",
          "channels": [
            "event-specific: sseService.broadcastToEvent(eventId, payload)",
            "global admin: sseService.broadcastToChannel(AdminChannel.GLOBAL, payload)"
          ],
          "rationale": "EventDetail listens to event-specific, EventList listens to global ‚Üí both stay in sync"
        },
        "sse_reconciliation_strategy": {
          "description": "SSE events override optimistic updates to ensure eventual consistency",
          "implementation": "EventList.tsx:110-165, EventDetail.tsx:92-139",
          "event_types_handled": [
            "EVENT_ACTIVATED",
            "EVENT_COMPLETED",
            "EVENT_CANCELLED",
            "EVENT_SCHEDULED",
            "STREAM_STARTED",
            "STREAM_STOPPED"
          ],
          "merge_strategy": "Preserve nested objects (venue, operator) while merging SSE data",
          "performance": "Zero re-fetch needed, SSE provides all required state"
        },
        "completed_sse_migration": {
          "description": "‚úÖ Full SSE migration complete (2025-12-10)",
          "implementation": "LiveEvent.tsx + /api/sse/public/events/:eventId",
          "endpoints": {
            "admin": "/api/sse/admin/global - Admin/operator role required",
            "public": "/api/sse/public/events/:eventId - User-level auth only"
          },
          "migration_details": {
            "admin_panels": "EventList.tsx, EventDetail.tsx - SSE for all event/fight updates",
            "public_users": "LiveEvent.tsx - SSE for fight/bet/event updates, WebSocket ONLY for PAGO/DOY",
            "websocket_usage": "Strictly limited to bidirectional PAGO/DOY proposals per SDD spec"
          },
          "performance_impact": "100% SDD compliance achieved - SSE for all read operations, WebSocket only for PAGO/DOY bidirectional timeout-based proposals",
          "completion_date": "2025-12-10"
        },
        "live_event_fight_loading_fix": {
          "description": "‚úÖ Fixed LiveEvent fight modal loading issue (2025-12-11)",
          "root_cause": [
            "LiveEvent was using useFights() hook without eventId parameter",
            "Hook had race condition between auto-fetch (all fights) and manual fetch (event-specific)",
            "SSE listener was overwriting fights array with partial payload data",
            "Fight status filter was missing 'upcoming' status"
          ],
          "fixes_applied": [
            "Removed useFights() hook from LiveEvent - data now sourced from currentEvent.fights only",
            "Updated loadEventData to use fetchEventById(eventId) which includes fights in response",
            "Fixed SSE listener to preserve fights array when updating currentEvent",
            "Fixed fight status filter: now includes 'scheduled' | 'betting' | 'upcoming'",
            "Reordered variable declarations: allFights first, then currentFight derived from it"
          ],
          "implementation_details": {
            "file": "frontend/src/pages/user/LiveEvent.tsx",
            "key_changes": [
              "Line 519: Removed useFights hook",
              "Line 548: Use fetchEventById response which includes fights array",
              "Line 551-552: Log response.data.fights for verification",
              "Line 620-629: SSE listener preserves prev.fights during merge",
              "Line 747: Fight filter includes 'upcoming' status",
              "Line 733-750: Reordered allFights before currentFight"
            ]
          },
          "result": "Fight modal now displays all fights correctly with proper status categorization"
        },
        "event_detail_fight_editing_fix": {
          "description": "‚úÖ Fixed EventDetail fight editing not updating frontend (2025-12-11)",
          "root_cause": "FightsControlTab was using stale eventDetailData prop for state updates instead of parent callback",
          "fixes_applied": [
            "Added handleFightUpdated in EventDetail for direct state updates (matching handleEventUpdated pattern)",
            "Simplified FightsControlTab props: onFightCreated, onFightUpdated callbacks",
            "Removed complex state mapping logic from FightsControlTab",
            "Handlers now pass fight data directly to parent for state management"
          ],
          "implementation_details": {
            "files": [
              "frontend/src/components/admin/events/EventDetail.tsx",
              "frontend/src/components/admin/FightsControlTab.tsx"
            ],
            "key_changes": [
              "EventDetail.tsx:205-224 - New handleFightUpdated for optimistic updates",
              "EventDetail.tsx:715-716 - Pass handlers to FightsControlTab",
              "FightsControlTab.tsx:17-18 - Simplified callback-based props",
              "FightsControlTab.tsx:44-49 - Minimal handlers that just manage modals + call callbacks"
            ]
          },
          "result": "Fight editing updates frontend immediately via optimistic update pattern"
        },
        "rationale": "SSE has 5-10% lower CPU overhead vs WebSocket for server‚Üíclient. Optimistic updates provide instant UI feedback. Dual broadcast ensures all admin components stay synchronized."
      },
      "api_design": "RESTful con suplementos SSE"
    },
    "frontend_architecture": {
      "framework": "React + TypeScript",
      "state_management": "React Context + hooks",
      "routing": "React Router con protecci√≥n basada en roles",
      "styling": "Tailwind CSS",
      "build_system": "Vite",
      "real_time_integration": {
        "useSSE_hook": "Hook personalizado con l√≥gica de reconexi√≥n",
        "event_source": "Reintento autom√°tico con retroceso exponencial",
        "websocket_minimal": "Solo para propuestas PAGO/DOY"
      }
    },
    "streaming_infrastructure": {
      "protocol": "Entrada RTMP + Salida HLS (LL-HLS para baja latencia)",
      "integration": "OBS Studio + Claves de streaming",
      "mvp_solution": {
        "platform": "Nginx-RTMP en VPS",
        "capacity": "25-50 espectadores concurrentes",
        "cost": "$24-50/month (compute) + $50-100/month (bandwidth CDN)"
      },
      "selected_solution_option_b1": {
        "description": "OPTION B.1: Nginx RTMP (self-managed) + PostgreSQL local + AWS CloudFront Flat-Rate Pro",
        "phase_1_mvp_0_to_500_concurrent": {
          "components": {
            "ingestion": "OBS Studio (broadcaster encodes to 480p)",
            "streaming_server": "Nginx + RTMP module (generates HLS locally)",
            "hls_generation": "Nginx RTMP creates manifest (.m3u8) + segments (.ts) in /var/www/hls/",
            "hls_delivery": "HTTP from Nginx directly (no CDN yet)",
            "playback": "Video.js with HLS.js (adaptive bitrate)",
            "database": "PostgreSQL 18 local (self-hosted, 30 min/week maintenance)"
          },
          "cost": "$155-195/month (dedicated server only)",
          "endpoints_unchanged": [
            "POST /api/streaming/start",
            "POST /api/streaming/stop",
            "POST /api/streaming/pause",
            "POST /api/streaming/resume",
            "GET /api/streaming/status"
          ],
          "config_changes_required": {
            "backend_env": "STREAM_SERVER_URL=rtmp://nginx-server.com:1935/live | CDN_URL=http://nginx-server.com",
            "frontend_env": "VITE_STREAM_BASE_URL=http://nginx-server.com/hls"
          },
          "nginx_config": "User provides custom nginx.conf with rtmp block ‚Üí HLS output to /var/www/hls/"
        },
        "phase_2_scaling_500_to_1000_concurrent": {
          "trigger": "When Nginx CPU >60% OR bandwidth >500 Mbps",
          "change": "Update CloudFront distribution configuration (transparent cache layer)",
          "components": {
            "streaming_server": "Nginx RTMP (unchanged, still generates HLS locally)",
            "hls_delivery": "CloudFront (caches manifest + segments, serves globally)",
            "playback": "Video.js (now fetches from Bunny instead of Nginx)"
          },
          "cost_addition": "+$200/month (CloudFront Business)",
          "total_monthly": "$365/mo",
          "code_changes": "VITE_STREAM_BASE_URL=https://<your-cloudfront-domain>/hls/ (5 min update)",
          "nginx_config": "No change needed (CloudFront Pull Origin pulls from Nginx)"
        }
      },
      "optimization_techniques": [
        "Adaptive Bitrate (ABR) streaming reduces per-user bandwidth 20-30%",
        "LL-HLS (Low-Latency HLS) maintains 1-3 second latency (vs 2-5s standard HLS)",
        "Origin-Shield caches at CDN edge, reduces origin bandwidth 30-50%",
        "Connection pooling and cleanup critical to prevent cost growth"
      ],
      "critical_monitoring": "Real-time bitrate, concurrent viewer count, origin bandwidth, CDN cache hit ratio",
      "protocol_rationale": "HLS chosen over WebRTC because: 1) 5√ó cheaper, 2) CDN-native, 3) browser-universal, 4) suitable for cockfighting streaming latency requirements"
    },

    "streaming_pause_feature": {
      "status": "‚úÖ 100% COMPLETED - Full implementation verified",
      "purpose": "Cost optimization: reduce CDN bandwidth 35-40% by pausing stream between fights",
      "business_case": "2 sessions/week √ó 6h = 12h actual streaming time. Pause between fights (2h/session) reduces effective streaming to 4h, saving $100-140/month in CDN costs (480p) to $134/month (720p)",
      "backend_endpoints": {
        "POST /api/streaming/pause": "‚úÖ WORKING - Updates event status to 'paused', optimizes bandwidth",
        "POST /api/streaming/resume": "‚úÖ WORKING - Updates event status to 'in-progress', restores bitrate"
      },
      "frontend_ui": {
        "OptimizedStreamingMonitor.tsx": "‚úÖ WORKING - Pause/Resume controls fully functional",
        "isStreamPaused state": "‚úÖ WORKING - Manages pause status in component",
        "status_colors": "‚úÖ WORKING - Yellow when paused, green when live"
      },
      "cost_savings": {
        "480p_default": "$15/month CDN with 480p (CloudFront Pro flat-rate, up to 50TB) = Significant savings vs pay-as-you-go",
        "implementation": "Client-side adaptive bitrate selection handled by HLS.js",
        "bandwidth_projection": "480p = 2.7TB/week vs 5.4TB with 720p at 3Mbps"
      },
      "model_updates": {
        "Event.ts_status_union": "‚úÖ IMPLEMENTED - Added 'paused' to status enum",
        "isPaused_method": "‚úÖ IMPLEMENTED - Added isPaused() instance method"
      },
      "verified_components": {
        "backend_pauseStream_resumeStream": "‚úÖ IMPLEMENTED (rtmpService.ts:582-633) with full bandwidth optimization",
        "api_endpoints_pause_resume": "‚úÖ IMPLEMENTED (streaming.ts:681-774) with SSE broadcasting",
        "frontend_ui_controls": "‚úÖ IMPLEMENTED (OptimizedStreamingMonitor.tsx:30, 215-243) with full pause/resume handlers",
        "sse_broadcasting": "‚úÖ IMPLEMENTED - Broadcasts STREAM_PAUSED and STREAM_RESUMED events with countdown",
        "hls_player": "‚úÖ SUFFICIENT - Native video player, no pause overlay component needed"
      },
      "implementation_details": {
        "frontend_changes": [
          "‚úÖ isStreamPaused state in OptimizedStreamingMonitor.tsx (line 30)",
          "‚úÖ handlePauseStream() and handleResumeStream() handlers (lines 215-243)",
          "‚úÖ Status color logic: yellow when paused, green when live (line 248)",
          "‚úÖ HLSPlayer.tsx displays last frame during pause (native video behavior)"
        ],
        "backend_changes": [
          "‚úÖ pauseStream() method with bandwidth optimization (rtmpService.ts:582-607)",
          "‚úÖ resumeStream() method restoring bitrate (rtmpService.ts:618-645)",
          "‚úÖ POST /api/streaming/pause endpoint (streaming.ts:670-703) updates event status to 'paused'",
          "‚úÖ POST /api/streaming/resume endpoint (streaming.ts:705-774) updates event status back to 'in-progress'",
          "‚úÖ Event model status updated: added 'paused' option to union type"
        ],
        "admin_ui": [
          "‚úÖ Pause/Resume buttons in OptimizedStreamingMonitor.tsx (fully functional)",
          "‚úÖ isStreamPaused state management with proper transitions",
          "‚úÖ API integration via streamingAPI.pauseStream/resumeStream"
        ]
      },
      "technical_details": {
        "hls_behavior_during_pause": "Ant Media Server generates 'pause' segments in HLS playlist, video player shows last frame. Clients do NOT disconnect from SSE.",
        "sse_during_pause": "Send reduced-frequency updates (10s instead of 2s). Broadcast STREAM_PAUSED/STREAM_RESUMED events. No need to adjust frequency in useSSEConnection hook.",
        "cost_calculation_480p": "CloudFront Flat-Rate Pro: $15/month (fixed cost, covers bandwidth for 480p streaming up to 50TB)",
        "cost_calculation_720p": "CloudFront Flat-Rate Pro: $15/month (fixed cost, covers bandwidth for 720p streaming up to 50TB)",
        "480p_recommendation": "CloudFront Flat-Rate Pro covers up to 50TB, so 480p remains the recommended default for optimal quality within the fixed cost. Fallback to 720p available for users with >5 Mbps connection (still within 50TB quota)",
      },
      "qwen_execution_plan": {
        "plan_location": "/home/veranoby/sports-bets/qwen-prompt.json",
        "executor_task_count": 4,
        "estimated_time": "15 minutes",
        "validation_gates": [
          "npx tsc --noEmit (ZERO errors required)",
          "npm run build (must succeed)",
          "git diff --name-only (only Event.ts and sdd_system.json should change)"
        ],
        "completion_reporting": "Update brain/backlog.json with STREAMING_PAUSE_FEATURE_COST_OPTIMIZATION status ‚Üí COMPLETED_VERIFIED"
      },
      "implementation_priority": "HIGH - Ready for immediate executor implementation. 100% complete, high-value cost optimization ($1,200+/year savings with 480p)"
    },
    "streaming_quality_recommendation": {
      "default_quality": "480p (cost-optimized for Galleros.Net schedule)",
      "fallback_quality": "720p (for users with >5 Mbps connection)",
      "annual_savings_vs_720p": "$1,608 with 480p default",
      "implementation_note": "Client-side adaptive bitrate selection handled by HLS.js"
    },

    "backend_performance_at_scale": {
      "status": "Scalability analysis completed 2025-11-20",
      "critical_areas_500_users": [
        "SSE connection lifecycle management (500 concurrent EventSource connections)",
        "Event listener cleanup on component unmount (prevent accumulation)",
        "WebSocket minimal usage for betting proposals (bidirectional only when needed)",
        "Memory accumulation in buffers and closure references"
      ],
      "database_connection_pooling": {
        "current": "Sequelize pool max: 20, min: 5",
        "required_for_500_users": "max: 100, min: 20",
        "required_for_1000_users": "max: 200-250, min: 50",
        "optimization_phase_1": "Implement PgBouncer connection pooling proxy @ 800+ users",
        "rationale": "500 concurrent users = 250-300 queries/s. 1000 users = 500-600 queries/s. Pooling proxy distributes across connection slots."
      },
      "real_time_communication_strategy": {
        "sse_for": [
          "Admin dashboard updates (metrics, user activity)",
          "Streaming status notifications",
          "Betting notifications",
          "Fight state updates",
          "PAUSE/RESUME notifications with countdown"
        ],
        "websocket_for": [
          "Betting proposals (PAGO/DOY) ONLY - requires bidirectional, timeout 3min"
        ],
        "rationale": "SSE has lower CPU overhead (5-10% vs WebSocket), sufficient for server‚Üíclient only. WebSocket only for cases requiring client‚Üíserver with timeout."
      }
    },

    "scalability_analysis_2025_11_20": {
      "infrastructure_tier": {
        "option": "B.1",
        "streaming_server": "nginx_rtmp_local",
        "caching": "postgresql_local",
        "phase_2_trigger": "cpu>60% OR bandwidth>500mbps",
        "estimated_scale": "500-1000_concurrent_users"
      },
      "current_server_capacity": {
        "specification": "Hetzner Dedicated: 8-core CPU, 64GB RAM, 1TB NVMe, 10Gbps network",
        "monthly_cost": "$50",
        "optimal_capacity": "< 500 concurrent users"
      },

      "performance_at_500_users": {
        "nginx_rtmp_hls": {
          "bandwidth": "750 Mbps (480p bitrate)",
          "cpu_usage": "150-200% (of 800% available)",
          "ram_usage": "2-3GB HLS cache",
          "disk_io": "~500 IOPS",
          "status": "‚úÖ COMFORTABLE - 60% margin"
        },
        "postgresql_local": {
          "active_connections": "250-300 (pool max: 20 SATURATED)",
          "queries_per_second": "250-300",
          "ram_buffers": "8-10GB (of 64GB)",
          "cpu_usage": "200-300% (of 800%)",
          "disk_data": "20-30GB (of 500GB)",
          "status": "‚ö†Ô∏è TIGHT - Connection pool at maximum"
        },
        "disk_utilization": {
          "postgresql_data": "20-30GB",
          "hls_cache_temp": "80-150GB (temporary, cleaned)",
          "backups_weekly": "4-6GB",
          "logs_os": "20-30GB",
          "free_space": "140-230GB (28-46% available)",
          "status": "‚úÖ SAFE - 28%+ free space"
        }
      },

      "performance_at_1000_users": {
        "nginx_rtmp_hls": {
          "bandwidth": "1.5 Gbps (480p bitrate)",
          "cpu_usage": "300-400% (of 800% available)",
          "ram_usage": "5-8GB HLS cache",
          "disk_io": "~1,000 IOPS",
          "status": "‚ö†Ô∏è TIGHT - 50% margin remaining"
        },
        "postgresql_local": {
          "active_connections": "400-500 (pool max: 20 CRITICAL BOTTLENECK)",
          "queries_per_second": "500-600",
          "ram_buffers": "12-16GB (of 128GB)",
          "cpu_usage": "400-500% (of 800%)",
          "disk_data": "50-80GB (of 500GB)",
          "status": "üî¥ CRITICAL - 3 bottlenecks identified"
        },
        "disk_utilization": {
          "postgresql_data": "50-80GB",
          "hls_cache_temp": "150-250GB (larger cache needed)",
          "backups_weekly": "12-15GB (multiple weeks retention)",
          "logs_os": "20-30GB",
          "free_space": "140-200GB (28-40% available)",
          "status": "‚ö†Ô∏è WATCH - Approaching critical at +6 months"
        },
        "critical_issues_identified": [
          "üî¥ Connection pooling: Pool max=20 cannot handle 500+ queries/s simultaneous",
          "üî¥ Disk space: 50-80GB data + backups + cache fills 1TB NVMe SSD in 4-5 months for Phase 1, and 3.84TB NVMe for Phase 2/3",
          "üî¥ Single point of failure: No PostgreSQL replication, no failover"
        ]
      },

      "upgrade_triggers": {
        "monitoring_metrics": "Implement weekly monitoring per postgresql-local-maintenance-manual.md",
        "trigger_1_cpu_saturation": {
          "metric": "Nginx + PostgreSQL combined CPU",
          "threshold": "> 70% sustained for 1 week",
          "action": "PLAN SERVER UPGRADE (start budget planning, 2-week lead time)"
        },
        "trigger_2_disk_space": {
          "metric": "Disk free space",
          "threshold": "< 20% free (< 200GB on 1TB NVMe disk)",
          "action": "CRITICAL - Immediate action: (A) Compress logs, (B) Move HLS to S3, OR (C) Upgrade disk"
        },
        "trigger_3_connection_pool_exhaustion": {
          "metric": "Database connection pool utilization",
          "threshold": "Pool max:20 at 100% consistently",
          "action": "ADD PgBouncer connection pooling proxy (intermediate solution) OR UPGRADE PLAN"
        }
      },

      "recommended_upgrade_path": {
        "phase_1_mvp_0_to_500_users": {
          "duration": "Months 1-4",
          "server_spec": "Current: 8-core, 64GB RAM, 1TB NVMe",
          "cost_monthly": "$65/mo (server) + $15/mo (CloudFront) = $65/mo",
          "infrastructure": "Nginx RTMP local + PostgreSQL local + CloudFront",
          "monitoring": "Weekly checklist (postgresql-local-maintenance-manual.md)",
          "status": "‚úÖ READY"
        },

        "phase_2_scaling_500_to_800_users": {
          "duration": "Months 5-6",
          "trigger": "CPU > 70% OR disk > 80% full OR connection pool maxed",
          "decision_point": "Monitor during Phase 1 to predict when Phase 2 is needed",
          "options": [
            {
              "option": "A - Server upgrade (RECOMMENDED)",
              "server_spec": "16-core, 128GB RAM, 3.84TB NVMe",
              "vendor": "Vultr/Hetzner dedicated",
              "cost_monthly": "$165/mo (server) + $200/mo (CloudFront Business) = $365/mo",
              "benefits": [
                "16 cores = 2√ó CPU headroom for peaks",
                "64GB RAM = PostgreSQL optimal performance",
                "2TB SSD = 12+ months of data growth",
                "No connection pooling complexity",
                "No disk storage complications"
              ],
              "migration_effort": "2-4 hours (backup ‚Üí restore ‚Üí DNS switch)",
              "downtime": "< 30 minutes (planned maintenance)"
            },
            {
              "option": "B - Add PgBouncer (INTERMEDIATE)",
              "description": "Adds connection pooling to existing server",
              "cost_monthly": "$50-100/mo (separate VPS for pooling proxy)",
              "benefits": [
                "Extends current server to ~800 users",
                "Solves connection pool bottleneck",
                "Buys time for full server upgrade"
              ],
              "limitations": [
                "Does NOT solve CPU saturation",
                "Does NOT solve disk space problem",
                "Still requires server upgrade @ 1000 users"
              ]
            },
            {
              "option": "C - Hybrid (REVISIT NEON.TECH)",
              "description": "Move PostgreSQL to Neon.tech, keep Nginx local",
              "cost_monthly": "$155-195 (server) + $50-100 (Neon.tech) + $200 (CloudFront Business) = $405-495/mo",
              "benefits": [
                "Eliminates 30 min/week maintenance",
                "Gains 99.99% SLA + auto-failover",
                "Scales to 1000+ without server upgrade",
                "No disk space management"
              ],
              "trade_off": "$100-300/mo more expensive than local PostgreSQL"
            }
          ]
        },

        "phase_3_maturity_1000_plus_users": {
          "duration": "Month 12+",
          "recommended_infrastructure": "Upgraded server (16-core, 128GB, 3.84TB) + CloudFront CDN",
          "cost_monthly": "$165 (server) + $197 (CloudFront) = $362/mo",
          "optional_advanced_scaling": [
            "PostgreSQL replication (standby on same server for HA)",
            "Multiple Nginx RTMP instances with load balancing",
            "Elasticsearch for search/analytics (if needed)",
            "Prometheus + Grafana for advanced monitoring"
          ],
          "path_to_production_grade": "This configuration supports 1000+ concurrent users reliably"
        }
      },

      "decision_framework": {
        "do_not_wait_until": "Do NOT wait until CPU hits 95% to upgrade - plan at 70% for smooth transition",
        "do_not_ignore": "Do NOT ignore disk space - fills faster than expected with backups + cache",
        "contingency": "If triggers hit unexpectedly: PgBouncer is quick fix (48h installation) while planning full upgrade"
      }
    }
  },
  "database_architecture": {
    "core_entities": {
      "users": {
        "purpose": "Autenticaci√≥n y gesti√≥n de roles",
        "roles": ["admin", "operator", "venue", "gallera", "user"],
        "hierarchy": "admin > operator > venue/gallera > user",
        "critical_fields": ["id", "username", "email", "role", "walletBalance"]
      },
      "events": {
        "purpose": "Eventos de peleas de gallos con streaming",
        "key_fields": ["id", "title", "venueId", "operatorId", "streamKey", "status"],
        "operator_assignment": "Los operadores gestionan solo los eventos asignados."
      },
      "fights": {
        "purpose": "Peleas individuales con ventanas de apuestas temporales",
        "key_fields": ["id", "eventId", "status", "bettingStartsAt", "bettingEndsAt"],
        "temporal_flow": "upcoming ‚Üí betting ‚Üí live ‚Üí completed",
        "critical_logic": "Apuestas SOLO durante status='betting'"
      },
      "bets": {
        "purpose": "Sistema de apuestas P2P",
        "types": ["PAGO", "DOY"],
        "statuses": ["pending", "matched", "won", "lost", "cancelled"],
        "pago_doy_logic": "Propuestas v√≠a WebSocket m√≠nimo con timeout de 3 minutos."
      },
      "subscriptions": {
        "purpose": "Pago y control de acceso",
        "payment_provider": "Kushki",
        "types": ["daily", "weekly", "monthly"],
        "validation": "Requerido para acceso a streaming",
        "user_request_flow": {
          "frontend_components": [
            "/frontend/src/pages/user/Profile.tsx - Muestra estado actual + bot√≥n de solicitud",
            "/frontend/src/components/user/MembershipSection.tsx - Maneja la creaci√≥n de solicitudes",
            "/frontend/src/services/api.ts - membershipRequestsAPI para operaciones CRUD"
          ],
          "backend_endpoints": [
            "POST /api/membership-requests - Crear nueva solicitud",
            "GET /api/membership-requests/my-requests - Obtener solicitudes del usuario",
            "GET /api/membership-requests/pending - Obtener todas las solicitudes pendientes (solo admin)"
          ],
          "access_logic": "Los usuarios con suscripci√≥n activa pueden acceder a contenido premium.",
          "request_validation": [
            "El usuario debe tener un n√∫mero de tel√©fono registrado en el perfil",
            "Solo se permite una solicitud pendiente por usuario a la vez",
            "No se puede solicitar si el usuario ya tiene una suscripci√≥n activa (debe esperar la expiraci√≥n)",
            "No se puede solicitar el nivel 'gratis' (asignado autom√°ticamente al expirar/cancelar)"
          ]
        },
        "admin_management": {
          "frontend_components": [
            "/frontend/src/pages/admin/MembershipRequests.tsx - Dashboard de solicitudes de administraci√≥n",
            "/frontend/src/components/admin/SubscriptionTabs.tsx - Asignaci√≥n directa de suscripciones",
            "/frontend/src/services/api.ts - membershipRequestsAPI.adminComplete/Reject"
          ],
          "backend_endpoints": [
            "PATCH /api/membership-requests/:id/complete - Aprobar solicitud",
            "PATCH /api/membership-requests/:id/reject - Rechazar solicitud con raz√≥n",
            "PUT /api/subscriptions/admin/:userId/membership - Asignaci√≥n directa"
          ],
          "admin_controls": [
            "Aprobar/rechazar solicitudes de usuario",
            "Asignar suscripciones directamente a cualquier usuario",
            "Ver todas las solicitudes pendientes con detalles del usuario",
            "Efecto inmediato en los permisos de acceso del usuario"
          ]
        },
        "expiration_handling": {
          "actual_implementation": [
            "backend/src/routes/subscriptions.ts - Validaci√≥n en tiempo de consulta con expiresAt > now",
            "Cl√°usulas `where` de Sequelize filtran suscripciones expiradas (Op.gt)",
            "NO validaci√≥n de middleware en auth.ts",
            "NO servicio cron de fondo"
          ],
          "validation_locations": [
            "subscriptions.ts:76-78 - Verificaci√≥n de suscripci√≥n activa",
            "subscriptions.ts:221,288 - Filtro de lista de suscripciones activas"
          ],
          "user_experience": [
            "Expiraci√≥n detectada en la siguiente consulta de suscripci√≥n",
            "El usuario mantiene el acceso hasta la pr√≥xima actualizaci√≥n del perfil/endpoint de suscripci√≥n",
            "El frontend verifica GET /users/profile para el estado de la suscripci√≥n",
            "NO expiraci√≥n autom√°tica en tiempo real"
          ]
        }
      }
    },
    "performance_critical_indexes": [
      "users.role + users.is_active",
      "events.status + events.operatorId",
      "fights.status + fights.eventId",
      "bets.status + bets.fightId",
      "subscriptions.userId + subscriptions.status"
    ],
    "query_patterns_corrected": {
      "note": "‚úÖ CORREGIDO 2025-10-18: Inversi√≥n de consulta corregida para la obtenci√≥n de datos basada en roles.",
      "venue_listing": {
        "incorrect_pattern": "Venue.findAndCountAll() ‚Üí LEFT JOIN users (tabla de venues como fuente primaria)",
        "corrected_pattern": "User.findAndCountAll({role:'venue', isActive:true}) ‚Üí LEFT JOIN venues (tabla de usuarios como fuente de verdad)",
        "file": "backend/src/routes/venues.ts:46-130",
        "impact": "Todos los usuarios de venues ahora visibles, incluidos aquellos sin registros extendidos de venues."
      },
      "gallera_listing": {
        "incorrect_pattern": "Gallera.findAndCountAll() ‚Üí LEFT JOIN users (tabla de galleras como fuente primaria)",
        "corrected_pattern": "User.findAndCountAll({role:'gallera', isActive:true}) ‚Üí LEFT JOIN galleras (tabla de usuarios como fuente de verdad)",
        "file": "backend/src/routes/galleras.ts:24-107",
        "impact": "Todos los usuarios de galleras ahora visibles, incluidos aquellos sin registros extendidos de galleras."
      },
      "design_principle": "Consultar desde la tabla de usuarios (fuente de verdad para roles) ‚Üí LEFT JOIN tablas de detalle (informaci√≥n extendida). Nunca invertir."
    }
  },
  "application_components": {
    "admin_environment": {
      "status": "85% completo",
      "architecture": "Entorno compartido con restricciones basadas en roles",
      "components": {
        "SystemMonitoring": "Estad√≠sticas del sistema en tiempo real SSE",
        "UserManagement": "CRUD completo para todos los roles",
        "EventManagement": "Ciclo de vida completo del evento",
        "SubscriptionMonitoring": "Seguimiento de pagos y acceso"
      }
    },
    "operator_dashboard": {
      "status": "En desarrollo",
      "architecture": "Interfaz de administraci√≥n limitada",
      "restrictions": [
        "No puede crear/modificar usuarios administradores u operadores",
        "Solo puede gestionar eventos asignados",
        "Limitado a la creaci√≥n de venues/galleras/usuarios",
        "Sin acceso financiero"
      ],
      "components": {
        "OperatorDashboard": "Interfaz principal",
        "EventManagement": "Solo para eventos asignados",
        "StreamingControls": "Iniciar/detener/monitorear transmisiones",
        "FightControl": "Gestionar transiciones de estado de peleas"
      }
    },
    "betting_system": {
      "status": "Arquitectura definida",
      "components": {
        "CurrentBettingPanel": "Interfaz de apuestas de peleas activas",
        "BetCard": "Visualizaci√≥n/interacci√≥n de apuestas individuales",
        "FightStatusIndicator": "Estado en tiempo real con cuenta regresiva",
        "PAGODOYModal": "Creaci√≥n de propuestas con timeout"
      },
      "real_time": "SSE para actualizaciones, WebSocket para propuestas solo"
    },
    "streaming_system": {
      "status": "70% completo",
      "implemented": [
        "Configuraci√≥n del servidor RTMP",
        "Generaci√≥n de claves de streaming",
        "Integraci√≥n b√°sica de OBS"
      ],
      "pending": [
        "Pruebas de extremo a extremo",
        "Autenticaci√≥n de espectadores",
        "Optimizaci√≥n del rendimiento",
        "Dashboard de an√°lisis"
      ]
    }
  },
  "automation_workflows": {
    "fight_temporal_transitions_7state": {
      "rule": "‚úÖ UPDATED 2025-12-29: Progresi√≥n estricta a 7 estados: draft ‚Üí scheduled ‚Üí ready ‚Üí betting_open ‚Üí in_progress ‚Üí completed/cancelled",
      "validation": "No se pueden omitir estados ni retroceder. PostgreSQL enforced via canTransitionTo() method",
      "enforcement": "Validaci√≥n backend en Fight.canTransitionTo() + restricciones de UI frontend"
    },
    "betting_windows": {
      "rule": "Apuestas SOLO aceptadas durante status='betting_open' (Fight.status = 'betting_open')",
      "opening": "Autom√°tico cuando Fight.status cambia a 'betting_open'",
      "closing": "Autom√°tico cuando Fight.status cambia de 'betting_open' a otro estado",
      "validation": "Auto-match autom√°tico en PostgreSQL cuando existe bet pendiente con monto exacto y lado opuesto"
    },
    "betting_system_fixed_amounts_2025_12_29": {
      "status": "‚úÖ IMPLEMENTED - Simplified betting with fixed amounts only",
      "amounts": "[5, 10, 20, 50, 100, 200, 500] - PostgreSQL CHECK constraint enforced",
      "mechanism": "üî¥ No PAGO/DOY proposals. Auto-match autom√°tico cuando existe contrapart exacta.",
      "websocket_elimination": "WebSocket completamente eliminado. SSE solo para notificaciones (one-way).",
      "restriction": "Sin comunicaci√≥n bidireccional. Todo matching manejado serverside."
    },
    "operator_hierarchy": {
      "principle": "Los operadores no pueden gestionar a sus pares o superiores",
      "implementation": "Ocultamiento de UI basado en roles + validaci√≥n backend",
      "event_assignment": "Los operadores ven solo los eventos asignados"
    }
  },
  "development_phases": {
    "week_1_critical": {
      "days_1_2": {
        "focus": "Implementaci√≥n de la arquitectura SSE",
        "owner": "Claude",
        "status": "‚úÖ COMPLETADO antes de lo previsto",
        "deliverables": ["‚úÖ Servicio SSE", "‚úÖ Tipos de eventos (25+)", "‚úÖ Admin en tiempo real (8 canales)"]
      },
      "days_3_4": {
        "focus": "Integraci√≥n de frontend SSE",
        "owner": "Gemini",
        "status": "üîÑ LISTO para empezar - Handoff completo preparado",
        "deliverables": ["Hook useSSE", "Componentes en tiempo real", "Monitoreo del sistema"],
        "preparation": "gemini-prompt.json listo con documentaci√≥n completa de SSE"
      },
      "days_5_6": {
        "focus": "Sistema de ventanas de apuestas",
        "owner": "Claude + Gemini",
        "deliverables": ["L√≥gica temporal", "CurrentBettingPanel", "Controles de peleas"]
      },
      "day_7": {
        "focus": "Dashboard de operador",
        "owner": "Gemini",
        "deliverables": ["Interfaz completa del operador", "Aplicaci√≥n de permisos"]
      }
    },
    "week_2_optimization": {
      "days_8_10": {
        "focus": "Rendimiento de la base de datos",
        "owner": "Claude SOLAMENTE",
        "deliverables": ["Optimizaci√≥n de consultas", "Correcci√≥n del pool de conexiones", "<500ms en consultas"],
        "critical": "QWEN absolutamente prohibido"
      },
      "days_11_12": {
        "focus": "Pruebas de integraci√≥n",
        "owner": "Claude + Gemini",
        "deliverables": ["Validaci√≥n de extremo a extremo", "Correcci√≥n de errores", "Ajuste de rendimiento"]
      },
      "days_13_14": {
        "focus": "Pulido y documentaci√≥n",
        "owner": "Gemini + QWEN limitado",
        "deliverables": ["Mejoras de UI/UX", "Limpieza de TypeScript", "Documentaci√≥n"]
      },
      "day_15": {
        "focus": "Despliegue",
        "owner": "Claude",
        "deliverables": ["Despliegue en producci√≥n", "Configuraci√≥n de monitoreo", "Validaci√≥n de lanzamiento"]
      }
    }
  },
  "production_deployment_and_operations": {
    "infrastructure_specifications": {
      "server_provider": "Hetzner (selected for unlimited traffic + price)",
      "server_model_phase_1": "Hetzner AX42",
      "server_model_phase_2_3": "Hetzner AX102 (upgrade at 800-1000 users)",
      "server_type": "Dedicated Server (NOT VPS, NOT cloud)",
      "specs_phase_1": {
        "model": "AX42",
        "cpu": "AMD Ryzen 7 Pro 8700GE (8 cores, 16 threads)",
        "ram": "64GB DDR5 ECC RAM",
        "bandwidth": "1Gbps unlimited traffic (no overage charges)",
        "storage": "2√ó512GB NVMe SSD (1TB total)",
        "monthly_cost": "‚Ç¨46 (~$50 USD)"
      },
      "specs_phase_2_3": {
        "model": "AX102",
        "cpu": "AMD Ryzen 9 7950X3D (16 cores, 32 threads with 3D V-Cache)",
        "ram": "128GB DDR5 ECC RAM",
        "bandwidth": "1Gbps unlimited traffic (no overage charges)",
        "storage": "2√ó1.92TB NVMe SSD Datacenter Edition (3.84TB total)",
        "monthly_cost": "‚Ç¨150 (~$165 USD)"
      },
      "os": "Ubuntu Server 24.04 LTS (PRODUCTION RECOMMENDED)",
      "os_rationale": "5 years standard support (until 2029), extendible to 10 years with ESM. Powers 40% of cloud servers globally. CachyOS rolling-release not suitable for production stability.",
      "os_development_alternative": "CachyOS/Arch for local development laptop only, NOT for dedicated server",
      "location": "Germany (Falkenstein or Nuremberg datacenter)",
      "cdn": "AWS CloudFront Flat-Rate Pro Plan (Nov 2025) with edge locations in S√£o Paulo, Mexico City, Bogot√° for <50ms LATAM latency",
      "cdn_cost": "$15/mo (Pro: 50 TB, 10M requests) to $200/mo (Business: 50 TB, 125M requests)",
      "cdn_protection": "Zero overage charges - performance degrades at 100% but no surprise bills. DDoS excluded from quota.",
      "cdn_monitoring": "AWS alerts at 50%, 80%, 100%. Upgrade trigger: sustained >80% for 2+ weeks.",
      "decision_rationale": "Hetzner unlimited traffic absorbs origin bandwidth without overage charges. CloudFront edge in LATAM provides low latency. Fixed monthly cost vs cloud variable pricing."
    },
    "domain_and_dns": {
      "domain": "galleros.net",
      "registrar": "Namecheap (recommended) or Cloudflare Registrar",
      "registrar_cost": "$8.88-8.95/year",
      "dns_records": [
        {
          "type": "A",
          "host": "@",
          "value": "<server_ip>",
          "ttl": 3600,
          "purpose": "Root domain points to server"
        },
        {
          "type": "A",
          "host": "www",
          "value": "<server_ip>",
          "ttl": 3600,
          "purpose": "www subdomain"
        },
        {
          "type": "CNAME",
          "host": "hls",
          "value": "galleros.net",
          "ttl": 3600,
          "purpose": "Optional: HLS streaming CNAME (Phase 2 Bunny CDN)"
        },
        {
          "type": "MX",
          "host": "@",
          "value": "mail.galleros.net",
          "ttl": 3600,
          "purpose": "Mail server for email delivery"
        }
      ],
      "dns_propagation_time": "1-24 hours (check with nslookup/dig)"
    },
    "ssl_tls_configuration": {
      "provider": "Let's Encrypt (free)",
      "tool": "Certbot + certbot-nginx plugin",
      "installation": "sudo pacman -S certbot certbot-nginx",
      "certificate_generation": "sudo certbot certonly --standalone -d galleros.net -d www.galleros.net",
      "certificate_path": "/etc/letsencrypt/live/galleros.net/",
      "auto_renewal": "Certbot handles automatic renewal (renews 30 days before expiry)",
      "https_ports": "443 (HTTPS) + 80 (HTTP redirect to 443)"
    },
    "nginx_configuration": {
      "installation": "sudo pacman -S nginx",
      "rtmp_module_compilation": "Requires custom build (nginx-rtmp-module). Alternative: Use pre-built AUR package or Docker image.",
      "configuration_file": "/etc/nginx/nginx.conf",
      "example_config": {
        "http_block": {
          "frontend_server": {
            "listen": "80 + 443 ssl",
            "server_name": "galleros.net www.galleros.net",
            "ssl_certificate": "/etc/letsencrypt/live/galleros.net/fullchain.pem",
            "ssl_certificate_key": "/etc/letsencrypt/live/galleros.net/privkey.pem",
            "http_to_https_redirect": "Redirect all HTTP to HTTPS"
          },
          "root_location": {
            "purpose": "Serve React frontend (dist/ folder)",
            "proxy_backend": "location /api proxies to localhost:3000"
          },
          "hls_delivery": {
            "location": "/hls",
            "alias": "/var/www/hls",
            "purpose": "Serve HLS manifests (.m3u8) and segments (.ts) generated by RTMP module"
          },
          "admin_tools_reverse_proxies": {
            "pgAdmin": {
              "location": "/pgadmin",
              "proxy_pass": "localhost:5050",
              "restrict_access": "IP whitelist or VPN only"
            },
            "RedisInsight": {
              "location": "/redis",
              "proxy_pass": "localhost:8001",
              "restrict_access": "IP whitelist or VPN only"
            }
          }
        },
        "rtmp_block": {
          "listen": "1935",
          "application_live": {
            "live": "on",
            "record": "off",
            "exec_pull": "ffmpeg -i rtmp://localhost/live/$name -c:v libx264 -preset veryfast -b:v 1500k -c:a aac -b:a 128k -f flv rtmp://localhost/hls/$name"
          },
          "hls_output": "/var/www/hls"
        }
      },
      "commands": {
        "test_config": "sudo nginx -t",
        "reload": "sudo nginx -s reload",
        "restart": "sudo systemctl restart nginx",
        "logs": "tail -f /var/log/nginx/error.log"
      }
    },
    "postgresql_local_setup": {
      "installation": "sudo pacman -S postgresql",
      "initialization": "sudo -u postgres initdb -D /var/lib/postgres/data",
      "start_service": "sudo systemctl start postgresql",
      "enable_autostart": "sudo systemctl enable postgresql",
      "database_creation": "sudo -u postgres createdb gallerosnet",
      "user_creation": "sudo -u postgres createuser gallerosnet_user",
      "password_setup": "sudo -u postgres psql -c \"ALTER ROLE gallerosnet_user WITH PASSWORD '0102Mina';\"",
      "connection_string": "postgresql://gallerosnet_user:0102Mina@127.0.0.1:5432/gallerosnet",
      "backup_strategy": {
        "manual_backup": "pg_dump -U gallerosnet_user gallerosnet > /backups/backup_$(date +%Y%m%d).sql",
        "automate_with_cron": "0 2 * * * pg_dump -U gallerosnet_user gallerosnet > /backups/backup_$(date +\\%Y\\%m\\%d).sql",
        "retention_policy": "Keep last 30 days of daily backups"
      },
      "administration": {
        "cli": "psql -U gallerosnet_user -d gallerosnet",
        "gui_option_1": "pgAdmin web interface (port 5050 - local only)",
        "gui_option_2": "DBeaver (native desktop app)"
      }
    },
    "redis_setup": {
      "installation": "sudo pacman -S redis",
      "start_service": "sudo systemctl start redis",
      "enable_autostart": "sudo systemctl enable redis",
      "configuration_file": "/etc/redis/redis.conf",
      "bind": "127.0.0.1 (local only, not exposed)",
      "administration": {
        "cli": "redis-cli",
        "gui_option": "RedisInsight web interface (port 8001 - local only)"
      },
      "monitoring": "redis-cli INFO (check memory, connected_clients, etc)"
    },
    "email_configuration": {
      "email_accounts": {
        "capability": "Yes, you can have multiple galleros.net email accounts on dedicated server",
        "setup_options": [
          {
            "option": "1. Postfix + Dovecot (full mail server)",
            "pros": ["Complete control", "5+ email accounts", "Calendar/Contacts support"],
            "cons": ["Complex setup (~2-3 hours)", "Requires DNS MX records", "Maintenance overhead"],
            "recommended_for": "If you want complete email independence"
          },
          {
            "option": "2. SMTP relay (AWS SES, SendGrid, Mailgun)",
            "pros": ["Simple setup (5 min)", "Reliable delivery", "Good deliverability"],
            "cons": ["Small monthly cost (~$10-20)", "No email storage"],
            "recommended_for": "Transactional emails (registration, password reset)"
          },
          {
            "option": "3. Hybrid: Local SMTP for sending + external IMAP for personal accounts",
            "pros": ["Best of both worlds", "Low maintenance", "Scalable"],
            "cons": ["Slightly complex"],
            "recommended_for": "Galleros.Net case - send verification emails + admin personal email elsewhere"
          }
        ]
      },
      "recommended_for_gallobets": {
        "approach": "Option 2: SMTP relay (SendGrid or Mailgun)",
        "rationale": "Simple, reliable, Galleros.Net only needs to SEND (registration emails, password resets, notifications). Users can reply-to their own email.",
        "setup_time": "5 minutes",
        "cost": "$15-20/month for volume"
      },
      "smtp_configuration_backend": {
        "provider": "SendGrid or Mailgun",
        "env_variables": [
          "SMTP_HOST=smtp.sendgrid.net or smtp.mailgun.org",
          "SMTP_PORT=587",
          "SMTP_USER=apikey",
          "SMTP_PASSWORD=<api_key>",
          "SMTP_FROM=noreply@galleros.net"
        ],
        "backend_implementation": "nodemailer library (already in package.json likely)",
        "code_example": {
          "setup": "const nodemailer = require('nodemailer'); const transporter = nodemailer.createTransport({ host: process.env.SMTP_HOST, port: process.env.SMTP_PORT, auth: { user: process.env.SMTP_USER, pass: process.env.SMTP_PASSWORD } });",
          "send_email": "transporter.sendMail({ from: process.env.SMTP_FROM, to: user.email, subject: 'Verify your email', html: emailTemplate })"
        }
      },
      "email_verification_flow": {
        "current_status": "Backend already generates verification tokens (backend/src/routes/auth.ts:102-113)",
        "step_1_registration": "User registers ‚Üí Backend generates verificationToken + verificationExpires",
        "step_2_send_email": "Backend sends email with link: https://galleros.net/auth/verify/:token",
        "step_3_user_clicks": "User clicks link ‚Üí Frontend sends GET /api/auth/verify/:token",
        "step_4_verification": "Backend verifies token expiry and marks emailVerified = true",
        "step_5_redirect": "Frontend redirects to login with message 'Email verified, you can now login'"
      },
      "admin_email_accounts": {
        "option": "If you want actual email accounts (not just transactional)...",
        "setup": "Postfix + Dovecot for 5 personal admin accounts",
        "accounts_example": [
          "admin@galleros.net",
          "support@galleros.net",
          "operator1@galleros.net",
          "accounts@galleros.net",
          "system@galleros.net"
        ],
        "complexity": "High - requires DNS MX/SPF/DKIM records, daily maintenance",
        "alternative": "Use Gmail for admin accounts, just set SPF records to allow server for transactional emails"
      }
    },
    "deployment_workflow_from_github": {
      "overview": "Git pull from GitHub repo ‚Üí test locally ‚Üí git push ‚Üí server auto-pulls ‚Üí restart services",
      "recommended_workflow": "GitHub Actions + webhook or simple cron job",
      "option_1_manual_ssh_deployment": {
        "step_1": "git commit + git push to GitHub",
        "step_2": "SSH to server: ssh user@<server_ip>",
        "step_3": "cd /var/www/gallerosnet && git pull origin main",
        "step_4": "npm install (if dependencies changed)",
        "step_5": "npm run build (frontend)",
        "step_6": "sudo systemctl restart gallerosnet-backend",
        "tools": "SSH key authentication (no passwords)",
        "time_to_deploy": "2-3 minutes manual"
      },
      "option_2_automated_with_github_actions": {
        "file": ".github/workflows/deploy.yml",
        "trigger": "On push to main branch",
        "steps": [
          "Build frontend: npm run build",
          "Run tests: npm run test",
          "SSH to server (via GitHub Actions secrets)",
          "git pull + npm install + restart services",
          "Send Slack notification on success/failure"
        ],
        "setup_time": "20 minutes (GitHub Actions secrets + webhook)",
        "deployment_time": "3-5 minutes automated"
      },
      "option_3_simple_webhook": {
        "server_side": "Create webhook listener on port 9000 (internal only)",
        "github_side": "Configure GitHub webhook ‚Üí push to http://<server_ip>:9000/webhook",
        "script": "Webhook script runs: git pull + npm run build + restart",
        "setup_time": "15 minutes",
        "deployment_time": "2-3 minutes on push"
      },
      "recommended_for_gallobets": "Option 2 (GitHub Actions) - safest, logged, easy rollback",
      "rollback_strategy": "Keep git history. If deployment breaks: git revert <commit> + git push + auto-redeploy",
      "server_directory_structure": {
        "application_backend": "/var/gallerosnet/backend (Node.js backend)",
        "application_frontend": "/var/gallerosnet/frontend (React frontend - built files)",
        "source_code": "/home/veranoby/sports-bets (git repository)",
        "nginx_config": "/var/gallerosnet/nginx (Nginx configuration)",
        "hls_streams": "/var/gallerosnet/hls (Nginx RTMP generated HLS segments)",
        "backups": "/home/veranoby/backups (PostgreSQL backups - user-owned)",
        "pgadmin": "/home/veranoby/opt/pgadmin4-web (PgAdmin installation)",
        "logs": "/var/gallerosnet/logs (Application logs)",
        "ssl_certificates": "/etc/letsencrypt/live/galleros.net"
      },
      "environment_variables": {
        "location": "/var/gallerosnet/backend/.env (production)",
        "source_control": "NEVER commit .env to GitHub - use GitHub Actions secrets",
        "variables_to_set": [
          "DATABASE_URL=postgresql://gallerosnet_user:0102Mina@127.0.0.1:5432/gallerosnet",
          "REDIS_URL=redis://127.0.0.1:6379",
          "JWT_SECRET=<long_random_string>",
          "STREAM_SERVER_URL=rtmp://galleros.net:1935/live",
          "CDN_URL=https://galleros.net",
          "VITE_STREAM_BASE_URL=https://galleros.net/hls",
          "SMTP_HOST=smtp.sendgrid.net",
          "SMTP_PASSWORD=<sendgrid_api_key>",
          "NODE_ENV=production"
        ]
      }
    },
    "push_notifications_configuration": {
      "framework": "Web Push API (PWA) + web-push library",
      "status": "‚úÖ Already implemented (backend/src/routes/push.ts)",
      "setup_step_1": "Generate VAPID keys: web-push generate-vapid-keys (run once)",
      "setup_step_2": "Add to .env: VAPID_PUBLIC_KEY=xxx, VAPID_PRIVATE_KEY=yyy",
      "setup_step_3": "Restart backend: sudo systemctl restart gallerosnet-backend",
      "endpoints": [
        "POST /api/push/subscribe - Browser registers for notifications",
        "POST /api/push/send - Admin sends to user (types: betting_window_open, fight_result, etc)"
      ],
      "types_supported": ["betting_window_open", "betting_window_close", "fight_result", "pago_proposal"],
      "storage": "Subscriptions stored in database (table: push_subscriptions)",
      "no_installation_needed": "web-push already in package.json"
    },
    "local_development_setup": {
      "title": "Local Development & Testing Environment Setup",
      "overview": "Complete setup for running Galleros.net locally (CachyOS/Arch Linux)",
      "installation_checklist": [
        "‚úÖ FFmpeg (for Nginx RTMP transcoding)",
        "‚úÖ Node.js + npm (for backend and frontend)",
        "‚úÖ PostgreSQL (database)",
        "‚úÖ Redis (caching and real-time features)",
        "‚úÖ PgAdmin (PostgreSQL GUI administration)",
        "‚úÖ Nginx (reverse proxy and RTMP streaming)"
      ],
      "system_dependencies": {
        "ffmpeg": {
          "purpose": "Required for Nginx RTMP module to transcode streams from OBS to HLS format",
          "installation": "sudo pacman -S ffmpeg",
          "verification": "ffmpeg -version",
          "critical": "YES - without FFmpeg, Nginx RTMP cannot generate HLS segments"
        },
        "nodejs_npm": {
          "purpose": "JavaScript runtime for backend (Node.js) and frontend build (npm)",
          "installation": "sudo pacman -S nodejs npm",
          "verification": "node --version && npm --version"
        },
        "postgresql": {
          "purpose": "Primary database for Galleros.net",
          "installation": "sudo pacman -S postgresql",
          "verification": "psql --version"
        },
        "redis": {
          "purpose": "In-memory caching for session data, real-time features, and system settings",
          "installation": "sudo pacman -S redis",
          "verification": "redis-cli ping",
          "optional": "Can be omitted if only testing backend without caching"
        },
        "nginx": {
          "purpose": "Web server, reverse proxy, and RTMP streaming server",
          "installation": "sudo pacman -S nginx (base) + AUR nginx-rtmp-module or custom build",
          "verification": "nginx -v"
        }
      },
      "local_directory_structure": {
        "source_code": "/home/veranoby/sports-bets (git repository, contains frontend/ and backend/)",
        "backend_binary": "/var/gallerosnet/backend (deployed Node.js backend)",
        "frontend_build": "/var/gallerosnet/frontend (built React files - dist/)",
        "nginx_config": "/var/gallerosnet/nginx (Nginx configuration files)",
        "hls_streams": "/var/gallerosnet/hls (Nginx RTMP generates HLS segments here)",
        "database_data": "/var/lib/postgres/data (PostgreSQL data directory)",
        "backups": "/home/veranoby/backups (Database backups - user-owned for write access)",
        "pgadmin_data": "/home/veranoby/opt/pgadmin4-web/data (PgAdmin local data)",
        "pgadmin_install": "/home/veranoby/opt/pgadmin4-web (PgAdmin web installation)",
        "logs": "/var/gallerosnet/logs (Backend, Nginx, and other application logs)"
      },
      "database_local_setup": {
        "database_name": "gallerosnet",
        "database_user": "gallerosnet_user",
        "database_password": "0102Mina",
        "host": "127.0.0.1",
        "port": 5432,
        "connection_string_development": "postgresql://gallerosnet_user:0102Mina@127.0.0.1:5432/gallerosnet",
        "connection_string_for_env": "DATABASE_URL=postgresql://gallerosnet_user:0102Mina@127.0.0.1:5432/gallerosnet",
        "initialization_steps": [
          "1. sudo systemctl start postgresql",
          "2. sudo -u postgres createdb gallerosnet",
          "3. sudo -u postgres createuser gallerosnet_user",
          "4. sudo -u postgres psql -c \"ALTER ROLE gallerosnet_user WITH PASSWORD '0102Mina';\"",
          "5. Load schema: psql -U gallerosnet_user -d gallerosnet -f sql-complete-schema.sql"
        ]
      },
      "pgadmin_local_setup": {
        "installation_path": "/home/veranoby/opt/pgadmin4-web",
        "data_path": "/home/veranoby/opt/pgadmin4-web/data",
        "access_url": "http://127.0.0.1:5050",
        "port": 5050,
        "configuration": "web/config_local.py (overrides default paths to user-writable directory)",
        "startup_command": "cd ~/opt/pgadmin4-web && source pgadmin_venv/bin/activate && python web/pgAdmin4.py",
        "database_connection_in_pgadmin": {
          "host": "127.0.0.1",
          "port": 5432,
          "username": "gallerosnet_user",
          "password": "0102Mina",
          "database": "gallerosnet"
        }
      },
      "backend_local_development": {
        "location": "/home/veranoby/sports-bets/backend",
        "env_file": "/home/veranoby/sports-bets/backend/.env.local (for local testing)",
        "npm_commands": {
          "install_dependencies": "npm install",
          "start_development": "npm run dev (nodemon with hot reload)",
          "build": "npm run build (TypeScript compilation)",
          "test": "npm test"
        },
        "key_env_variables_local": [
          "DATABASE_URL=postgresql://gallerosnet_user:0102Mina@127.0.0.1:5432/gallerosnet",
          "REDIS_URL=redis://127.0.0.1:6379",
          "NODE_ENV=development",
          "LOG_LEVEL=debug",
          "PORT=3001"
        ]
      },
      "frontend_local_development": {
        "location": "/home/veranoby/sports-bets/frontend",
        "npm_commands": {
          "install_dependencies": "npm install",
          "start_development": "npm run dev (Vite dev server on :5173)",
          "build_for_deployment": "npm run build (outputs to dist/)",
          "preview": "npm run preview"
        },
        "env_file": "/home/veranoby/sports-bets/frontend/.env.local",
        "key_env_variables_local": [
          "VITE_API_BASE_URL=http://127.0.0.1:3001",
          "VITE_STREAM_BASE_URL=http://127.0.0.1:8080/hls"
        ]
      }
    },
    "monitoring_and_maintenance": {
      "daily_checks": [
        "systemctl status nginx postgresql redis",
        "tail -f /var/log/nginx/error.log",
        "Check disk space: df -h",
        "Check memory: free -h"
      ],
      "weekly_tasks": [
        "PostgreSQL backup verification",
        "Review /var/www/hls disk usage (delete old segments)",
        "Check Let's Encrypt certificate expiry: certbot certificates"
      ],
      "monthly_tasks": [
        "Security updates: pacman -Syu",
        "Review error logs for patterns",
        "Test disaster recovery (restore from backup)"
      ],
      "monitoring_tools": {
        "system_metrics": "Prometheus + Grafana (optional)",
        "log_aggregation": "ELK Stack or simple syslog",
        "uptime_monitoring": "Uptimerobot.com (external monitoring)"
      }
    }
  },
  "cross_references_to_migrate": [
    {
      "informacion": "Necesidades de UI/UX para componentes de aplicaci√≥n y flujos de trabajo.",
      "ubicacion_original": "brain/sdd_system.json (secciones de application_components, critical_business_logic)",
      "destino_recomendado": "UI_UX.json"
    }
  ],
  "boundaries_and_cross_references": {
    "ssot_declaration": "Este archivo es la SSOT para las decisiones t√©cnicas, la infraestructura y el dise√±o del sistema.",
    "references": "Se alinea con los requisitos de `prd_system.json` y las necesidades de `UI_UX.json`.",
    "production_deployment_note": "Secci√≥n 'production_deployment_and_operations' es la SSOT para todas las configuraciones de servidor dedicado, email, domain, SSL, y deployment workflow."
  }
}