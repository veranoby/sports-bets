{
  "technical_architecture": {
    "database_layer": {
      "primary_database": {
        "type": "PostgreSQL",
        "hosting": "Neon.tech",
        "version": "PostgreSQL 17.5",
        "rationale": "Managed PostgreSQL con excelente rendimiento y escalabilidad.",
        "connection_management": "Sequelize ORM con pooling optimizado.",
        "production_status": {
          "query_performance": "‚úÖ OPTIMIZADO - Objetivo <500ms logrado.",
          "connection_pool": "‚úÖ CONFIGURADO - 20 max, 5 min conexiones.",
          "connection_errors": "‚úÖ RESUELTO - No hay ETIMEDOUT en producci√≥n.",
          "environment": "‚úÖ PRODUCCI√ìN - Secretos JWT y env configurados."
        }
      },
      "performance_optimizations": {
        "P0_critical": [
          "Optimizaci√≥n de √≠ndices para consultas lentas",
          "Ajuste de configuraci√≥n del pool de conexiones",
          "Caching de consultas para datos calientes",
          "Implementaci√≥n de carga perezosa"
        ],
        "success_metrics": [
          "95% de consultas <500ms",
          "Cero ETIMEDOUT en producci√≥n",
          "Pool de conexiones estable"
        ]
      }
    },
    "backend_architecture": {
      "framework": "Node.js + Express + TypeScript",
      "orm": "Sequelize",
      "authentication": "JWT con control de acceso basado en roles",
      "real_time_architecture": {
        "strategy": "H√≠brido SSE + WebSocket M√≠nimo",
        "status": "‚úÖ IMPLEMENTADO - Servicio SSE listo para producci√≥n con 8 canales de administraci√≥n.",
        "sse_usage": [
          "Actualizaciones en tiempo real de administraci√≥n (IMPLEMENTADO)",
          "Monitoreo del sistema (IMPLEMENTADO)",
          "Actualizaciones de apuestas y notificaciones (IMPLEMENTADO)",
          "Cambios de estado de peleas (IMPLEMENTADO)",
          "Suscripciones a eventos (IMPLEMENTADO)"
        ],
        "websocket_usage": [
          "SOLO para propuestas PAGO/DOY",
          "Bidireccional con timeout de 3 minutos",
          "No operaciones de billetera",
          "No sugerencias din√°micas"
        ],
        "rationale": "Simplicidad de SSE para la mayor√≠a de las necesidades en tiempo real, WebSocket solo donde se requiere bidireccionalidad."
      },
      "api_design": "RESTful con suplementos SSE"
    },
    "frontend_architecture": {
      "framework": "React + TypeScript",
      "state_management": "React Context + hooks",
      "routing": "React Router con protecci√≥n basada en roles",
      "styling": "Tailwind CSS",
      "build_system": "Vite",
      "real_time_integration": {
        "useSSE_hook": "Hook personalizado con l√≥gica de reconexi√≥n",
        "event_source": "Reintento autom√°tico con retroceso exponencial",
        "websocket_minimal": "Solo para propuestas PAGO/DOY"
      }
    },
    "streaming_infrastructure": {
      "protocol": "Entrada RTMP + Salida HLS",
      "integration": "OBS Studio + Claves de streaming",
      "mvp_solution": "VPS con Nginx-RTMP (25-50 espectadores)",
      "growth_solution": "Red5 Cloud o Wowza",
      "monitoring": "An√°lisis de bitrate y espectadores en tiempo real"
    }
  },
  "database_architecture": {
    "core_entities": {
      "users": {
        "purpose": "Autenticaci√≥n y gesti√≥n de roles",
        "roles": ["admin", "operator", "venue", "gallera", "user"],
        "hierarchy": "admin > operator > venue/gallera > user",
        "critical_fields": ["id", "username", "email", "role", "walletBalance"]
      },
      "events": {
        "purpose": "Eventos de peleas de gallos con streaming",
        "key_fields": ["id", "title", "venueId", "operatorId", "streamKey", "status"],
        "operator_assignment": "Los operadores gestionan solo los eventos asignados."
      },
      "fights": {
        "purpose": "Peleas individuales con ventanas de apuestas temporales",
        "key_fields": ["id", "eventId", "status", "bettingStartsAt", "bettingEndsAt"],
        "temporal_flow": "upcoming ‚Üí betting ‚Üí live ‚Üí completed",
        "critical_logic": "Apuestas SOLO durante status='betting'"
      },
      "bets": {
        "purpose": "Sistema de apuestas P2P",
        "types": ["PAGO", "DOY"],
        "statuses": ["pending", "matched", "won", "lost", "cancelled"],
        "pago_doy_logic": "Propuestas v√≠a WebSocket m√≠nimo con timeout de 3 minutos."
      },
      "subscriptions": {
        "purpose": "Pago y control de acceso",
        "payment_provider": "Kushki",
        "types": ["daily", "weekly", "monthly"],
        "validation": "Requerido para acceso a streaming",
        "user_request_flow": {
          "frontend_components": [
            "/frontend/src/pages/user/Profile.tsx - Muestra estado actual + bot√≥n de solicitud",
            "/frontend/src/components/user/MembershipSection.tsx - Maneja la creaci√≥n de solicitudes",
            "/frontend/src/services/api.ts - membershipRequestsAPI para operaciones CRUD"
          ],
          "backend_endpoints": [
            "POST /api/membership-requests - Crear nueva solicitud",
            "GET /api/membership-requests/my-requests - Obtener solicitudes del usuario",
            "GET /api/membership-requests/pending - Obtener todas las solicitudes pendientes (solo admin)"
          ],
          "access_logic": "Los usuarios con suscripci√≥n activa pueden acceder a contenido premium.",
          "request_validation": [
            "El usuario debe tener un n√∫mero de tel√©fono registrado en el perfil",
            "Solo se permite una solicitud pendiente por usuario a la vez",
            "No se puede solicitar si el usuario ya tiene una suscripci√≥n activa (debe esperar la expiraci√≥n)",
            "No se puede solicitar el nivel 'gratis' (asignado autom√°ticamente al expirar/cancelar)"
          ]
        },
        "admin_management": {
          "frontend_components": [
            "/frontend/src/pages/admin/MembershipRequests.tsx - Dashboard de solicitudes de administraci√≥n",
            "/frontend/src/components/admin/SubscriptionTabs.tsx - Asignaci√≥n directa de suscripciones",
            "/frontend/src/services/api.ts - membershipRequestsAPI.adminComplete/Reject"
          ],
          "backend_endpoints": [
            "PATCH /api/membership-requests/:id/complete - Aprobar solicitud",
            "PATCH /api/membership-requests/:id/reject - Rechazar solicitud con raz√≥n",
            "PUT /api/subscriptions/admin/:userId/membership - Asignaci√≥n directa"
          ],
          "admin_controls": [
            "Aprobar/rechazar solicitudes de usuario",
            "Asignar suscripciones directamente a cualquier usuario",
            "Ver todas las solicitudes pendientes con detalles del usuario",
            "Efecto inmediato en los permisos de acceso del usuario"
          ]
        },
        "expiration_handling": {
          "actual_implementation": [
            "backend/src/routes/subscriptions.ts - Validaci√≥n en tiempo de consulta con expiresAt > now",
            "Cl√°usulas `where` de Sequelize filtran suscripciones expiradas (Op.gt)",
            "NO validaci√≥n de middleware en auth.ts",
            "NO servicio cron de fondo"
          ],
          "validation_locations": [
            "subscriptions.ts:76-78 - Verificaci√≥n de suscripci√≥n activa",
            "subscriptions.ts:221,288 - Filtro de lista de suscripciones activas"
          ],
          "user_experience": [
            "Expiraci√≥n detectada en la siguiente consulta de suscripci√≥n",
            "El usuario mantiene el acceso hasta la pr√≥xima actualizaci√≥n del perfil/endpoint de suscripci√≥n",
            "El frontend verifica GET /users/profile para el estado de la suscripci√≥n",
            "NO expiraci√≥n autom√°tica en tiempo real"
          ]
        }
      }
    },
    "performance_critical_indexes": [
      "users.role + users.is_active",
      "events.status + events.operatorId",
      "fights.status + fights.eventId",
      "bets.status + bets.fightId",
      "subscriptions.userId + subscriptions.status"
    ],
    "query_patterns_corrected": {
      "note": "‚úÖ CORREGIDO 2025-10-18: Inversi√≥n de consulta corregida para la obtenci√≥n de datos basada en roles.",
      "venue_listing": {
        "incorrect_pattern": "Venue.findAndCountAll() ‚Üí LEFT JOIN users (tabla de venues como fuente primaria)",
        "corrected_pattern": "User.findAndCountAll({role:'venue', isActive:true}) ‚Üí LEFT JOIN venues (tabla de usuarios como fuente de verdad)",
        "file": "backend/src/routes/venues.ts:46-130",
        "impact": "Todos los usuarios de venues ahora visibles, incluidos aquellos sin registros extendidos de venues."
      },
      "gallera_listing": {
        "incorrect_pattern": "Gallera.findAndCountAll() ‚Üí LEFT JOIN users (tabla de galleras como fuente primaria)",
        "corrected_pattern": "User.findAndCountAll({role:'gallera', isActive:true}) ‚Üí LEFT JOIN galleras (tabla de usuarios como fuente de verdad)",
        "file": "backend/src/routes/galleras.ts:24-107",
        "impact": "Todos los usuarios de galleras ahora visibles, incluidos aquellos sin registros extendidos de galleras."
      },
      "design_principle": "Consultar desde la tabla de usuarios (fuente de verdad para roles) ‚Üí LEFT JOIN tablas de detalle (informaci√≥n extendida). Nunca invertir."
    }
  },
  "application_components": {
    "admin_environment": {
      "status": "85% completo",
      "architecture": "Entorno compartido con restricciones basadas en roles",
      "components": {
        "SystemMonitoring": "Estad√≠sticas del sistema en tiempo real SSE",
        "UserManagement": "CRUD completo para todos los roles",
        "EventManagement": "Ciclo de vida completo del evento",
        "SubscriptionMonitoring": "Seguimiento de pagos y acceso"
      }
    },
    "operator_dashboard": {
      "status": "En desarrollo",
      "architecture": "Interfaz de administraci√≥n limitada",
      "restrictions": [
        "No puede crear/modificar usuarios administradores u operadores",
        "Solo puede gestionar eventos asignados",
        "Limitado a la creaci√≥n de venues/galleras/usuarios",
        "Sin acceso financiero"
      ],
      "components": {
        "OperatorDashboard": "Interfaz principal",
        "EventManagement": "Solo para eventos asignados",
        "StreamingControls": "Iniciar/detener/monitorear transmisiones",
        "FightControl": "Gestionar transiciones de estado de peleas"
      }
    },
    "betting_system": {
      "status": "Arquitectura definida",
      "components": {
        "CurrentBettingPanel": "Interfaz de apuestas de peleas activas",
        "BetCard": "Visualizaci√≥n/interacci√≥n de apuestas individuales",
        "FightStatusIndicator": "Estado en tiempo real con cuenta regresiva",
        "PAGODOYModal": "Creaci√≥n de propuestas con timeout"
      },
      "real_time": "SSE para actualizaciones, WebSocket para propuestas solo"
    },
    "streaming_system": {
      "status": "70% completo",
      "implemented": [
        "Configuraci√≥n del servidor RTMP",
        "Generaci√≥n de claves de streaming",
        "Integraci√≥n b√°sica de OBS"
      ],
      "pending": [
        "Pruebas de extremo a extremo",
        "Autenticaci√≥n de espectadores",
        "Optimizaci√≥n del rendimiento",
        "Dashboard de an√°lisis"
      ]
    }
  },
  "automation_workflows": {
    "fight_temporal_transitions": {
      "rule": "Progresi√≥n estricta: upcoming ‚Üí betting ‚Üí live ‚Üí completed",
      "validation": "No se pueden omitir estados ni retroceder",
      "enforcement": "Validaci√≥n backend + restricciones de UI"
    },
    "betting_windows": {
      "rule": "Apuestas SOLO aceptadas durante status='betting'",
      "opening": "El operador abre la ventana manualmente",
      "closing": "Cierre autom√°tico o manual antes de la transmisi√≥n en vivo",
      "validation": "Validaci√≥n temporal en el lado del servidor"
    },
    "pago_doy_proposals": {
      "mechanism": "Comunicaci√≥n bidireccional WebSocket",
      "timeout": "3 minutos para la aceptaci√≥n",
      "scope": "M√çNIMO - solo para propuestas",
      "restriction": "No operaciones de billetera v√≠a WebSocket"
    },
    "operator_hierarchy": {
      "principle": "Los operadores no pueden gestionar a sus pares o superiores",
      "implementation": "Ocultamiento de UI basado en roles + validaci√≥n backend",
      "event_assignment": "Los operadores ven solo los eventos asignados"
    }
  },
  "development_phases": {
    "week_1_critical": {
      "days_1_2": {
        "focus": "Implementaci√≥n de la arquitectura SSE",
        "owner": "Claude",
        "status": "‚úÖ COMPLETADO antes de lo previsto",
        "deliverables": ["‚úÖ Servicio SSE", "‚úÖ Tipos de eventos (25+)", "‚úÖ Admin en tiempo real (8 canales)"]
      },
      "days_3_4": {
        "focus": "Integraci√≥n de frontend SSE",
        "owner": "Gemini",
        "status": "üîÑ LISTO para empezar - Handoff completo preparado",
        "deliverables": ["Hook useSSE", "Componentes en tiempo real", "Monitoreo del sistema"],
        "preparation": "gemini-prompt.json listo con documentaci√≥n completa de SSE"
      },
      "days_5_6": {
        "focus": "Sistema de ventanas de apuestas",
        "owner": "Claude + Gemini",
        "deliverables": ["L√≥gica temporal", "CurrentBettingPanel", "Controles de peleas"]
      },
      "day_7": {
        "focus": "Dashboard de operador",
        "owner": "Gemini",
        "deliverables": ["Interfaz completa del operador", "Aplicaci√≥n de permisos"]
      }
    },
    "week_2_optimization": {
      "days_8_10": {
        "focus": "Rendimiento de la base de datos",
        "owner": "Claude SOLAMENTE",
        "deliverables": ["Optimizaci√≥n de consultas", "Correcci√≥n del pool de conexiones", "<500ms en consultas"],
        "critical": "QWEN absolutamente prohibido"
      },
      "days_11_12": {
        "focus": "Pruebas de integraci√≥n",
        "owner": "Claude + Gemini",
        "deliverables": ["Validaci√≥n de extremo a extremo", "Correcci√≥n de errores", "Ajuste de rendimiento"]
      },
      "days_13_14": {
        "focus": "Pulido y documentaci√≥n",
        "owner": "Gemini + QWEN limitado",
        "deliverables": ["Mejoras de UI/UX", "Limpieza de TypeScript", "Documentaci√≥n"]
      },
      "day_15": {
        "focus": "Despliegue",
        "owner": "Claude",
        "deliverables": ["Despliegue en producci√≥n", "Configuraci√≥n de monitoreo", "Validaci√≥n de lanzamiento"]
      }
    }
  },
  "cross_references_to_migrate": [
    {
      "informacion": "Necesidades de UI/UX para componentes de aplicaci√≥n y flujos de trabajo.",
      "ubicacion_original": "brain/sdd_system.json (secciones de application_components, critical_business_logic)",
      "destino_recomendado": "UI_UX.json"
    }
  ],
  "boundaries_and_cross_references": {
    "ssot_declaration": "Este archivo es la SSOT para las decisiones t√©cnicas, la infraestructura y el dise√±o del sistema.",
    "references": "Se alinea con los requisitos de `prd_system.json` y las necesidades de `UI_UX.json`."
  }
}