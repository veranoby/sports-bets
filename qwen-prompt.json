{
  "üéØ_START_HERE": {
    "task": "Unify /admin/monitoring + /admin/streaming into ONE page that doesn't crash the platform",
    "executor": "QWEN (qwen3-coder-plus-2025-09-23)",
    "mode": "standard (full validation required)",
    "time_estimate": "4-5 hours",
    "priority": "CRITICAL - Platform crashes without this"
  },

  "üìã_WHAT_HAS_ALREADY_BEEN_DONE": {
    "director_completed": [
      "‚úÖ Database indices created: idx_subscriptions_user_created, idx_membership_requests_status_requested",
      "‚úÖ Code optimizations: settingsService.ts (features enabled by default), membership-requests.ts (batch queries), User.ts (no redundant queries)",
      "‚úÖ Sidebar updated: Label now says 'Streaming & Monitoreo' (single entry point)",
      "‚úÖ Database verified: Migrations executed in Neon Tech, metadata.payment structure confirmed"
    ],
    "qwen_responsibility": "ONLY: Backend SSE endpoint + Frontend unified page + App.tsx routing"
  },

  "üî¥_THE_PROBLEM_IN_30_SECONDS": {
    "current_state": {
      "monitoring_page": "Polls /api/monitoring/alerts + /api/monitoring/stats every 5 seconds",
      "result": "24 queries/min √ó 687ms each = backend saturates, SSE connections collapse, console spams sw.js 404 errors",
      "user_impact": "Page crashes browser, platform becomes unusable"
    },
    "desired_state": {
      "unified_page": "Single /admin/streaming page (simplified metrics only)",
      "architecture": "SSE endpoint pushes minimal stats every 2 seconds (1 connection, not 24 queries)",
      "layout": "Left: Stream player + controls | Right: Live metrics only (connectionCount + activeBets)",
      "result": "No polling, no crashes, stable streaming experience, lean metrics"
    }
  },

  "‚úÖ_ACCEPTANCE_CRITERIA": {
    "backend_must_deliver": [
      "New endpoint: GET /api/sse/streaming?token=<jwt> (Server-Sent Events)",
      "Response structure: {connectionCount: number, activeBets: number, streamStatus: {...}}",
      "Push frequency: Every 2 seconds (throttled, no rapid updates)",
      "Authentication: Support token from query param (for EventSource compatibility)",
      "Connection stability: Maintain for 5+ minutes without spurious disconnects",
      "Logging: Backend logs show 1 SSE connection, NOT 24 queries/min"
    ],
    "frontend_must_deliver": [
      "New page: frontend/src/pages/admin/OptimizedStreamingMonitor.tsx",
      "New hook: frontend/src/hooks/useSSEConnection.ts (manages EventSource + reconnect)",
      "Layout: Left 70% (stream), Right 30% (connectionCount + activeBets metrics)",
      "Update: frontend/src/App.tsx (add route to new page)",
      "Behavior: Stream plays without interruption, metrics update in real-time",
      "Console: ZERO errors (especially no sw.js 404 spam)"
    ],
    "testing_before_delivery": [
      "npm run build (backend): Must pass TypeScript",
      "npm run build (frontend): Must pass TypeScript",
      "Browser: Load /admin/streaming, verify page works (don't break existing /admin/streaming if it's used elsewhere)",
      "Browser DevTools: Check Network tab - should show 1 EventSource connection, not 24 GET requests",
      "Browser Console: Zero errors related to monitoring or SSE"
    ]
  },

  "üèóÔ∏è_IMPLEMENTATION_PHASES": {
    "phase_1_backend_sse_endpoint": {
      "file": "backend/src/routes/streaming.ts (NEW) or extend monitoring.ts",
      "task": "Create /sse/streaming endpoint (SIMPLIFIED - metrics only, NO alerts)",
      "specification": {
        "endpoint": "GET /api/sse/streaming?token=<jwt>",
        "method": "Server-Sent Events (SSE)",
        "data_pushed": {
          "connectionCount": "Number of users currently connected to streaming",
          "activeBets": "Number of active bets (important business metric)",
          "streamStatus": "Optional: {isLive: boolean}"
        },
        "note": "REMOVED: alerts (no utility), liveEvents (only 2 max), activeUsers (same as connectionCount), requestsPerMinute (unclear utility)"
      },
      "pseudocode": [
        "app.get('/sse/streaming', authenticate via query token, (req, res) => {",
        "  res.setHeader('Content-Type', 'text/event-stream');",
        "  res.setHeader('Cache-Control', 'no-cache');",
        "  res.setHeader('Access-Control-Allow-Origin', '*');",
        "  ",
        "  const interval = setInterval(async () => {",
        "    const data = {",
        "      connectionCount: await getConnectionCount(),",
        "      activeBets: await getActiveBetsCount(),",
        "      streamStatus: {isLive: await checkIfStreaming()}",
        "    };",
        "    res.write(`data: ${JSON.stringify(data)}\\n\\n`);",
        "  }, 2000);",
        "  ",
        "  req.on('close', () => clearInterval(interval));",
        "});"
      ],
      "estimated_time": "30 minutes (simpler than before)"
    },

    "phase_2_frontend_hook": {
      "file": "frontend/src/hooks/useSSEConnection.ts (NEW)",
      "task": "Create hook for SSE connection management",
      "specification": {
        "behavior": "Opens EventSource to /api/sse/streaming?token=jwt",
        "handles": "Auto-reconnect with exponential backoff if connection drops",
        "returns": {alerts, stats, streamStatus, error, isConnected}",
        "cleanup": "Close EventSource on component unmount"
      },
      "pseudocode": [
        "export function useSSEConnection() {",
        "  const [data, setData] = useState({alerts: [], stats: null});",
        "  const [isConnected, setIsConnected] = useState(false);",
        "  const [error, setError] = useState(null);",
        "  ",
        "  useEffect(() => {",
        "    const token = localStorage.getItem('token');",
        "    const eventSource = new EventSource(`/api/sse/streaming?token=${token}`);",
        "    ",
        "    eventSource.onmessage = (e) => setData(JSON.parse(e.data));",
        "    eventSource.onopen = () => setIsConnected(true);",
        "    eventSource.onerror = () => {",
        "      setIsConnected(false);",
        "      eventSource.close();",
        "      // Reconnect logic here",
        "    };",
        "    ",
        "    return () => eventSource.close();",
        "  }, []);",
        "  ",
        "  return {alerts: data.alerts, stats: data.stats, isConnected, error};",
        "}"
      ],
      "estimated_time": "30 minutes"
    },

    "phase_3_frontend_unified_page": {
      "file": "frontend/src/pages/admin/OptimizedStreamingMonitor.tsx (NEW)",
      "task": "Create unified streaming page (SIMPLIFIED - metrics only)",
      "layout": {
        "top": "Event selector + stream status indicator (green=live, red=offline)",
        "left": "70% - HLSPlayer + stream controls (play/stop/info)",
        "right": "30% - Live metrics card: {connectionCount, activeBets}"
      },
      "implementation": [
        "Import useSSEConnection hook",
        "Import HLSPlayer component (from existing Streaming.tsx)",
        "Layout: 2-column grid (70/30 split)",
        "Use hook data: {connectionCount, activeBets, isConnected} ‚Üí render real-time",
        "Simple card showing 2 metrics (no alerts, no complex dashboard)",
        "Error handling: Show connection status, auto-reconnect UI"
      ],
      "estimated_time": "45 minutes (much simpler without alerts)"
    },

    "phase_4_routing": {
      "file": "frontend/src/App.tsx",
      "task": "Add route to unified page",
      "change": "Add route: <Route path='/admin/streaming' element={<OptimizedStreamingMonitor />} />",
      "estimated_time": "10 minutes"
    }
  },

  "‚ö†Ô∏è_CRITICAL_REQUIREMENTS": {
    "do": [
      "‚úÖ Use existing getAlerts() and getStats() functions (reuse, don't rewrite)",
      "‚úÖ Implement proper error handling (connection loss, server errors)",
      "‚úÖ Log all SSE events to console (for debugging)",
      "‚úÖ Test that stream playback is NOT interrupted when monitoring updates",
      "‚úÖ Verify single EventSource connection in Network tab"
    ],
    "dont": [
      "‚ùå Don't reimplement monitoring logic - reuse existing backend functions",
      "‚ùå Don't use polling in the frontend hook - EventSource ONLY",
      "‚ùå Don't create new migration files (all DB work is done)",
      "‚ùå Don't break existing pages - this is an addition, not a replacement"
    ]
  },

  "üìä_VERIFICATION_CHECKLIST": {
    "after_phase_1_backend": [
      "Run: npm run build ‚Üí TypeScript must pass",
      "Check: Backend logs when connecting to /sse/streaming ‚Üí should see connection established",
      "Test: curl 'localhost:3001/api/sse/streaming?token=<jwt>' ‚Üí should receive data: {...} events every 2 seconds"
    ],
    "after_phase_2_3_frontend": [
      "Run: npm run build ‚Üí TypeScript must pass",
      "Load: Browser to /admin/streaming ‚Üí page loads in <2 seconds",
      "Check: DevTools Network ‚Üí 1 EventSource connection (streaming), NOT 24 GET requests",
      "Check: DevTools Console ‚Üí ZERO errors",
      "Test: Play a stream on left, verify metrics (connectionCount, activeBets) update in real-time"
    ],
    "final_before_delivery": [
      "npm run build (both backend and frontend) ‚Üí both pass",
      "Browser: /admin/streaming page fully functional",
      "Browser: Stream plays + monitoring updates simultaneously",
      "Console: Zero errors (especially no sw.js 404 spam)"
    ]
  },

  "üìù_REPORTING_TO_DIRECTOR": {
    "format": "Text response in Claude chat (NO separate files)",
    "sections": [
      "1. Analysis: How you get connectionCount and activeBets (new simpler approach)",
      "2. Changes made: Files created/modified, line numbers, logic explained",
      "3. Performance verified: Screenshots or logs showing 1 SSE connection (not 24 queries), simple data structure",
      "4. Testing results: What passed, what failed, console output (clean or errors)",
      "5. Edge cases handled: Reconnect logic, error scenarios, stream stability"
    ]
  },

  "üîó_REFERENCE_FILES": {
    "existing_implementations": [
      "HLSPlayer: frontend/src/components/streaming/HLSPlayer.tsx (use as-is)",
      "Streaming page: frontend/src/pages/admin/Streaming.tsx (reference for layout)",
      "EventConnection model: backend/src/models/EventConnection.ts (reference for connectionCount)",
      "Bet model: backend/src/models/Bet.ts (reference for activeBets)"
    ],
    "brain_files": [
      "brain/backlog.json - Task definition (includes what monitoring had)",
      "brain/multi_ai_coordination_strategy.json - Coordination protocols"
    ]
  }
}
