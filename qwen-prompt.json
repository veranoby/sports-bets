{
  "task_title": "Optimización y Gestión Completa de Operaciones de Wallet",
  "objective": "Garantizar el acceso correcto a las funcionalidades de wallet y apuestas, implementar el flujo completo de gestión de solicitudes de wallet para administradores, y permitir ajustes manuales de saldo.",
  "estado_actual": "Acceso a /wallet y /bets RESTAURADO. Flujos de backend de wallet mejor entendidos.",
  "fases_implementacion": [
    {
      "fase": 0,
      "titulo": "Diagnóstico y Reparación de Acceso a Módulos (COMPLETADA)",
      "descripcion": "Resolver el problema crítico de redirección desde /wallet y /bets. Se descubrió una condición de carrera debido a la verificación tardía de feature flags en los componentes de página.",
      "tareas": [
        "**Tarea 0.1:** [Análisis Frontend] Trazar el Flujo de Navegación. (Completada - Causa: Redirección en componentes de página debido a feature flags no cargados).",
        "**Tarea 0.2:** [Verificación Frontend] Validar Estado de `useFeatureFlags`. (Completada - Se confirmó que `ProtectedRoute` no verificaba feature flags).",
        "**Tarea 0.3:** [Implementación] Aplicar el Parche. (Completada - Se centralizó la verificación de feature flags y el manejo de carga en `ProtectedRoute.tsx`. Se eliminó la lógica de redirección redundante de `Wallet.tsx` y `Bets.tsx`)."
      ],
      "resultado_esperado": "Usuarios con roles y feature flags correctos pueden acceder a /wallet y /bets sin redirección. (CONFIRMADO POR EL USUARIO)",
      "git_commits": ["e63e3812", "commit_del_fix_ProtectedRoute", "commit_del_fix_Wallet", "commit_del_fix_Bets"]
    },
    {
      "fase": 1,
      "titulo": "Análisis Detallado y Diseño de Flujos de Wallet (COMPLETADA)",
      "descripcion": "Reconfirmar el comportamiento del backend para depósitos y retiros, y diseñar las nuevas funcionalidades de UI/UX y endpoints necesarios.",
      "tareas": [
        "**Tarea 1.1:** [Análisis Backend] Confirmar Gaps en el Flujo de Depósito. (Completada - Se descubrió que el saldo SÍ se actualiza y la transacción SÍ se crea en `/approve` para depósitos).",
        "**Tarea 1.2:** [Análisis Backend y Frontend] Análisis Formal del Flujo de Retiro. (Completada - Se formalizó que el balance de retiro se descuenta en `/complete`).",
        "**Tarea 1.3:** [Diseño UI/UX y Backend] Diseño de la Funcionalidad 'Ajuste Manual de Saldo' y 'Gestión de Solicitudes de Depósito'. (Completada - Incluye pestaña de ajuste directo en usuario y nueva página de administración para depósitos pendientes)."
      ],
      "descubrimientos_clave": [
        "El backend ya suma el balance de depósitos y crea la transacción al APROBAR una operación de `deposit` (PUT /api/wallet-operations/:id/approve).",
        "Para los `withdrawal`, el balance se descuenta al COMPLETAR la operación (PUT /api/wallet-operations/:id/complete)."
      ],
      "nuevas_funcionalidades_diseñadas": [
        "**Ajuste Manual de Saldo (Admin):** Pestaña 'Ajuste de Saldo' en el modal de edición de usuarios. Backend: `POST /api/admin/users/:userId/adjust-balance`.",
        "**Gestión de Solicitudes de Depósito (Admin):** Nueva página en `/admin/finance/deposits` (o similar) para listar y gestionar solicitudes de depósito pendientes."
      ],
      "resultado_esperado": "Comprensión clara de los flujos de wallet existentes y un diseño detallado para las nuevas funcionalidades.",
      "git_commits": []
    },
    {
      "fase": 2,
      "titulo": "Implementación Backend",
      "descripcion": "Desarrollar los nuevos endpoints y modificar los existentes según el diseño.",
      "tareas": [
        "**Tarea 2.1:** [Implementación Backend] Implementar `POST /api/admin/users/:userId/adjust-balance` para ajustes manuales de saldo.",
        "**Tarea 2.2:** [Implementación Backend] Asegurar que el endpoint `PUT /api/wallet-operations/:id/complete` funcione correctamente para retiros (descuenta saldo) y depósitos (solo cambia estado).",
        "**Tarea 2.3:** [Actualización Documentación Brain] Agregar `POST /api/admin/users/:userId/adjust-balance` a `api_endpoints_reference.json` y actualizar `typescript_interfaces_reference.json` con nuevos tipos de transacción (`admin_credit`, `admin_debit`)."
      ],
      "notas_implementacion": [
        "Asegurar transacciones atómicas para todas las operaciones de balance.",
        "Crear registros de `Transaction` para cada ajuste manual (tipo `admin_credit` o `admin_debit`).",
        "Aplicar validaciones robustas (montos positivos, razón obligatoria)."
      ],
      "consideraciones_adicionales": "Eliminar mock data y reemplazar por lógica real durante la implementación."
    },
    {
      "fase": 3,
      "titulo": "Implementación Frontend",
      "descripcion": "Desarrollar las interfaces de usuario para las nuevas funcionalidades.",
      "tareas": [
        "**Tarea 3.1:** [Implementación Frontend] Crear pestaña 'Ajuste de Saldo' en el modal de edición de usuarios.",
        "**Tarea 3.2:** [Implementación Frontend] Desarrollar la nueva página de administración para 'Gestión de Solicitudes de Depósito' (`/admin/finance/deposits`)."
      ],
      "consideraciones_adicionales": "Eliminar mock data y reemplazar por lógica real durante la implementación."
    },
    {
      "fase": 4,
      "titulo": "Testing y Validación",
      "descripcion": "Verificación exhaustiva de todos los flujos implementados.",
      "tareas": [
        "**Tarea 4.1:** [Pruebas E2E] Crear Pruebas de Cypress para las nuevas funcionalidades y los flujos modificados.",
        "**Tarea 4.2:** [Testing Unitario/Integración] Crear pruebas para los nuevos endpoints backend.",
        "**Tarea 4.3:** [Verificación] Asegurar que no se introduzca mock data en producción y que toda la data sea real."
      ]
    }
  ],
  "technical_considerations": [
    "Asegurar la integridad transaccional en todas las operaciones de balance.",
    "Implementar controles de acceso basados en roles apropiados.",
    "Mantener un rastro de auditoría para todas las modificaciones de saldo.",
    "Manejar las condiciones de carrera durante las actualizaciones de saldo.",
    "Garantizar una validación adecuada antes de cualquier cambio de saldo."
  ],
  "riesgos_mitigacion": [
    "Todas las modificaciones de saldo deben ser transaccionales con capacidad de rollback.",
    "Implementar confirmación de administrador para operaciones sensibles.",
    "Añadir registro (logging) para todos los ajustes manuales de saldo.",
    "Validar el estado de la operación antes de procesarla."
  ],
  "pasos_verificacion": [
    "Pruebas manuales del flujo completo de depósitos (solicitud de usuario → aprobación de administrador → estado final).",
    "Pruebas manuales del flujo completo de retiros (solicitud de usuario → aprobación de administrador → completado de administrador → deducción de saldo).",
    "Verificar los controles de acceso basados en roles.",
    "Probar las condiciones de error y los casos límite.",
    "Confirmar que el historial de transacciones se registra correctamente."
  ]
}