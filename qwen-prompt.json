{
  "metadata": {
    "task_name": "UX_Logic_Fix_LiveEvent_AdminControl",
    "complexity": "MEDIUM",
    "execution_mode": "standard",
    "assigned_role": "executor",
    "estimated_time": "35-40",
    "git_branch": "fix/ux-betting-flow"
  },
  "analysis_verification_report": {
    "executed_by": "Director AI & Claude 3.7",
    "date": "2025-12-19",
    "findings": [
      {
        "component": "LiveEvent.tsx",
        "issue": "CRITICAL LOGIC BUG: 'currentFight' selector only finds 'live' status.",
        "evidence": "Code analysis confirmed 'allFights.find(f => f.status === \"live\")'.",
        "required_fix": "Update selector with explicit precedence: Live > Betting."
      },
      {
        "component": "LiveEvent.tsx",
        "issue": "UX SECURITY RISK: Betting buttons remain enabled during 'live' fight.",
        "evidence": "BettingPanel render condition relies only on feature flag.",
        "required_fix": "Inject 'isBettingOpen' prop into BettingPanel and disable buttons."
      },
      {
        "component": "EventDetail.tsx",
        "issue": "WORKFLOW GAP: Admin controls allow jumping statuses illogically.",
        "required_fix": "Refactor to sequential state-based rendering (Pending -> Open -> Close -> End)."
      }
    ],
    "recommendation": "Execute logic fixes (P0) before UI polish (P2). Adhere strictly to the provided code patterns."
  },
  "critical_protocols": {
    "session_start_declaration": "Executor AI MUST declare: Model: [model] | Role: executor | Mode: standard",
    "mcp_activation_mandatory": "Activate --c7 (React/TS)",
    "simulate_confirm_protocol": "REQUIRED: Simulate logic changes for 'currentFight' selector before applying.",
    "no_file_creation": "Modify existing files only.",
    "infinite_loop_prevention": "Do not modify useSSE hooks, only the UI logic consuming the data."
  },
  "reference_files_read_first": [
    "frontend/src/pages/user/LiveEvent.tsx",
    "frontend/src/components/admin/events/EventDetail.tsx",
    "frontend/src/types/index.ts"
  ],
  "step_by_step_implementation": {
    "step_1": {
      "action": "Fix 'currentFight' logic bug in LiveEvent.tsx with Precedence",
      "file": "frontend/src/pages/user/LiveEvent.tsx",
      "location": "Line 921 - currentFight selector",
      "purpose": "CRITICAL P0: Ensure correct fight is selected. Priority: Live > Betting.",
      "current_code": "const currentFight = allFights.find((fight) => fight.status === \"live\");",
      "required_change": "const currentFight = allFights.find((f) => f.status === \"live\") || allFights.find((f) => f.status === \"betting\");",
      "precedence_logic": "Priority: 'live' > 'betting' > null. If multiple fights exist, 'live' takes precedence.",
      "simulate": "Test selector with mock data: [{status: 'betting'}, {status: 'live'}] should return 'live' fight.",
      "confirm_before_creating": "Read file to confirm current selector at line 921.",
      "validate_after_creation": "Ensure 'Pelea Actual' header renders for BOTH 'betting' and 'live' statuses."
    },
    "step_2": {
      "action": "Implement Secure Locking for BettingPanel",
      "file": "frontend/src/pages/user/LiveEvent.tsx",
      "location": "Lines 1133-1143 - BettingPanel component render",
      "purpose": "CRITICAL P0: Prevent betting when status is not 'betting'.",
      "current_logic": "BettingPanel renders if isBettingEnabled is true (feature flag only).",
      "required_change": "Add 'isOpen={currentFight?.status === \"betting\"}' prop to BettingPanel.",
      "implementation_detail": "BettingPanel component must receive isOpen prop and apply 'disabled' attribute to all bet action buttons when isOpen=false.",
      "button_locations": "Verify BettingPanel buttons ('PAGO', 'DOY') are disabled when fight status !== 'betting'.",
      "simulate": "1. Pass 'isBettingOpen={currentFight?.status === \"betting\"}' to BettingPanel. 2. In BettingPanel, update buttons: 'disabled={!isBettingOpen}'.",
      "confirm_before_creating": "Read BettingPanel component to check if it accepts 'isOpen' or 'disabled' prop.",
      "validate_after_creation": "Test: When status changes 'betting' -> 'live', buttons must immediately disable."
    },
    "step_3": {
      "action": "Consolidate Fight Controls in EventDetail.tsx (Admin)",
      "file": "frontend/src/components/admin/events/EventDetail.tsx",
      "location": "Lines 968-985 - Fight control buttons section",
      "purpose": "HIGH P1: Enforce sequential workflow preventing state jumping.",
      "current_problem": "Independent buttons allow jumping states (upcoming -> live, skipping betting phase).",
      "required_logic": "Conditional rendering based on selectedFight.status",
      "state_flow_rules": {
        "upcoming": "Show 'ABRIR APUESTAS' button only",
        "betting": "Show 'CERRAR APUESTAS' button only",
        "live": "Show 'FINALIZAR PELEA' button only",
        "completed": "Show 'ARCHIVAR' or no action buttons"
      },
      "implementation_example": "if (status === 'upcoming') { render openBetsButton } else if (status === 'betting') { render closeBetsButton } else if (status === 'live') { render finalizeFightButton }",
      "simulate": "Mock selectedFight with status='upcoming', verify only 'ABRIR APUESTAS' button visible.",
      "confirm_before_creating": "Read 'Monitor de Pelea Actual' section at lines 968-985 to identify all button handlers.",
      "validate_after_creation": "Verify admin CANNOT skip 'betting' phase when going from 'upcoming' to 'live'."
    },
    "step_4": {
      "action": "Add Visual State Overlays in LiveEvent.tsx",
      "file": "frontend/src/pages/user/LiveEvent.tsx",
      "purpose": "MEDIUM P2: Improve UX feedback for state transitions.",
      "implementation_detail": "Create status banner component that renders above BettingPanel based on 'currentFight.status'.",
      "banner_states": {
        "betting": "Green banner: 'APUESTAS ABIERTAS'",
        "live": "Red banner: 'APUESTAS CERRADAS - PELEA EN CURSO'",
        "completed": "Gray banner: 'PELEA FINALIZADA'"
      },
      "simulate": "Add conditional rendering: if (status === 'betting') show green banner, else if (status === 'live') show red banner.",
      "confirm_before_creating": "Identify insertion point in JSX above BettingPanel component.",
      "validate_after_creation": "Check rendering for 'betting', 'live', and 'completed' states with proper colors."
    }
  },
  "success_criteria": {
    "P0_critical_blocking": [
      "currentFight selector finds BOTH 'betting' and 'live' statuses (Step 1)",
      "Betting buttons are DISABLED when currentFight.status !== 'betting' (Step 2)",
      "Zero TypeScript errors (npx tsc --noEmit)"
    ],
    "P1_important_non_blocking": [
      "'Pelea Actual' header appears for both 'betting' AND 'live' statuses",
      "Admin controls enforce sequential state flow (Step 3)",
      "Admin cannot jump from 'upcoming' -> 'live' without 'betting' phase",
      "State transitions are immediate (no lag between SSE event and UI update)"
    ],
    "P2_nice_to_have": [
      "Visual overlay ('APUESTAS CERRADAS') appears during 'live' fight (Step 4)",
      "Status banner shows clear messaging for 'betting', 'live', 'completed' states"
    ]
  },
  "error_handling": {
    "typescript_errors": "Stop and fix types if Fight status enum mismatches.",
    "logic_conflict": "Prioritize fight status over global feature flags for safety."
  }
}