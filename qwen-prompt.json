
{
  "metadata": {
    "task_name": "Correcci贸n y Optimizaci贸n de L贸gica en Gesti贸n de Eventos y Peleas (Verificado y Documentado)",
    "complexity": "HIGH",
    "execution_mode": "standard",
    "assigned_role": "executor",
    "git_branch": "feature/event-fight-management-fixes-verified"
  },
  "critical_protocols": {
    "description": "El ejecutor DEBE seguir estos protocolos del archivo 'brain/multi_ai_coordination_strategy.json'.",
    "protocols_to_follow": [
      "_UI_VERIFICATION_PROTOCOL (L铆neas 283-396)",
      "_SOURCE_VERIFICATION_BEFORE_USAGE_PROTOCOL (L铆neas 401-515)",
      "simulate_y_confirmar_protocol (L铆neas 470-481)"
    ]
  },
  "reference_files_read_first": [
    "brain/api_endpoints_reference.json",
    "frontend/src/pages/admin/EventsPage.tsx",
    "frontend/src/components/admin/events/EventList.tsx",
    "frontend/src/components/admin/events/EventDetail.tsx",
    "frontend/src/components/admin/StatusChanger.tsx",
    "frontend/src/components/admin/BetsActiveTab.tsx",
    "frontend/src/services/api.ts"
  ],
  "step_by_step_implementation": [
    {
      "step_number": 1,
      "action": "Refactorizar `StatusChanger.tsx` para usar el endpoint de acciones del evento.",
      "file": "frontend/src/components/admin/StatusChanger.tsx",
      "purpose": "Alinear el frontend con la API real del backend (`PATCH /events/:id/status`) que funciona con 'acciones' en lugar de estados directos.",
      "simulate": [
        "1. Modificar la funci贸n `getValidActions` para que devuelva las acciones permitidas por la API: 'activate', 'complete', 'cancel'.",
        "2. Ajustar las etiquetas (`label`) para que sean m谩s descriptivas para el usuario: 'Activar Evento', 'Marcar como Terminado', 'Cancelar Evento'.",
        "3. Modificar `handleActionClick` para que llame a `onStatusChange(event.id, action.action)`.",
        "4. En `EventsPage.tsx`, dentro de `handleEventAction`, asegurarse que la llamada a la API sea `eventsAPI.updateStatus(eventId, action)` o similar, que ejecute un `PATCH` con el `action` en el body."
      ],
      "confirm_before_creating": "Verificar en `frontend/src/services/api.ts` o `frontend/src/config/api.ts` que `eventsAPI` tenga una funci贸n para `PATCH /events/:id/status`. Si no existe, crearla.",
      "validate_after_creation": "Probar el dropdown en la UI y verificar que la llamada de red correcta se est茅 realizando."
    },
    {
      "step_number": 2,
      "action": "Alinear la funcionalidad del bot贸n de eliminar con el comportamiento real del backend (borrado suave).",
      "file": "frontend/src/components/admin/events/EventList.tsx",
      "purpose": "Evitar confusi贸n al usuario. El bot贸n de 'basura' debe reflejar que cancela, no que elimina permanentemente.",
      "simulate": [
        "1. Cambiar el icono `Trash2` por un icono m谩s apropiado para 'cancelar', como `XCircle` de lucide-react.",
        "2. Cambiar el `title` y el `tooltip` del bot贸n a 'Cancelar Evento'.",
        "3. En `EventsPage.tsx`, modificar el `window.confirm` en `handleDeleteEvent` para preguntar '驴Est谩s seguro de que quieres CANCELAR este evento?'. Renombrar `handleDeleteEvent` a `handleCancelEvent` por claridad y actualizar su llamada en `EventList`."
      ],
      "confirm_before_creating": "No se necesita confirmaci贸n. La documentaci贸n actualizada y la verificaci贸n del backend confirman el borrado suave.",
      "validate_after_creation": "Verificar que el evento cambia su estado a 'Cancelado' en la UI despu茅s de la acci贸n."
    },
    {
      "step_number": 3,
      "action": "Corregir la llamada a la API en `BetsActiveTab.tsx`.",
      "file": "frontend/src/components/admin/BetsActiveTab.tsx",
      "purpose": "Solucionar el error de JS `TypeError: betsAPI.getAll is not a function`.",
      "simulate": [
        "1. En la l铆nea 44, cambiar la llamada `betsAPI.getAll(params)` por `betsAPI.getAllAdmin(params)`.",
        "2. Asegurarse que la importaci贸n de `betsAPI` provenga de `frontend/src/services/api.ts`."
      ],
      "confirm_before_creating": "Verificaci贸n del c贸digo fuente de `frontend/src/services/api.ts` ya realizada, confirma que `getAllAdmin` es el nombre correcto.",
      "validate_after_creation": "La pesta帽a 'Apuestas Activas' debe cargar los datos sin errores en la consola del navegador."
    },
    {
      "step_number": 4,
      "action": "Implementar la l贸gica de control de PELEAS usando los endpoints de API unificados.",
      "file": "frontend/src/components/admin/events/EventDetail.tsx",
      "purpose": "Dar funcionalidad a los botones de control de la pelea seleccionada.",
      "simulate": [
        "1. Crear un nuevo componente modal `frontend/src/components/admin/SetWinnerModal.tsx`. Props: `isOpen`, `onClose`, `fightId`, `onSubmit(fightId, winner)`.",
        "2. En `EventDetail.tsx`, agregar un estado `isWinnerModalOpen` y un handler para abrir el modal.",
        "3. Agregar `onClick` al bot贸n 'REGISTRAR INICIO DE PELEA'. Este handler llamar谩 a `fightsAPI.updateStatus(selectedFightId, 'live')` (o una funci贸n que haga `PATCH` a `/fights/:id/status` con `{status: 'live'}`).",
        "4. Agregar `onClick` al bot贸n 'REGISTRAR TERMINO DE PELEA...' que abrir谩 el modal `SetWinnerModal`.",
        "5. Implementar el `onSubmit` del modal para que llame a `fightsAPI.updateStatus(fightId, 'completed', winner)` (o una funci贸n que haga `PATCH` a `/fights/:id/status` con `{status: 'completed', result: winner}`)."
      ],
      "confirm_before_creating": "La documentaci贸n actualizada y la verificaci贸n del backend confirman que `PATCH /fights/:id/status` es el endpoint correcto.",
      "validate_after_creation": "Probar el ciclo de vida completo de una pelea en la UI."
    },
    {
      "step_number": 5,
      "action": "Implementar la l贸gica de APUESTAS usando la m谩quina de estados de la pelea.",
      "file": "frontend/src/components/admin/BetsActiveTab.tsx",
      "purpose": "Dar funcionalidad a los botones para abrir y cerrar el per铆odo de apuestas.",
      "simulate": [
        "1. Agregar `onClick` al bot贸n 'INICIAR sesion de Apuestas'. Este handler llamar谩 a `fightsAPI.updateStatus(fightId, 'betting')` (o la funci贸n que haga `PATCH` a `/fights/:id/status` con `{status: 'betting'}`).",
        "2. Agregar `onClick` al bot贸n 'CERRAR sesion de Apuestas'. Este handler llamar谩 a `fightsAPI.updateStatus(fightId, 'live')` (o la funci贸n que haga `PATCH` a `/fights/:id/status` con `{status: 'live'}`).",
        "3. Deshabilitar los botones apropiadamente seg煤n el estado actual de la pelea para prevenir transiciones inv谩lidas."
      ],
      "confirm_before_creating": "La verificaci贸n del backend confirm贸 que el estado de las apuestas se controla a trav茅s del `status` de la pelea (`betting` -> `live`).",
      "validate_after_creation": "Probar que los botones cambian el estado de la pelea a 'betting' y luego a 'live', y que la UI se actualiza."
    }
  ],
  "success_criteria": [
    "El dropdown de estado del evento funciona con las acciones 'activate', 'complete', 'cancel'.",
    "El bot贸n de la basura en la lista de eventos se ha reemplazado por un icono de 'Cancelar' y funciona como tal.",
    "La pesta帽a de apuestas activas carga sin errores.",
    "Los botones de control de pelea y sesi贸n de apuestas llaman a los endpoints `PATCH /fights/:id/status` correctos y cambian el estado de la pelea."
  ],
  "error_handling": {
    "typescript_errors": "Detener la implementaci贸n inmediatamente y reportar el error.",
    "build_errors": "No se debe confirmar ning煤n cambio si `npm run build` falla."
  }
}
