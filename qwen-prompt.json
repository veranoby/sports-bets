{
  "task_id": "CODEBASE_CLEANUP_ANALYSIS_2025_11_03",
  "task_type": "ARCHITECTURAL_AUDIT",
  "complexity": "HIGH (7/10)",
  "executor": "QWEN 2.5-Coder 32B Instruct",
  "estimated_duration": "25-35 minutes",
  "priority": "P1_HIGH - Pre-deployment optimization",

  "objective": "Analyze entire codebase to categorize files into: NECESSARY, DEPRECATED (for .expired), and MERGE_CANDIDATES. Focus on import graphs, lazy loading, and component dependency chains.",

  "context": {
    "current_status": "FASE 5 complete, Events migrated, registration fixed",
    "deployment_timeline": "Very near future (MVP launch imminent)",
    "architecture": "Frontend: React+TS+Tailwind, Backend: Node+Express+Sequelize+PostgreSQL",
    "key_constraint": "ONLY REPORT findings - DO NOT modify files, DO NOT add .expired extensions"
  },

  "analysis_strategy": {
    "phase_1_import_graph": {
      "description": "Build complete dependency graph to identify orphaned files",
      "method": "grep -r 'import.*from' to map all imports, cross-reference with file existence",
      "targets": [
        "frontend/src/components/**/*.tsx - All component imports",
        "frontend/src/pages/**/*.tsx - All page imports",
        "frontend/src/hooks/**/*.ts - All hook imports",
        "frontend/src/services/**/*.ts - All service imports",
        "backend/src/routes/**/*.ts - All route registrations"
      ],
      "output": "List files WITH imports vs files WITHOUT imports (orphaned)"
    },

    "phase_2_lazy_loading": {
      "description": "Detect React.lazy and dynamic import patterns",
      "method": "grep -r 'React.lazy\\|import(' to find code-split components",
      "critical": "Lazy-loaded files may appear orphaned but are NOT - preserve them",
      "output": "List of dynamically loaded files (MUST preserve)"
    },

    "phase_3_backend_routes": {
      "description": "Verify route registration in backend/src/index.ts or app.ts",
      "method": "Read route index file, grep for 'app.use' or 'router.use', match against route files",
      "targets": [
        "backend/src/routes/*.ts - All route files",
        "backend/src/index.ts - Route registrations"
      ],
      "output": "Registered routes vs orphaned route files"
    },

    "phase_4_component_chains": {
      "description": "Map component hierarchies to understand dependencies",
      "method": "For each page, trace imported components recursively",
      "example": "Events.tsx ’ CreateFightModal ’ fightsAPI ’ backend/routes/fights.ts",
      "critical": "Components deep in chains still NECESSARY if chain is active",
      "output": "Component dependency tree with depth levels"
    },

    "phase_5_duplication_detection": {
      "description": "Identify duplicate/similar components for merge consideration",
      "method": "Compare file sizes, naming patterns, and code structure",
      "patterns_to_check": [
        "CreateX + EditX modal pairs (e.g., CreateUserModal vs EditUserModal)",
        "EntityForm variants (VenueEntityForm vs GalleraEntityForm)",
        "PaymentForm duplicates (payments/ vs subscriptions/)",
        "Modal wrappers with identical boilerplate",
        ".optimized.tsx or .backup.tsx suffixes"
      ],
      "output": "File pairs/groups with similarity scores"
    }
  },

  "categorization_criteria": {
    "NECESSARY": {
      "definition": "Files actively used in import chains or registered routes",
      "examples": [
        "AuthContext.tsx - Core authentication",
        "api.ts - Central API service",
        "All pages in active routes",
        "Components imported by active pages",
        "Registered backend routes in index.ts"
      ],
      "verification": "Has imports pointing to it OR is route-registered OR is entry point"
    },

    "DEPRECATED": {
      "definition": "Orphaned files with NO imports and NO route registration",
      "examples": [
        "backend/src/routes/ads.ts - NOT imported in index.ts",
        "backend/src/routes/enhancedEvents.ts - NOT imported",
        "frontend/src/components/user/CreateBetModal.optimized.tsx - Duplicate suffix"
      ],
      "verification": "grep shows ZERO imports + NOT in lazy loading + NOT registered",
      "action": "Candidates for .expired extension"
    },

    "MERGE_CANDIDATES": {
      "definition": "Files with 50%+ code overlap or duplicate responsibilities",
      "subcategories": {
        "HIGH_PRIORITY": "70%+ overlap, immediate merge recommended",
        "MEDIUM_PRIORITY": "50-70% overlap, merge after analysis",
        "ABSTRACTION_OPPORTUNITY": "Shared patterns across 3+ files, extract to shared component/hook"
      },
      "examples": [
        "PaymentForm.tsx (payments/) + PaymentForm.tsx (subscriptions/) - DUPLICATE",
        "UserModal.tsx + EditUserModal.tsx - UserModal already handles both create/edit",
        "VenueEntityForm + GalleraEntityForm - Both use profileInfo, can abstract"
      ],
      "verification": "Code comparison, shared prop interfaces, similar state management"
    }
  },

  "execution_steps": [
    {
      "step": "STEP_1_FRONTEND_COMPONENTS",
      "description": "Analyze all components for import usage",
      "actions": [
        "List all files: find frontend/src/components -name '*.tsx' -o -name '*.ts'",
        "For each component: grep -r 'import.*ComponentName' frontend/src/",
        "Identify orphans: components with ZERO import matches",
        "Check for lazy loading: grep -r 'React.lazy.*ComponentName' frontend/src/",
        "Build component chains: Map page ’ components ’ sub-components"
      ],
      "output": "components_analysis.json with categories: necessary, orphaned, lazy_loaded"
    },

    {
      "step": "STEP_2_FRONTEND_PAGES",
      "description": "Verify all pages are in active routes",
      "actions": [
        "List all pages: find frontend/src/pages -name '*.tsx'",
        "Read router config: frontend/src/App.tsx or routing file",
        "Match pages to route definitions",
        "Identify unrouted pages (candidates for deprecation)"
      ],
      "output": "pages_analysis.json with route mappings"
    },

    {
      "step": "STEP_3_HOOKS_SERVICES",
      "description": "Analyze hook and service usage",
      "actions": [
        "List hooks: find frontend/src/hooks -name '*.ts' -o -name '*.tsx'",
        "List services: find frontend/src/services -name '*.ts'",
        "For each: grep -r 'import.*{HookName}' frontend/src/",
        "Count import references",
        "Identify unused (0 references)"
      ],
      "output": "hooks_services_analysis.json with usage counts"
    },

    {
      "step": "STEP_4_BACKEND_ROUTES",
      "description": "Verify backend route registration",
      "checkpoint": " CHECKPOINT 1: Frontend analysis complete",
      "actions": [
        "List route files: find backend/src/routes -name '*.ts'",
        "Read backend/src/index.ts",
        "grep 'app.use\\|router.use' to find registrations",
        "Match route files to registrations",
        "Identify unregistered routes (candidates for deprecation)"
      ],
      "output": "backend_routes_analysis.json with registration status"
    },

    {
      "step": "STEP_5_DUPLICATION_ANALYSIS",
      "description": "Detect merge candidates",
      "actions": [
        "Find modal pairs: grep -l 'CreateUserModal\\|EditUserModal' frontend/src/",
        "Find entity forms: ls frontend/src/components/forms/*EntityForm.tsx",
        "Find payment forms: find frontend/src -path '*/PaymentForm.tsx'",
        "Compare file sizes: wc -l for similarity estimation",
        "Check for .optimized, .backup, .old suffixes: find -name '*.tsx.optimized'"
      ],
      "output": "merge_candidates.json with similarity scores and merge strategies"
    },

    {
      "step": "STEP_6_DEPENDENCY_CHAINS",
      "description": "Build complete dependency graph",
      "actions": [
        "For each page: Extract all imports recursively",
        "Build tree: Page ’ Component L1 ’ Component L2 ’ Services ’ Backend",
        "Mark chain depth for each file",
        "Identify isolated files (no chains leading to them)"
      ],
      "output": "dependency_graph.json with chain depths"
    },

    {
      "step": "STEP_7_CONSOLIDATE_REPORT",
      "description": "Generate final categorized report",
      "checkpoint": " CHECKPOINT 2: All analysis complete",
      "actions": [
        "Merge all analysis JSON outputs",
        "Categorize each file: NECESSARY | DEPRECATED | MERGE_CANDIDATE",
        "Add confidence scores (HIGH/MEDIUM/LOW)",
        "Generate summary statistics",
        "Update brain/backlog.json with findings"
      ],
      "output": "Final report in brain/backlog.json under 'codebase_cleanup_analysis_2025_11_03'"
    }
  ],

  "report_format": {
    "structure": "JSON in brain/backlog.json",
    "categories": {
      "necessary_files": {
        "description": "Files actively used, MUST preserve",
        "fields": ["file_path", "import_count", "used_by", "chain_depth"]
      },
      "deprecated_files": {
        "description": "Candidates for .expired extension",
        "fields": ["file_path", "reason", "last_import_reference", "confidence"],
        "confidence_levels": "HIGH (0 imports) | MEDIUM (1-2 old imports) | LOW (uncertain)"
      },
      "merge_candidates": {
        "description": "Files to consolidate",
        "subcategories": ["high_priority", "medium_priority", "abstraction_opportunity"],
        "fields": ["files", "overlap_score", "merge_strategy", "estimated_loc_saved"]
      }
    },
    "summary_stats": {
      "total_files_analyzed": "number",
      "necessary": "number",
      "deprecated": "number",
      "merge_candidates": "number",
      "estimated_cleanup": "LOC to remove + files to deprecate"
    }
  },

  "critical_validations": {
    "before_categorizing_as_deprecated": [
      " Verify ZERO imports: grep -r 'import.*FileName' returns nothing",
      " Verify NOT lazy loaded: grep -r 'React.lazy.*FileName' returns nothing",
      " Verify NOT in route registration (backend only)",
      " Check git history: File hasn't been modified in recent commits (git log --oneline -5 -- file)"
    ],
    "before_suggesting_merge": [
      " Both files >100 LOC (small files don't justify merge complexity)",
      " Shared prop interfaces or similar state management",
      " At least 50% structural similarity",
      " Both actively used (not merging deprecated files)"
    ]
  },

  "constraints": {
    "DO_NOT_MODIFY": [
      "L NO modificar archivos - SOLO reportar",
      "L NO agregar extensión .expired - Claude lo hará después",
      "L NO borrar código - SOLO análisis",
      "L NO crear nuevos archivos excepto actualizar brain/backlog.json"
    ],
    "ACCURACY_REQUIREMENTS": [
      " Confidence scores MUST be justified with grep evidence",
      " Merge candidates MUST show specific overlap examples",
      " Dependency chains MUST be complete (not partial)",
      " All categorizations MUST be verifiable"
    ]
  },

  "output_location": "brain/backlog.json under key 'codebase_cleanup_analysis_2025_11_03'",

  "success_criteria": [
    " All frontend components categorized (NECESSARY | DEPRECATED | MERGE)",
    " All backend routes verified for registration status",
    " Dependency chains mapped with depth levels",
    " Merge candidates identified with overlap scores >50%",
    " Confidence scores provided for all DEPRECATED categorizations",
    " Summary statistics calculated",
    " brain/backlog.json updated with complete findings"
  ]
}
