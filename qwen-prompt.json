{
  "task_id": "FIX_EVENTS_FASE5_MIGRATION_2025_11_02",
  "task_type": "ARCHITECTURAL_FIX",
  "complexity": "HIGH (8/10)",
  "executor": "QWEN 2.5-Coder 32B Instruct",
  "estimated_duration": "35-45 minutes",
  "priority": "P0_CRITICAL - Events system BLOCKED",

  "objective": "Fix 6 critical issues in Events system to complete FASE 5 migration. Remove all Venue/Gallera model references, migrate to User model with role filtering.",

  "context": {
    "current_status": "Events system BROKEN - Still uses eliminated Venue/Gallera models",
    "validation_report": "brain/backlog.json lines 454-485 - 6 CRITICAL issues documented",
    "reference_work": "Commit a4561a4 successfully migrated Galleras/Venues pages - use same pattern",
    "migration_pattern": "Venue model ‚Üí User model where role='venue', access via user.profileInfo.venueName"
  },

  "critical_issues_to_fix": [
    {
      "issue": "Event model associations reference eliminated Venue model",
      "file": "backend/src/models/Event.ts",
      "fix": "Change Event.belongsTo(Venue, {as:'venue'}) ‚Üí Event.belongsTo(User, {as:'venue', foreignKey:'venueId'})"
    },
    {
      "issue": "Backend event routes use Venue model",
      "file": "backend/src/routes/events.ts",
      "fix": "Remove Venue imports, use User model with {role:'venue'}, include profileInfo in queries"
    },
    {
      "issue": "Frontend uses obsolete venuesAPI",
      "file": "frontend/src/pages/admin/Events.tsx",
      "fix": "Replace venuesAPI.getAll() ‚Üí usersAPI.getAll({role:'venue'})"
    },
    {
      "issue": "API services define obsolete venuesAPI/gallerasAPI",
      "file": "frontend/src/services/api.ts",
      "fix": "Remove venuesAPI and gallerasAPI exports (already consolidated to usersAPI)"
    },
    {
      "issue": "Frontend expects event.venue.name instead of profileInfo",
      "files": ["frontend/src/pages/admin/Events.tsx", "frontend/src/pages/user/Events.tsx", "frontend/src/pages/user/LiveEvent.tsx"],
      "fix": "Change event.venue.name ‚Üí event.venue.profileInfo.venueName"
    },
    {
      "issue": "Models index has Venue associations",
      "file": "backend/src/models/index.ts",
      "fix": "Remove any Venue/Event associations, ensure User/Event associations exist"
    }
  ],

  "implementation_steps": [
    {
      "step": "STEP_1_BACKEND_EVENT_MODEL",
      "description": "Fix Event model associations",
      "priority": "CRITICAL - Must be first",
      "actions": [
        "Read backend/src/models/Event.ts",
        "Find: Event.belongsTo(Venue, ...)",
        "Replace with: Event.belongsTo(User, { as: 'venue', foreignKey: 'venueId' })",
        "Ensure: Event.belongsTo(User, { as: 'operator', foreignKey: 'operatorId' }) exists",
        "Remove: Any imports of Venue model"
      ],
      "validation": "Verify no Venue model references remain in Event.ts"
    },

    {
      "step": "STEP_2_BACKEND_MODELS_INDEX",
      "description": "Fix models/index.ts associations",
      "priority": "CRITICAL",
      "actions": [
        "Read backend/src/models/index.ts",
        "Remove: Any Venue.hasMany(Event) or similar",
        "Ensure: User.hasMany(Event, { as: 'venueEvents', foreignKey: 'venueId' }) exists",
        "Ensure: User.hasMany(Event, { as: 'operatorEvents', foreignKey: 'operatorId' }) exists",
        "Remove: Venue/Gallera model imports if present"
      ],
      "validation": "No Venue/Gallera associations remain"
    },

    {
      "step": "STEP_3_BACKEND_EVENT_ROUTES",
      "description": "Migrate backend/src/routes/events.ts to User model",
      "priority": "CRITICAL",
      "checkpoint": "‚úÖ CHECKPOINT 1: Backend models fixed, now routes",
      "actions": [
        "Read backend/src/routes/events.ts",
        "Remove: import Venue from '../models/Venue'",
        "Remove: import Gallera from '../models/Gallera'",
        "Update event queries to include User with profileInfo:",
        "  include: [{ model: User, as: 'venue', attributes: ['id', 'username', 'profileInfo'] }]",
        "Update venue filtering: where: { role: 'venue', isActive: true }",
        "Verify venueId validation checks users table: await User.findOne({ where: { id: venueId, role: 'venue' } })"
      ],
      "validation": "No Venue/Gallera imports, queries use User model"
    },

    {
      "step": "STEP_4_FRONTEND_API_SERVICES",
      "description": "Remove obsolete API exports",
      "priority": "HIGH",
      "actions": [
        "Read frontend/src/services/api.ts",
        "Remove: export const venuesAPI = {...}",
        "Remove: export const gallerasAPI = {...}",
        "Verify usersAPI exists with getAll() supporting role parameter"
      ],
      "validation": "Only usersAPI exported for user/venue/gallera management"
    },

    {
      "step": "STEP_5_FRONTEND_ADMIN_EVENTS",
      "description": "Fix admin Events.tsx to use usersAPI",
      "priority": "CRITICAL",
      "checkpoint": "‚úÖ CHECKPOINT 2: Backend complete, now frontend",
      "actions": [
        "Read frontend/src/pages/admin/Events.tsx",
        "Find: venuesAPI.getAll() or gallerasAPI references",
        "Replace: usersAPI.getAll({ role: 'venue' })",
        "Update venue dropdown: venues.map(user => ({ id: user.id, name: user.profileInfo.venueName }))",
        "Update operator dropdown: usersAPI.getAll({ role: 'operator' })",
        "Update event display: event.venue.profileInfo.venueName instead of event.venue.name"
      ],
      "validation": "No venuesAPI/gallerasAPI imports, uses usersAPI with role filtering"
    },

    {
      "step": "STEP_6_FRONTEND_PUBLIC_EVENTS",
      "description": "Fix public Events.tsx data access",
      "priority": "HIGH",
      "actions": [
        "Read frontend/src/pages/user/Events.tsx",
        "Update event display: event.venue?.profileInfo?.venueName || 'Venue TBD'",
        "Update venue location: event.venue?.profileInfo?.venueLocation",
        "Remove any venuesAPI imports if present"
      ],
      "validation": "Events display venue info from user.profileInfo"
    },

    {
      "step": "STEP_7_FRONTEND_LIVE_EVENT",
      "description": "Fix LiveEvent.tsx venue display",
      "priority": "HIGH",
      "actions": [
        "Read frontend/src/pages/user/LiveEvent.tsx",
        "Update: event.venue?.profileInfo?.venueName",
        "Update: event.venue?.profileInfo?.venueLocation",
        "Verify streaming data still loads correctly"
      ],
      "validation": "Live event shows correct venue info"
    },

    {
      "step": "STEP_8_TYPESCRIPT_VALIDATION",
      "description": "Verify TypeScript compilation",
      "priority": "CRITICAL",
      "actions": [
        "Run: cd frontend && npx tsc --noEmit",
        "Check for errors in modified files",
        "If errors: Fix type mismatches related to venue/user structure"
      ],
      "validation": "Zero TypeScript errors in Event-related files"
    },

    {
      "step": "STEP_9_UPDATE_BRAIN",
      "description": "Update brain/backlog.json with fix completion",
      "actions": [
        "Update 'recent_achievements_2025_11_02_events_validation'",
        "Change status: 'NEEDS_FIXES' ‚Üí 'FIXED'",
        "Change mvp_readiness: 'BLOCKED' ‚Üí 'FUNCTIONAL'",
        "Add fixes_applied section documenting all changes"
      ]
    }
  ],

  "files_to_modify": {
    "backend": [
      "backend/src/models/Event.ts - Event model associations",
      "backend/src/models/index.ts - Remove Venue associations",
      "backend/src/routes/events.ts - Migrate to User model queries"
    ],
    "frontend": [
      "frontend/src/services/api.ts - Remove venuesAPI/gallerasAPI",
      "frontend/src/pages/admin/Events.tsx - Use usersAPI, fix data access",
      "frontend/src/pages/user/Events.tsx - Fix venue display",
      "frontend/src/pages/user/LiveEvent.tsx - Fix venue display"
    ]
  },

  "reference_patterns": {
    "commit_a4561a4_migration": "Successful Galleras/Venues migration - follow same approach",
    "api_migration": "gallerasAPI.getAll() ‚Üí usersAPI.getAll({role:'gallera'})",
    "data_access": "gallera.owner.profileInfo ‚Üí user.profileInfo (direct access)",
    "response_format": "{ galleras: [...] } ‚Üí { users: [...] }"
  },

  "success_criteria": [
    "‚úÖ Event model associates with User (not Venue)",
    "‚úÖ Backend routes use User model with role='venue'",
    "‚úÖ Frontend uses usersAPI for venue selection",
    "‚úÖ venuesAPI/gallerasAPI removed from api.ts",
    "‚úÖ All event displays use event.venue.profileInfo.venueName",
    "‚úÖ TypeScript compilation: ZERO errors in modified files",
    "‚úÖ brain/backlog.json updated with fix completion"
  ],

  "constraints": {
    "no_file_creation": [
      "‚ùå NO crear archivos .md",
      "‚úÖ SOLO modificar archivos listados en files_to_modify",
      "‚úÖ SOLO actualizar brain/backlog.json"
    ],
    "follow_pattern": [
      "Use exact same migration pattern as commit a4561a4",
      "Venue model ‚Üí User model where role='venue'",
      "venue.name ‚Üí user.profileInfo.venueName"
    ],
    "validate_work": [
      "Run TypeScript check after each frontend file modification",
      "Verify no Venue/Gallera imports remain",
      "Test at checkpoints before continuing"
    ]
  },

  "critical_validations": {
    "after_backend": [
      "grep -r 'import.*Venue' backend/src/models/ backend/src/routes/ ‚Üí should return ZERO results",
      "grep -r 'import.*Gallera' backend/src/models/ backend/src/routes/ ‚Üí should return ZERO results"
    ],
    "after_frontend": [
      "grep -r 'venuesAPI\\|gallerasAPI' frontend/src/ ‚Üí should return ZERO results (except removal in api.ts)",
      "grep -r 'event\\.venue\\.name[^I]' frontend/src/ ‚Üí should return ZERO results (venue.name without profileInfo)",
      "npx tsc --noEmit ‚Üí should complete with ZERO errors in Event files"
    ]
  },

  "commit_message_template": "refactor: Migrate Events system to FASE 5 User model architecture\n\nBACKEND CHANGES:\n- Event model: Venue associations ‚Üí User associations\n- events.ts routes: Migrated to User model with role='venue'\n- models/index.ts: Removed Venue associations\n\nFRONTEND CHANGES:\n- api.ts: Removed obsolete venuesAPI/gallerasAPI\n- Events.tsx (admin): Uses usersAPI.getAll({role:'venue'})\n- Events.tsx (user): Fixed venue display from profileInfo\n- LiveEvent.tsx: Fixed venue data access patterns\n\nFASE 5 COMPLETION:\n- Events system now fully uses consolidated User model\n- venue.name ‚Üí user.profileInfo.venueName\n- Consistent with Galleras/Venues migration (commit a4561a4)\n\nVALIDATION:\n- ‚úÖ TypeScript: ZERO errors\n- ‚úÖ No Venue/Gallera imports remain\n- ‚úÖ Events system unblocked for MVP\n\nü§ñ Generated with [Claude Code](https://claude.com/claude-code)\n\nCo-Authored-By: Qwen-Coder <qwen-coder@alibabacloud.com>"
}
